<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µåŠ›æ³¢å½¢åˆ†æç³»ç»Ÿ - RMSæ³¢å½¢æ˜¾ç¤º</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --sidebar-width: 60px;
            --param-width: 320px;
            --transition: all 0.3s ease;
            
            --dc-color: #9b59b6;
            --single-phase-color: #3498db;
            --phase-a-color: #e74c3c;
            --phase-b-color: #f39c12;
            --phase-c-color: #3498db;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: #333;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: var(--secondary-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            position: relative;
            z-index: 100;
            transition: var(--transition);
            flex-shrink: 0;
        }
        
        .menu-toggle-container {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: auto;
            margin-bottom: 30px;
        }
        
        .menu-toggle {
            background: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .menu-toggle:hover {
            background: var(--accent-color);
        }
        
        .menu-toggle i {
            font-size: 20px;
        }
        
        .menu-options {
            position: absolute;
            left: 100%;
            top: 0;
            bottom: 0;
            width: 0;
            background: white;
            box-shadow: 3px 0 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: var(--transition);
            z-index: 99;
            opacity: 0;
            visibility: hidden;
        }
        
        .sidebar:hover .menu-options {
            width: 250px;
            opacity: 1;
            visibility: visible;
            padding: 20px 15px;
            overflow-y: auto;
        }
        
        .menu-option {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .menu-option:hover {
            background: #f1f1f1;
            padding-left: 15px;
        }
        
        .menu-option i {
            margin-right: 10px;
            color: var(--primary-color);
            width: 20px;
            text-align: center;
        }
        
        .menu-option.active {
            background: #e8f0fe;
            border-left: 3px solid var(--primary-color);
        }
        
        .param-bar {
            width: var(--param-width);
            background: white;
            padding: 20px 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            position: relative;
            z-index: 90;
            transition: all 0.3s ease;
            flex-shrink: 0;
            height: calc(100vh - 40px);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .param-bar h4 {
            position: sticky;
            top: -20px;
            background: white;
            z-index: 10;
            margin: -20px -15px 20px -15px;
            padding: 20px 15px 15px 15px;
            border-bottom: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 16px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-top: 20px;
            margin-bottom: 15px;
            font-weight: 600;
            background: white;
            position: sticky;
            top: 60px;
            z-index: 5;
        }
        
        .param-group {
            margin-bottom: 25px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 15px;
        }
        
        .param-group:last-child {
            border-bottom: none;
            margin-bottom: 15px;
        }
        
        .batch-info-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            color: white;
            border: 2px solid transparent;
            transition: var(--transition);
        }
        
        .batch-info-panel.active {
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.3);
        }
        
        .batch-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .batch-stat:last-child {
            margin-bottom: 0;
        }
        
        .batch-label {
            opacity: 0.8;
        }
        
        .batch-value {
            font-weight: bold;
            color: #00ff88;
        }
        
        .rms-display {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .rms-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .rms-value:last-child {
            margin-bottom: 0;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .nav-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .nav-breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .nav-breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1aeb5;
        }
        
        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.connected {
            background: var(--success-color);
        }
        
        .status-indicator.disconnected {
            background: var(--accent-color);
        }
        
        .status-indicator.connecting {
            background: var(--warning-color);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .client-info-bar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .client-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .client-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .client-icon.batch-sensor {
            background: var(--single-phase-color);
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
            flex: 1 1 auto;
            min-height: 450px;
            position: relative;
            width: 100%;
            min-width: 0;
            transition: all 0.3s ease;
        }
        
        .chart-container canvas {
            width: 100% !important;
            min-height: 400px;
            height: auto !important;
            max-height: 650px;
        }
        
        .chart-title {
            margin-bottom: 15px;
            font-weight: 500;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: color 0.3s ease;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .rms-info-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success-color);
            border: none;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-warning {
            background: var(--warning-color);
            border: none;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f1aeb5;
        }
        
        .success-message {
            background: #d1f7c4;
            color: #0c5460;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            background: #f8fff9;
            border: 1px solid #27ae60;
            border-radius: 15px;
            font-size: 12px;
            color: #27ae60;
            font-weight: 500;
        }
        
        .realtime-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 1s infinite;
        }
        
        .transmission-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        .transmission-status.active {
            display: block;
            animation: fadeInOut 2s;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        /* å¹³æ»‘æ»šåŠ¨æ¨¡å¼æ–°å¢æ ·å¼ */
        .smooth-scroll-controls {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            color: white;
            border: 2px solid transparent;
            transition: var(--transition);
        }
        
        .smooth-scroll-controls.active {
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.3);
        }
        
        .scroll-toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .scroll-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .scroll-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .scroll-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.3);
            transition: .4s;
            border-radius: 30px;
            border: 2px solid rgba(255,255,255,0.5);
        }
        
        .scroll-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input:checked + .scroll-slider {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        input:checked + .scroll-slider:before {
            transform: translateX(30px);
        }
        
        .scroll-params {
            display: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .scroll-params.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .app-container {
                flex-wrap: wrap;
            }
            
            .sidebar {
                width: 100%;
                height: 60px;
                flex-direction: row;
                justify-content: space-between;
                padding: 0 20px;
                position: fixed;
                top: 0;
                z-index: 1000;
            }
            
            .param-bar {
                width: 100%;
                height: auto;
                max-height: 50vh;
                position: fixed;
                top: 60px;
                z-index: 999;
                max-height: 0;
                padding: 0 15px;
                transition: max-height 0.3s ease;
            }
            
            .param-bar.active {
                max-height: 50vh;
                padding: 20px 15px;
            }
            
            .main-content {
                width: 100%;
                padding-top: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .chart-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="transmission-status" id="transmissionStatus">
        æ‰¹é‡æ•°æ®ä¼ è¾“ä¸­...
    </div>

    <div class="app-container" id="appContainer">
        <div class="sidebar">
            <div class="menu-toggle-container">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
            <div class="menu-options">
                <div class="menu-option" onclick="goToClientSelection()">
                    <i class="fas fa-arrow-left"></i> è¿”å›å®¢æˆ·ç«¯é€‰æ‹©
                </div>
                <div class="menu-option active">
                    <i class="fas fa-chart-line"></i> RMSæ³¢å½¢æ˜¾ç¤º
                </div>
                <div class="menu-option" onclick="goToDataAnalysis()">
                    <i class="fas fa-analytics"></i> æ•°æ®ç»¼åˆåˆ†æ
                </div>
                <div class="menu-option" onclick="downloadClientCSV()">
                    <i class="fas fa-download"></i> ä¸‹è½½CSVæ•°æ®
                </div>
                <div class="menu-option" onclick="toggleDebug()">
                    <i class="fas fa-bug"></i> è°ƒè¯•æ¨¡å¼
                </div>
            </div>
        </div>
        
        <div class="param-bar">
            <h4 class="mb-4" style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                <i class="fas fa-bolt me-2"></i>RMSæ³¢å½¢å‚æ•°
            </h4>
            
            <form id="analysisForm">
                <!-- å¹³æ»‘æ»šåŠ¨æ§åˆ¶é¢æ¿ -->
                <div class="param-group">
                    <div class="section-title">å¹³æ»‘æ»šåŠ¨æ§åˆ¶</div>
                    <div class="smooth-scroll-controls" id="smoothScrollControls">
                        <div class="scroll-toggle-wrapper">
                            <div>
                                <strong><i class="fas fa-water me-2"></i>å¹³æ»‘æ»šåŠ¨æ¨¡å¼</strong>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 3px;">
                                    é¿å…æ•´ä½“é‡ç»˜ï¼Œå¹³æ»‘æ›´æ–°æ³¢å½¢
                                </div>
                            </div>
                            <label class="scroll-toggle">
                                <input type="checkbox" id="smoothScrollMode" checked>
                                <span class="scroll-slider"></span>
                            </label>
                        </div>
                        
                        <div class="scroll-params active" id="scrollParams">
                            <div class="speed-control">
                                <label class="form-label" style="color: white; font-size: 13px; font-weight: 500;">
                                    æ»šåŠ¨çª—å£å¤§å°: <span id="scrollWindowValue">500</span> ç‚¹
                                </label>
                                <input type="range" class="form-range" id="scrollWindowSlider" 
                                       min="200" max="1000" value="500" step="50">
                                <small class="form-text" style="color: rgba(255,255,255,0.7); font-size: 11px;">
                                    æ§åˆ¶æ»šåŠ¨çª—å£ä¸­æ˜¾ç¤ºçš„æ•°æ®ç‚¹æ•°é‡
                                </small>
                            </div>
                            
                            <div class="speed-control">
                                <label class="form-label" style="color: white; font-size: 13px; font-weight: 500;">
                                    æ›´æ–°é—´éš”: <span id="updateIntervalValue">100</span> ms
                                </label>
                                <input type="range" class="form-range" id="updateIntervalSlider"
                                       min="50" max="500" value="100" step="25">
                                <small class="form-text" style="color: rgba(255,255,255,0.7); font-size: 11px;">
                                    æ§åˆ¶æ³¢å½¢æ›´æ–°çš„é¢‘ç‡
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ‰¹é‡æ•°æ®ä¿¡æ¯é¢æ¿ -->
                <div class="param-group">
                    <div class="section-title">æ‰¹é‡æ•°æ®çŠ¶æ€</div>
                    <div class="batch-info-panel" id="batchInfoPanel">
                        <div class="batch-stat">
                            <span class="batch-label">æ•°æ®æ¨¡å¼</span>
                            <span class="batch-value">400ç‚¹æ‰¹é‡</span>
                        </div>
                        <div class="batch-stat">
                            <span class="batch-label">æ‰¹æ¬¡è®¡æ•°</span>
                            <span class="batch-value" id="batchCount">0</span>
                        </div>
                        <div class="batch-stat">
                            <span class="batch-label">æœ€åæ›´æ–°</span>
                            <span class="batch-value" id="lastUpdate">ç­‰å¾…æ•°æ®</span>
                        </div>
                        
                        <div class="rms-display" id="rmsDisplay">
                            <div class="rms-value">
                                <span>ç”µå‹RMS:</span>
                                <span id="voltageRMS">0.000V</span>
                            </div>
                            <div class="rms-value">
                                <span>ç”µæµRMS:</span>
                                <span id="currentRMS">0.000A</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="param-group">
                    <div class="section-title">åˆ†æå‚æ•°</div>
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©åˆ†æå‚æ•°</label>
                        <select class="form-select" name="selected_column" id="columnSelect">
                            <option value="voltage">ç”µå‹</option>
                            <option value="current">ç”µæµ</option>
                        </select>
                        <small class="form-text text-muted">é€‰æ‹©è¦é‡ç‚¹åˆ†æçš„å‚æ•°</small>
                    </div>
                </div>
                
                <div class="param-group">
                    <div class="section-title">æ˜¾ç¤ºå‚æ•°</div>
                    <div class="mb-3">
                        <label class="form-label">æ˜¾ç¤ºæ•°æ®ç‚¹æ•°: <span id="maxPointsValue">1000</span></label>
                        <input type="range" class="form-range" name="max_points" min="400" max="5000" value="1000" id="maxPointsSlider">
                        <small class="form-text text-muted">æ§åˆ¶RMSæ³¢å½¢æ˜¾ç¤ºçš„ç²¾åº¦</small>
                    </div>
                </div>
                
                <div class="param-group">
                    <div class="section-title">å¯è§†åŒ–è®¾ç½®</div>
                    <div class="mb-3">
                        <label class="form-label">ç”µå‹é¢œè‰²</label>
                        <input type="color" class="form-control form-control-color" name="voltage_color" id="voltageColor" value="#3498db">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ç”µæµé¢œè‰²</label>
                        <input type="color" class="form-control form-control-color" name="current_color" id="currentColor" value="#e74c3c">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">çº¿æ¡ç²—ç»†: <span id="lineWidthValue">2</span>px</label>
                        <input type="range" class="form-range" name="line_width" min="1" max="5" value="2" id="lineWidthSlider">
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="animationSwitch" name="enable_animation">
                        <label class="form-check-label" for="animationSwitch">å¯ç”¨åŠ¨ç”»æ•ˆæœ</label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="pointsSwitch" name="show_points">
                        <label class="form-check-label" for="pointsSwitch">æ˜¾ç¤ºæ•°æ®ç‚¹</label>
                    </div>
                </div>
                
                <button type="button" class="btn btn-success" id="startMonitorBtn">
                    <i class="fas fa-eye me-2"></i>å¼€å§‹RMSç›‘æ§
                </button>
                
                <button type="button" class="btn btn-warning mt-2" id="stopMonitorBtn" style="display: none;">
                    <i class="fas fa-stop me-2"></i>åœæ­¢ç›‘æ§
                </button>
                
                <button type="button" class="btn btn-primary mt-2" id="generateWaveformBtn">
                    <i class="fas fa-sine-wave me-2"></i>ç”ŸæˆRMSæ³¢å½¢
                </button>
            </form>
            
            <!-- è°ƒè¯•é¢æ¿ -->
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <div class="debug-title">ğŸ” è°ƒè¯•ä¿¡æ¯</div>
                <div id="debugContent">è°ƒè¯•é¢æ¿å·²å¯ç”¨ï¼Œç­‰å¾…æ•°æ®...</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="top-bar">
                <div>
                    <div class="nav-breadcrumb">
                        <a href="/client-selection">å®¢æˆ·ç«¯é€‰æ‹©</a>
                        <i class="fas fa-chevron-right"></i>
                        <span>RMSæ³¢å½¢æ˜¾ç¤º</span>
                    </div>
                    <h2 class="mb-0 mt-2">
                        <i class="fas fa-chart-line me-2" style="color: var(--primary-color);"></i>
                        ç”µåŠ›RMSæ³¢å½¢æ˜¾ç¤º - å¹³æ»‘æ»šåŠ¨
                    </h2>
                    <p class="text-muted mb-0">400ç‚¹æ‰¹é‡æ•°æ® Â· RMSè®¡ç®— Â· å¹³æ»‘æ»šåŠ¨æ›´æ–°</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="connection-status connecting" id="connectionStatus">
                        <div class="status-indicator connecting"></div>
                        <span>è¿æ¥ä¸­...</span>
                    </div>
                    <div class="realtime-indicator" id="realtimeIndicator" style="display: none;">
                        <div class="realtime-dot"></div>
                        <span>RMSç›‘æ§</span>
                    </div>
                </div>
            </div>
            
            <div id="messageArea"></div>
            
            <!-- å®¢æˆ·ç«¯ä¿¡æ¯æ  -->
            <div class="client-info-bar" id="clientInfoBar" style="display: none;">
                <div class="client-details">
                    <div class="client-icon batch-sensor" id="clientIcon">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div>
                        <h6 class="mb-0" id="clientName">æœªé€‰æ‹©å®¢æˆ·ç«¯</h6>
                        <small class="text-muted" id="clientStatus">è¯·ä»ä¾§è¾¹æ å¼€å§‹ç›‘æ§</small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="goToClientSelection()">
                        <i class="fas fa-exchange-alt me-1"></i>åˆ‡æ¢å®¢æˆ·ç«¯
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="goToDataAnalysis()">
                        <i class="fas fa-analytics me-1"></i>æ•°æ®åˆ†æ
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="downloadClientCSV()">
                        <i class="fas fa-download me-1"></i>ä¸‹è½½CSV
                    </button>
                </div>
            </div>
            
            <div class="chart-container" id="chartContainer">
                <div class="chart-title">
                    <span id="chartTitle">
                        <i class="fas fa-chart-line me-2"></i>RMSæ­£å¼¦æ³¢å½¢ - ç­‰å¾…æ•°æ®æº
                    </span>
                    <div class="chart-controls">
                        <div class="rms-info-badge" id="rmsInfoBadge" style="display: none;">
                            <i class="fas fa-calculator me-1"></i>
                            <span id="rmsInfoText">RMS: V=0.000V, I=0.000A</span>
                        </div>
                        <span class="text-muted" id="updateTime">ç­‰å¾…æ•°æ®æº...</span>
                    </div>
                </div>
                <canvas id="waveChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”¥ æ”¹è¿›çš„RMSæ³¢å½¢æ˜¾ç¤ºç³»ç»Ÿ - æ”¯æŒå¹³æ»‘æ»šåŠ¨æ›´æ–°
        
        // å…¨å±€å˜é‡
        let waveChart = null;
        let websocket = null;
        let selectedClientId = null;
        let isMonitoring = false;
        let webClientId = 'web_' + Math.random().toString(36).substr(2, 9);
        let realtimeUpdateInterval = null;
        let isConnected = false;
        let debugMode = false;
        
        // å¹³æ»‘æ»šåŠ¨ç›¸å…³å˜é‡
        let smoothScrollMode = true;
        let scrollWindowSize = 500;
        let updateInterval = 100;
        let scrollUpdateTimer = null;
        
        // å®¢æˆ·ç«¯æ•°æ®ç¼“å­˜
        let clientDataCache = {};
        let lastRMSData = {};
        
        // æ³¢å½¢æ•°æ®ç¼“å†²åŒº - ç”¨äºå¹³æ»‘æ»šåŠ¨
        let waveformBuffer = {
            voltage: [],
            current: [],
            timeAxis: []
        };
        
        // æœ€æ–°çš„RMSå€¼ - ç”¨äºç”Ÿæˆæ³¢å½¢
        let currentRMSValues = {
            voltage_rms: 0.01,
            current_rms: 10.0
        };
        
        // æ³¢å½¢ç”Ÿæˆå‚æ•°
        let timeOffset = 0;
        let frequency = 50; // Hz
        let samplingRate = 1000; // é‡‡æ ·ç‡
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginAndClientSelection();
            initChart();
            setupEventListeners();
            connectWebSocket();
            setupSliders();
            initSmoothScrollMode();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œå®¢æˆ·ç«¯é€‰æ‹©
        function checkLoginAndClientSelection() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const savedLogin = localStorage.getItem('userLogin') || sessionStorage.getItem('userLogin');
            if (!savedLogin) {
                window.location.href = '/login';
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å®¢æˆ·ç«¯
            const selectedClient = sessionStorage.getItem('selectedClientId');
            if (!selectedClient) {
                showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¢æˆ·ç«¯');
                setTimeout(() => {
                    window.location.href = '/client-selection';
                }, 2000);
                return;
            }
            
            selectedClientId = selectedClient;
            updateClientInfo(selectedClient);
            updateDebugInfo(`å·²é€‰æ‹©å®¢æˆ·ç«¯: ${selectedClient}`);
            
            console.log('âœ… Batch Client selected:', selectedClientId);
        }

        // è°ƒè¯•åŠŸèƒ½
        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugMode ? 'block' : 'none';
            
            if (debugMode) {
                updateDebugInfo('è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
            }
        }

        function updateDebugInfo(message) {
            if (!debugMode) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const debugContent = document.getElementById('debugContent');
            
            if (debugContent) {
                debugContent.innerHTML += `<br>[${timestamp}] ${message}`;
                // ä¿æŒæœ€æ–°çš„50è¡Œ
                const lines = debugContent.innerHTML.split('<br>');
                if (lines.length > 50) {
                    debugContent.innerHTML = lines.slice(-50).join('<br>');
                }
                // æ»šåŠ¨åˆ°åº•éƒ¨
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.log(`[DEBUG] ${message}`);
        }

        // æ›´æ–°å®¢æˆ·ç«¯ä¿¡æ¯æ˜¾ç¤º
        function updateClientInfo(clientId) {
            const clientInfoBar = document.getElementById('clientInfoBar');
            const clientName = document.getElementById('clientName');
            const clientStatus = document.getElementById('clientStatus');
            
            clientInfoBar.style.display = 'flex';
            clientName.textContent = clientId;
            clientStatus.textContent = 'å‡†å¤‡è¿æ¥æ‰¹é‡æ•°æ®æº...';
            
            updateDebugInfo(`æ›´æ–°å®¢æˆ·ç«¯ä¿¡æ¯: ${clientId}`);
        }

        // åˆå§‹åŒ–å¹³æ»‘æ»šåŠ¨æ¨¡å¼
        function initSmoothScrollMode() {
            const smoothScrollControls = document.getElementById('smoothScrollControls');
            const scrollParams = document.getElementById('scrollParams');
            
            if (smoothScrollMode) {
                smoothScrollControls.classList.add('active');
                scrollParams.classList.add('active');
                startSmoothScrollUpdate();
            }
            
            updateDebugInfo('å¹³æ»‘æ»šåŠ¨æ¨¡å¼å·²åˆå§‹åŒ–');
        }

        // æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const alertClass = type === 'success' ? 'success-message' : 
                              type === 'error' ? 'error-message' : 'warning-message';
            
            messageArea.innerHTML = `<div class="${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            showMessage(message, 'success');
            updateDebugInfo(`SUCCESS: ${message}`);
        }

        function showError(message) {
            showMessage(message, 'error');
            updateDebugInfo(`ERROR: ${message}`);
        }

        function showWarning(message) {
            showMessage(message, 'warning');
            updateDebugInfo(`WARNING: ${message}`);
        }

        // æ˜¾ç¤ºä¼ è¾“çŠ¶æ€
        function showTransmissionStatus() {
            const transmissionStatus = document.getElementById('transmissionStatus');
            transmissionStatus.classList.add('active');
            setTimeout(() => {
                transmissionStatus.classList.remove('active');
            }, 2000);
        }

        // å¯¼èˆªå‡½æ•°
        function goToClientSelection() {
            if (isMonitoring) {
                stopMonitoring();
            }
            if (websocket) {
                websocket.close();
            }
            window.location.href = '/client-selection';
        }

        function goToDataAnalysis() {
            if (selectedClientId) {
                sessionStorage.setItem('selectedClientId', selectedClientId);
                sessionStorage.setItem('analysisMode', 'analysis');
            }
            window.location.href = '/data-analysis';
        }

        function downloadClientCSV() {
            if (selectedClientId) {
                const downloadUrl = `/api/download_csv/${selectedClientId}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `batch_data_${selectedClientId}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess('æ­£åœ¨ä¸‹è½½CSVæ•°æ®æ–‡ä»¶...');
                updateDebugInfo(`ä¸‹è½½CSVæ–‡ä»¶: ${downloadUrl}`);
            } else {
                showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¢æˆ·ç«¯');
            }
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('waveChart').getContext('2d');
            waveChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: [],
                    datasets: [] 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // å…³é—­åŠ¨ç”»æé«˜æ€§èƒ½
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#333',
                                usePointStyle: true,
                                pointStyle: 'line'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return `é‡‡æ ·ç‚¹: ${context[0].label}`;
                                },
                                label: function(context) {
                                    const unit = getUnitForDataset(context.dataset.label);
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(3)}${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            display: true,
                            title: { display: true, text: 'æ—¶é—´åºåˆ—', color: '#333' },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { color: '#333' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'å¹…å€¼', color: '#333' },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { color: '#333' }
                        }
                    },
                    elements: {
                        point: { radius: 0, hoverRadius: 5 },
                        line: { borderWidth: 2, tension: 0.1 }
                    }
                }
            });
            
            updateDebugInfo('å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
        }

        // è·å–æ•°æ®é›†å¯¹åº”çš„å•ä½
        function getUnitForDataset(label) {
            if (label && (label.includes('ç”µå‹') || label.includes('voltage'))) return 'V';
            if (label && (label.includes('ç”µæµ') || label.includes('current'))) return 'A';
            return '';
        }

        // è®¾ç½®æ»‘å—äº‹ä»¶ç›‘å¬
        function setupSliders() {
            const maxPointsSlider = document.getElementById('maxPointsSlider');
            const maxPointsValue = document.getElementById('maxPointsValue');
            const lineWidthSlider = document.getElementById('lineWidthSlider');
            const lineWidthValue = document.getElementById('lineWidthValue');
            
            // å¹³æ»‘æ»šåŠ¨æ§åˆ¶
            const scrollWindowSlider = document.getElementById('scrollWindowSlider');
            const scrollWindowValue = document.getElementById('scrollWindowValue');
            const updateIntervalSlider = document.getElementById('updateIntervalSlider');
            const updateIntervalValue = document.getElementById('updateIntervalValue');
            
            maxPointsSlider.addEventListener('input', function() {
                maxPointsValue.textContent = this.value;
            });
            
            lineWidthSlider.addEventListener('input', function() {
                lineWidthValue.textContent = this.value;
                updateChartLineWidth(parseInt(this.value));
            });
            
            scrollWindowSlider.addEventListener('input', function() {
                scrollWindowSize = parseInt(this.value);
                scrollWindowValue.textContent = scrollWindowSize;
                resizeWaveformBuffer();
                updateDebugInfo(`æ»šåŠ¨çª—å£å¤§å°è°ƒæ•´ä¸º: ${scrollWindowSize}`);
            });
            
            updateIntervalSlider.addEventListener('input', function() {
                updateInterval = parseInt(this.value);
                updateIntervalValue.textContent = updateInterval;
                if (smoothScrollMode && isMonitoring) {
                    restartSmoothScrollUpdate();
                }
                updateDebugInfo(`æ›´æ–°é—´éš”è°ƒæ•´ä¸º: ${updateInterval}ms`);
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            document.getElementById('startMonitorBtn').addEventListener('click', startMonitoring);
            document.getElementById('stopMonitorBtn').addEventListener('click', stopMonitoring);
            document.getElementById('generateWaveformBtn').addEventListener('click', generateRMSWaveform);
            
            // å¹³æ»‘æ»šåŠ¨æ¨¡å¼å¼€å…³
            document.getElementById('smoothScrollMode').addEventListener('change', function() {
                smoothScrollMode = this.checked;
                const smoothScrollControls = document.getElementById('smoothScrollControls');
                const scrollParams = document.getElementById('scrollParams');
                
                if (smoothScrollMode) {
                    smoothScrollControls.classList.add('active');
                    scrollParams.classList.add('active');
                    startSmoothScrollUpdate();
                    showSuccess('å¹³æ»‘æ»šåŠ¨æ¨¡å¼å·²å¯ç”¨');
                    updateDebugInfo('å¹³æ»‘æ»šåŠ¨æ¨¡å¼å·²å¯ç”¨');
                } else {
                    smoothScrollControls.classList.remove('active');
                    scrollParams.classList.remove('active');
                    stopSmoothScrollUpdate();
                    showWarning('å¹³æ»‘æ»šåŠ¨æ¨¡å¼å·²ç¦ç”¨');
                    updateDebugInfo('å¹³æ»‘æ»šåŠ¨æ¨¡å¼å·²ç¦ç”¨');
                }
            });
            
            // å‚æ•°å˜åŒ–æ—¶é‡æ–°ç”Ÿæˆæ³¢å½¢
            document.getElementById('columnSelect').addEventListener('change', function() {
                if (lastRMSData.voltage_rms !== undefined) {
                    if (smoothScrollMode) {
                        // å¹³æ»‘æ¨¡å¼ä¸‹ä¸é‡æ–°ç”Ÿæˆï¼Œç»§ç»­ä½¿ç”¨å½“å‰ç¼“å†²åŒº
                        updateDebugInfo('å‚æ•°å˜åŒ–ï¼Œå¹³æ»‘æ¨¡å¼ç»§ç»­ä½¿ç”¨å½“å‰ç¼“å†²åŒº');
                    } else {
                        generateRMSWaveform();
                    }
                }
            });
            
            updateDebugInfo('äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }

        // WebSocketè¿æ¥åˆå§‹åŒ–
        function connectWebSocket() {
            if (websocket) {
                websocket.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${webClientId}`;
            
            updateDebugInfo(`æ­£åœ¨è¿æ¥WebSocket: ${wsUrl}`);
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('âœ… WebSocket connected');
                    isConnected = true;
                    updateConnectionStatus('connected', 'å·²è¿æ¥');
                    updateDebugInfo('WebSocketè¿æ¥æˆåŠŸ');
                    
                    // è·å–å®¢æˆ·ç«¯æœ€æ–°æ•°æ®
                    fetchClientStatus();
                };
                
                websocket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    updateDebugInfo(`æ”¶åˆ°WebSocketæ¶ˆæ¯: ${message.type}`);
                    handleWebSocketMessage(message);
                };
                
                websocket.onclose = function(event) {
                    console.log('âŒ WebSocket disconnected');
                    isConnected = false;
                    updateConnectionStatus('disconnected', 'è¿æ¥æ–­å¼€');
                    updateDebugInfo(`WebSocketæ–­å¼€: code=${event.code}`);
                    setTimeout(connectWebSocket, 3000);
                };
                
                websocket.onerror = function(error) {
                    console.error('âŒ WebSocket error:', error);
                    isConnected = false;
                    updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
                    updateDebugInfo('WebSocketè¿æ¥é”™è¯¯');
                };
                
            } catch (error) {
                console.error('âŒ WebSocket connection failed:', error);
                isConnected = false;
                updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
                updateDebugInfo(`WebSocketè¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // è·å–å®¢æˆ·ç«¯çŠ¶æ€
        async function fetchClientStatus() {
            try {
                updateDebugInfo(`è·å–å®¢æˆ·ç«¯çŠ¶æ€: ${selectedClientId}`);
                
                const response = await fetch(`/api/batch_status/${selectedClientId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateDebugInfo(`å®¢æˆ·ç«¯çŠ¶æ€è·å–æˆåŠŸ: ${JSON.stringify(data.rms_values)}`);
                    
                    // æ›´æ–°RMSå€¼æ˜¾ç¤º
                    if (data.rms_values) {
                        lastRMSData = data.rms_values;
                        currentRMSValues = data.rms_values;
                        updateBatchDataDisplay({
                            rms_calculation: data.rms_values,
                            data_points: { total: data.batch_info.total_batches_received || 0 }
                        });
                        
                        // æ ¹æ®æ¨¡å¼å†³å®šå¦‚ä½•æ›´æ–°æ³¢å½¢
                        if (smoothScrollMode) {
                            // å¹³æ»‘æ¨¡å¼ï¼šåªæ›´æ–°RMSå€¼ï¼Œä¸é‡æ–°ç”Ÿæˆæ•´ä¸ªæ³¢å½¢
                            updateDebugInfo('å¹³æ»‘æ¨¡å¼ï¼šæ›´æ–°RMSå€¼ï¼Œç»§ç»­æ»šåŠ¨');
                        } else {
                            // ä¼ ç»Ÿæ¨¡å¼ï¼šé‡æ–°ç”Ÿæˆæ³¢å½¢
                            setTimeout(() => {
                                generateRMSWaveform();
                            }, 500);
                        }
                    }
                } else {
                    updateDebugInfo(`å®¢æˆ·ç«¯çŠ¶æ€è·å–å¤±è´¥: ${data.message}`);
                }
            } catch (error) {
                updateDebugInfo(`è·å–å®¢æˆ·ç«¯çŠ¶æ€é”™è¯¯: ${error.message}`);
            }
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'monitoring_started':
                    updateDebugInfo(`ç›‘æ§å·²å¯åŠ¨: ${message.data_source_client}`);
                    showSuccess(`å¼€å§‹ç›‘æ§æ‰¹é‡æ•°æ®å®¢æˆ·ç«¯: ${message.data_source_client}`);
                    updateMonitoringStatus(true);
                    break;
                    
                case 'monitoring_stopped':
                    updateDebugInfo('ç›‘æ§å·²åœæ­¢');
                    showSuccess('å·²åœæ­¢æ‰¹é‡æ•°æ®ç›‘æ§');
                    updateMonitoringStatus(false);
                    break;
                    
                case 'batch_data_update':
                    if (message.client_id === selectedClientId && isMonitoring) {
                        updateDebugInfo(`æ”¶åˆ°æ‰¹é‡æ•°æ®æ›´æ–°: ${message.data.data_points.total}ç‚¹`);
                        showTransmissionStatus();
                        handleBatchDataUpdate(message.data);
                    }
                    break;
                    
                case 'pong':
                    updateDebugInfo('æ”¶åˆ°å¿ƒè·³å“åº”');
                    break;
                    
                case 'error':
                    updateDebugInfo(`æœåŠ¡å™¨é”™è¯¯: ${message.message}`);
                    showError(message.message || 'å‘ç”ŸæœªçŸ¥é”™è¯¯');
                    break;
                    
                default:
                    updateDebugInfo(`æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${message.type}`);
            }
        }

        // å¤„ç†æ‰¹é‡æ•°æ®æ›´æ–°
        function handleBatchDataUpdate(data) {
            try {
                updateDebugInfo('å¤„ç†æ‰¹é‡æ•°æ®æ›´æ–°');
                
                // æ›´æ–°å®¢æˆ·ç«¯ç¼“å­˜
                clientDataCache[selectedClientId] = data;
                
                // æ›´æ–°æ‰¹é‡æ•°æ®æ˜¾ç¤º
                updateBatchDataDisplay(data);
                
                // æ›´æ–°å®¢æˆ·ç«¯çŠ¶æ€
                const clientStatus = document.getElementById('clientStatus');
                if (clientStatus) {
                    clientStatus.textContent = `æ­£åœ¨æ¥æ”¶æ‰¹é‡æ•°æ®... (${data.data_points.total}ç‚¹)`;
                }
                
                // æ›´æ–°å›¾è¡¨æ ‡é¢˜
                const chartTitle = document.getElementById('chartTitle');
                if (chartTitle) {
                    chartTitle.innerHTML = `
                        <i class="fas fa-chart-line me-2"></i>
                        RMSæ­£å¼¦æ³¢å½¢ - å®¢æˆ·ç«¯: ${selectedClientId} (æ‰¹é‡æ¨¡å¼)
                    `;
                }
                
                // ğŸ”¥ å…³é”®æ”¹è¿›ï¼šæ ¹æ®æ¨¡å¼æ›´æ–°æ³¢å½¢
                if (data.rms_calculation) {
                    lastRMSData = data.rms_calculation;
                    currentRMSValues = data.rms_calculation;
                    
                    if (smoothScrollMode) {
                        // å¹³æ»‘æ¨¡å¼ï¼šåªæ›´æ–°RMSå€¼ï¼Œä¸é‡æ–°ç”Ÿæˆæ•´ä¸ªæ³¢å½¢
                        updateDebugInfo(`å¹³æ»‘æ¨¡å¼ï¼šæ¥æ”¶åˆ°æ–°RMSå€¼ V=${currentRMSValues.voltage_rms}V, I=${currentRMSValues.current_rms}A`);
                    } else {
                        // ä¼ ç»Ÿæ¨¡å¼ï¼šé‡æ–°ç”Ÿæˆæ³¢å½¢
                        setTimeout(() => {
                            generateRMSWaveform();
                        }, 200);
                    }
                }
                
            } catch (error) {
                updateDebugInfo(`æ‰¹é‡æ•°æ®æ›´æ–°å¤„ç†é”™è¯¯: ${error.message}`);
            }
        }

        // ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½ï¼šå¯åŠ¨å¹³æ»‘æ»šåŠ¨æ›´æ–°
        function startSmoothScrollUpdate() {
            if (scrollUpdateTimer) {
                clearInterval(scrollUpdateTimer);
            }
            
            // åˆå§‹åŒ–æ³¢å½¢ç¼“å†²åŒº
            initializeWaveformBuffer();
            
            scrollUpdateTimer = setInterval(() => {
                if (smoothScrollMode && isMonitoring) {
                    generateSmoothScrollData();
                    updateSmoothScrollChart();
                }
            }, updateInterval);
            
            updateDebugInfo(`å¹³æ»‘æ»šåŠ¨æ›´æ–°å·²å¯åŠ¨ï¼Œé—´éš”: ${updateInterval}ms`);
        }

        // åœæ­¢å¹³æ»‘æ»šåŠ¨æ›´æ–°
        function stopSmoothScrollUpdate() {
            if (scrollUpdateTimer) {
                clearInterval(scrollUpdateTimer);
                scrollUpdateTimer = null;
            }
            updateDebugInfo('å¹³æ»‘æ»šåŠ¨æ›´æ–°å·²åœæ­¢');
        }

        // é‡å¯å¹³æ»‘æ»šåŠ¨æ›´æ–°
        function restartSmoothScrollUpdate() {
            stopSmoothScrollUpdate();
            if (smoothScrollMode) {
                startSmoothScrollUpdate();
            }
        }

        // åˆå§‹åŒ–æ³¢å½¢ç¼“å†²åŒº
        function initializeWaveformBuffer() {
            waveformBuffer.voltage = new Array(scrollWindowSize).fill(0);
            waveformBuffer.current = new Array(scrollWindowSize).fill(0);
            waveformBuffer.timeAxis = new Array(scrollWindowSize).fill(0).map((_, i) => i);
            timeOffset = 0;
            
            updateDebugInfo(`æ³¢å½¢ç¼“å†²åŒºå·²åˆå§‹åŒ–ï¼Œå¤§å°: ${scrollWindowSize}`);
        }

        // è°ƒæ•´æ³¢å½¢ç¼“å†²åŒºå¤§å°
        function resizeWaveformBuffer() {
            const oldSize = waveformBuffer.voltage.length;
            
            if (scrollWindowSize > oldSize) {
                // å¢åŠ ç¼“å†²åŒº
                const diff = scrollWindowSize - oldSize;
                for (let i = 0; i < diff; i++) {
                    waveformBuffer.voltage.unshift(0);
                    waveformBuffer.current.unshift(0);
                    waveformBuffer.timeAxis.unshift(waveformBuffer.timeAxis[0] - 1);
                }
            } else if (scrollWindowSize < oldSize) {
                // å‡å°‘ç¼“å†²åŒº
                const diff = oldSize - scrollWindowSize;
                waveformBuffer.voltage.splice(0, diff);
                waveformBuffer.current.splice(0, diff);
                waveformBuffer.timeAxis.splice(0, diff);
            }
            
            // é‡æ–°ç¼–å·æ—¶é—´è½´
            waveformBuffer.timeAxis = waveformBuffer.timeAxis.map((_, i) => i);
            
            updateDebugInfo(`æ³¢å½¢ç¼“å†²åŒºå·²è°ƒæ•´ï¼Œä» ${oldSize} åˆ° ${scrollWindowSize}`);
        }

        // ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆå¹³æ»‘æ»šåŠ¨æ•°æ®
        function generateSmoothScrollData() {
            // ä½¿ç”¨æ¥æ”¶åˆ°çš„çœŸå®RMSå€¼ç”Ÿæˆæ³¢å½¢
            const vRms = currentRMSValues.voltage_rms || 0.01;
            const iRms = currentRMSValues.current_rms || 10.0;
            
            // æ—¶é—´å¢é‡
            const dt = 1000 / samplingRate; // ms
            timeOffset += dt;
            
            // è®¡ç®—ç›¸ä½
            const phase = (2 * Math.PI * frequency * timeOffset) / 1000;
            
            // ğŸ”¥ ä½¿ç”¨çœŸå®RMSå€¼ç”Ÿæˆæ­£å¼¦æ³¢
            const voltageAmplitude = vRms * Math.sqrt(2);
            const currentAmplitude = iRms * Math.sqrt(2);
            
            // ç”Ÿæˆç”µå‹æ³¢å½¢ï¼ˆæ­£å¼¦æ³¢ + å°‘é‡è°æ³¢å’Œå™ªå£°ï¼‰
            const voltageBase = voltageAmplitude * Math.sin(phase);
            const voltageHarmonic = voltageBase * 0.05 * Math.sin(3 * phase);
            const voltageNoise = (Math.random() - 0.5) * vRms * 0.02;
            const voltageValue = voltageBase + voltageHarmonic + voltageNoise;
            
            // ç”Ÿæˆç”µæµæ³¢å½¢ï¼ˆæ»åç”µå‹30åº¦ï¼‰
            const currentPhase = phase - (Math.PI / 6); // 30åº¦ç›¸ä½å·®
            const currentBase = currentAmplitude * Math.sin(currentPhase);
            const currentHarmonic = currentBase * 0.03 * Math.sin(5 * phase);
            const currentNoise = (Math.random() - 0.5) * iRms * 0.02;
            const currentValue = currentBase + currentHarmonic + currentNoise;
            
            // ğŸ”¥ æ»šåŠ¨æ›´æ–°ç¼“å†²åŒºï¼ˆä»å³åˆ°å·¦æ»šåŠ¨ï¼‰
            waveformBuffer.voltage.shift();  // ç§»é™¤æœ€å·¦è¾¹çš„æ—§æ•°æ®
            waveformBuffer.current.shift();
            waveformBuffer.timeAxis.shift();
            
            waveformBuffer.voltage.push(voltageValue);  // åœ¨å³è¾¹æ·»åŠ æ–°æ•°æ®
            waveformBuffer.current.push(currentValue);
            waveformBuffer.timeAxis.push(waveformBuffer.timeAxis[waveformBuffer.timeAxis.length - 1] + 1);
        }

        // ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½ï¼šæ›´æ–°å¹³æ»‘æ»šåŠ¨å›¾è¡¨
        function updateSmoothScrollChart() {
            if (!waveChart) return;
            
            const selectedColumn = document.getElementById('columnSelect').value;
            const datasets = [];
            
            // æ ¹æ®é€‰æ‹©çš„å‚æ•°æ˜¾ç¤ºå¯¹åº”æ³¢å½¢
            if (selectedColumn === 'voltage') {
                datasets.push({
                    label: 'ç”µå‹æ³¢å½¢ (RMS)',
                    data: waveformBuffer.voltage.map((y, i) => ({ x: i, y: y })),
                    borderColor: document.getElementById('voltageColor').value,
                    backgroundColor: 'transparent',
                    borderWidth: parseInt(document.getElementById('lineWidthSlider').value),
                    fill: false,
                    tension: 0.1,
                    pointRadius: document.getElementById('pointsSwitch').checked ? 1 : 0
                });
            } else {
                datasets.push({
                    label: 'ç”µæµæ³¢å½¢ (RMS)',
                    data: waveformBuffer.current.map((y, i) => ({ x: i, y: y })),
                    borderColor: document.getElementById('currentColor').value,
                    backgroundColor: 'transparent',
                    borderWidth: parseInt(document.getElementById('lineWidthSlider').value),
                    fill: false,
                    tension: 0.1,
                    pointRadius: document.getElementById('pointsSwitch').checked ? 1 : 0
                });
            }
            
            // æ›´æ–°å›¾è¡¨æ•°æ®ï¼ˆæ— åŠ¨ç”»ï¼Œé¿å…é—ªçƒï¼‰
            waveChart.data.labels = waveformBuffer.timeAxis;
            waveChart.data.datasets = datasets;
            waveChart.update('none');
        }

        // æ›´æ–°æ‰¹é‡æ•°æ®æ˜¾ç¤º
        function updateBatchDataDisplay(data) {
            const batchInfoPanel = document.getElementById('batchInfoPanel');
            const batchCount = document.getElementById('batchCount');
            const lastUpdate = document.getElementById('lastUpdate');
            const voltageRMS = document.getElementById('voltageRMS');
            const currentRMS = document.getElementById('currentRMS');
            const rmsInfoBadge = document.getElementById('rmsInfoBadge');
            const rmsInfoText = document.getElementById('rmsInfoText');
            const updateTime = document.getElementById('updateTime');
            
            // æ›´æ–°æ‰¹é‡æ•°æ®ä¿¡æ¯
            if (data.data_points) {
                batchCount.textContent = `${data.data_points.total}ç‚¹`;
            }
            
            const now = new Date();
            lastUpdate.textContent = now.toLocaleTimeString();
            updateTime.textContent = `æœ€åæ›´æ–°: ${now.toLocaleTimeString()}`;
            
            // æ›´æ–°RMSå€¼
            if (data.rms_calculation) {
                const vRms = data.rms_calculation.voltage_rms || 0;
                const iRms = data.rms_calculation.current_rms || 0;
                
                voltageRMS.textContent = `${vRms.toFixed(3)}V`;
                currentRMS.textContent = `${iRms.toFixed(3)}A`;
                
                // æ›´æ–°RMSä¿¡æ¯å¾½ç« 
                rmsInfoText.textContent = `RMS: V=${vRms.toFixed(3)}V, I=${iRms.toFixed(3)}A`;
                rmsInfoBadge.style.display = 'inline-flex';
                
                // æ¿€æ´»æ‰¹é‡ä¿¡æ¯é¢æ¿
                batchInfoPanel.classList.add('active');
                
                updateDebugInfo(`RMSå€¼æ›´æ–°: V=${vRms.toFixed(3)}V, I=${iRms.toFixed(3)}A`);
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, text) {
            const connectionStatus = document.getElementById('connectionStatus');
            const statusIndicator = connectionStatus.querySelector('.status-indicator');
            const statusText = connectionStatus.querySelector('span');
            
            connectionStatus.className = `connection-status ${status}`;
            statusIndicator.className = `status-indicator ${status}`;
            statusText.textContent = text;
            
            updateDebugInfo(`è¿æ¥çŠ¶æ€æ›´æ–°: ${status} - ${text}`);
        }

        // æ›´æ–°ç›‘æ§çŠ¶æ€
        function updateMonitoringStatus(monitoring) {
            isMonitoring = monitoring;
            
            const startBtn = document.getElementById('startMonitorBtn');
            const stopBtn = document.getElementById('stopMonitorBtn');
            const realtimeIndicator = document.getElementById('realtimeIndicator');
            
            if (monitoring) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                realtimeIndicator.style.display = 'flex';
                
                // ğŸ”¥ å¯åŠ¨å¹³æ»‘æ»šåŠ¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if (smoothScrollMode) {
                    startSmoothScrollUpdate();
                }
            } else {
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                realtimeIndicator.style.display = 'none';
                
                // åœæ­¢å¹³æ»‘æ»šåŠ¨
                stopSmoothScrollUpdate();
            }
            
            updateDebugInfo(`ç›‘æ§çŠ¶æ€æ›´æ–°: ${monitoring ? 'å·²å¯åŠ¨' : 'å·²åœæ­¢'}`);
        }

        // å¼€å§‹ç›‘æ§
        async function startMonitoring() {
            if (!selectedClientId) {
                showError('è¯·å…ˆé€‰æ‹©æ‰¹é‡æ•°æ®æºå®¢æˆ·ç«¯');
                return;
            }
            
            if (!isConnected) {
                showError('WebSocketè¿æ¥å·²æ–­å¼€ï¼Œè¯·ç­‰å¾…é‡è¿');
                return;
            }
            
            updateDebugInfo(`å¯åŠ¨ç›‘æ§: ${selectedClientId}`);
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const monitoringRequest = {
                    type: 'start_monitoring',
                    data_source_client: selectedClientId
                };
                
                updateDebugInfo(`å‘é€ç›‘æ§è¯·æ±‚: ${JSON.stringify(monitoringRequest)}`);
                websocket.send(JSON.stringify(monitoringRequest));
                
                updateMonitoringStatus(true);
                showSuccess('æ­£åœ¨å¯åŠ¨æ‰¹é‡æ•°æ®ç›‘æ§...');
            } else {
                showError('WebSocketè¿æ¥æœªå»ºç«‹');
            }
        }

        // åœæ­¢ç›‘æ§
        async function stopMonitoring() {
            updateDebugInfo('åœæ­¢ç›‘æ§');
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'stop_monitoring'
                }));
            }

            updateMonitoringStatus(false);
        }

        // ç”ŸæˆRMSæ³¢å½¢ï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰
        async function generateRMSWaveform() {
            if (!selectedClientId) {
                showError('è¯·å…ˆé€‰æ‹©å®¢æˆ·ç«¯');
                return;
            }
            
            if (smoothScrollMode) {
                showWarning('å¹³æ»‘æ»šåŠ¨æ¨¡å¼ä¸‹æ— éœ€æ‰‹åŠ¨ç”Ÿæˆæ³¢å½¢');
                return;
            }
            
            try {
                updateDebugInfo('å¼€å§‹ç”ŸæˆRMSæ³¢å½¢ï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰');
                
                const formData = new FormData();
                formData.append('client_id', selectedClientId);
                formData.append('selected_column', document.getElementById('columnSelect').value);
                formData.append('model', 'rms_waveform');
                formData.append('max_points', document.getElementById('maxPointsSlider').value);
                formData.append('analysis_mode', 'waveform_display');
                
                const response = await fetch('/api/realtime_analyze', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    updateDebugInfo('RMSæ³¢å½¢ç”ŸæˆæˆåŠŸï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰');
                    updateTraditionalChart(result.data);
                    showSuccess('RMSæ³¢å½¢ç”ŸæˆæˆåŠŸ');
                } else {
                    updateDebugInfo(`RMSæ³¢å½¢ç”Ÿæˆå¤±è´¥: ${result.message}`);
                    showError(`æ³¢å½¢ç”Ÿæˆå¤±è´¥: ${result.message}`);
                }
                
            } catch (error) {
                updateDebugInfo(`RMSæ³¢å½¢ç”Ÿæˆé”™è¯¯: ${error.message}`);
                showError(`ç”Ÿæˆæ³¢å½¢æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
            }
        }

        // æ›´æ–°ä¼ ç»Ÿå›¾è¡¨ï¼ˆéå¹³æ»‘æ¨¡å¼ï¼‰
        function updateTraditionalChart(analysisData) {
            try {
                if (!waveChart || !analysisData) {
                    updateDebugInfo('å›¾è¡¨æˆ–æ•°æ®ä¸å¯ç”¨');
                    return;
                }
                
                updateDebugInfo(`æ›´æ–°ä¼ ç»Ÿå›¾è¡¨: ${analysisData.wave_data.length}ä¸ªæ•°æ®ç‚¹`);
                
                // æ¸…ç©ºç°æœ‰æ•°æ®
                waveChart.data.datasets = [];
                waveChart.data.labels = [];
                
                // æ·»åŠ æ•°æ®é›†
                if (analysisData.wave_data && analysisData.wave_data.length > 0) {
                    const selectedColumn = analysisData.selected_column || 'voltage';
                    const color = selectedColumn === 'voltage' ? 
                        document.getElementById('voltageColor').value : 
                        document.getElementById('currentColor').value;
                    const label = selectedColumn === 'voltage' ? 'ç”µå‹æ³¢å½¢ (RMS)' : 'ç”µæµæ³¢å½¢ (RMS)';
                    
                    // å‡†å¤‡æ•°æ®
                    const chartData = analysisData.wave_data.map((point, index) => ({
                        x: index,
                        y: point.y
                    }));
                    
                    // åˆ›å»ºæ ‡ç­¾
                    waveChart.data.labels = analysisData.wave_data.map((point, index) => index);
                    
                    waveChart.data.datasets.push({
                        label: label,
                        data: chartData,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: parseInt(document.getElementById('lineWidthSlider').value),
                        fill: false,
                        tension: 0.1,
                        pointRadius: document.getElementById('pointsSwitch').checked ? 1 : 0
                    });
                    
                    updateDebugInfo(`ä¼ ç»Ÿå›¾è¡¨æ•°æ®é›†æ·»åŠ : ${label}, ${chartData.length}ä¸ªç‚¹`);
                }
                
                // æ›´æ–°å›¾è¡¨
                const animationEnabled = document.getElementById('animationSwitch').checked;
                waveChart.update(animationEnabled ? 'default' : 'none');
                
                // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
                if (analysisData.source_rms_values) {
                    const vRms = analysisData.source_rms_values.voltage_rms || 0;
                    const iRms = analysisData.source_rms_values.current_rms || 0;
                    
                    document.getElementById('rmsInfoText').textContent = 
                        `RMS: V=${vRms.toFixed(3)}V, I=${iRms.toFixed(3)}A`;
                    document.getElementById('rmsInfoBadge').style.display = 'inline-flex';
                }
                
                document.getElementById('updateTime').textContent = 
                    `æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}`;
                
                updateDebugInfo('ä¼ ç»Ÿå›¾è¡¨æ›´æ–°å®Œæˆ');
                
            } catch (error) {
                updateDebugInfo(`ä¼ ç»Ÿå›¾è¡¨æ›´æ–°é”™è¯¯: ${error.message}`);
                console.error('Chart update error:', error);
            }
        }

        // æ›´æ–°å›¾è¡¨çº¿æ¡ç²—ç»†
        function updateChartLineWidth(width) {
            if (waveChart && waveChart.data.datasets) {
                waveChart.data.datasets.forEach(dataset => {
                    dataset.borderWidth = width;
                });
                waveChart.update('none');
            }
        }

        // å®šæœŸå¿ƒè·³æ£€æµ‹
        setInterval(() => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000); // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶é‡æ–°è¿æ¥
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && (!websocket || websocket.readyState !== WebSocket.OPEN)) {
                updateDebugInfo('é¡µé¢å¯è§ï¼Œé‡æ–°è¿æ¥WebSocket');
                connectWebSocket();
            }
        });

        // ğŸ”¥ è°ƒè¯•å’ŒçŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        function getSystemStatus() {
            return {
                selectedClientId: selectedClientId,
                isMonitoring: isMonitoring,
                isConnected: isConnected,
                smoothScrollMode: smoothScrollMode,
                scrollWindowSize: scrollWindowSize,
                updateInterval: updateInterval,
                currentRMSValues: currentRMSValues,
                bufferSizes: {
                    voltage: waveformBuffer.voltage.length,
                    current: waveformBuffer.current.length,
                    timeAxis: waveformBuffer.timeAxis.length
                },
                timeOffset: timeOffset
            };
        }

        function debugSmoothScroll() {
            console.log('=== ğŸ” å¹³æ»‘æ»šåŠ¨è°ƒè¯•ä¿¡æ¯ ===');
            const status = getSystemStatus();
            Object.keys(status).forEach(key => {
                console.log(`${key}:`, status[key]);
            });
            console.log('=========================');
            return status;
        }

        // æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€
        window.getSystemStatus = getSystemStatus;
        window.debugSmoothScroll = debugSmoothScroll;
        window.forceUpdateRMS = function(vRms, iRms) {
            currentRMSValues.voltage_rms = vRms || 220;
            currentRMSValues.current_rms = iRms || 10;
            updateDebugInfo(`æ‰‹åŠ¨è®¾ç½®RMSå€¼: V=${vRms}V, I=${iRms}A`);
        };

        console.log('ğŸš€ æ”¹è¿›çš„RMSæ³¢å½¢æ˜¾ç¤ºç³»ç»ŸåŠ è½½å®Œæˆ!');
        console.log('ğŸ’¡ ä½¿ç”¨ debugSmoothScroll() æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯');
        console.log('ğŸ”§ ä½¿ç”¨ forceUpdateRMS(220, 10) æ‰‹åŠ¨è®¾ç½®RMSå€¼è¿›è¡Œæµ‹è¯•');
    </script>
</body>
</html>