<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电力波形分析系统 - RMS波形显示</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --sidebar-width: 60px;
            --param-width: 320px;
            --transition: all 0.3s ease;
            
            --dc-color: #9b59b6;
            --single-phase-color: #3498db;
            --phase-a-color: #e74c3c;
            --phase-b-color: #f39c12;
            --phase-c-color: #3498db;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: #333;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: var(--secondary-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            position: relative;
            z-index: 100;
            transition: var(--transition);
            flex-shrink: 0;
        }
        
        .menu-toggle-container {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: auto;
            margin-bottom: 30px;
        }
        
        .menu-toggle {
            background: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .menu-toggle:hover {
            background: var(--accent-color);
        }
        
        .menu-toggle i {
            font-size: 20px;
        }
        
        .menu-options {
            position: absolute;
            left: 100%;
            top: 0;
            bottom: 0;
            width: 0;
            background: white;
            box-shadow: 3px 0 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: var(--transition);
            z-index: 99;
            opacity: 0;
            visibility: hidden;
        }
        
        .sidebar:hover .menu-options {
            width: 250px;
            opacity: 1;
            visibility: visible;
            padding: 20px 15px;
            overflow-y: auto;
        }
        
        .menu-option {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .menu-option:hover {
            background: #f1f1f1;
            padding-left: 15px;
        }
        
        .menu-option i {
            margin-right: 10px;
            color: var(--primary-color);
            width: 20px;
            text-align: center;
        }
        
        .menu-option.active {
            background: #e8f0fe;
            border-left: 3px solid var(--primary-color);
        }
        
        .param-bar {
            width: var(--param-width);
            background: white;
            padding: 20px 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            position: relative;
            z-index: 90;
            transition: all 0.3s ease;
            flex-shrink: 0;
            height: calc(100vh - 40px);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .param-bar h4 {
            position: sticky;
            top: -20px;
            background: white;
            z-index: 10;
            margin: -20px -15px 20px -15px;
            padding: 20px 15px 15px 15px;
            border-bottom: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 16px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-top: 20px;
            margin-bottom: 15px;
            font-weight: 600;
            background: white;
            position: sticky;
            top: 60px;
            z-index: 5;
        }
        
        .param-group {
            margin-bottom: 25px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 15px;
        }
        
        .param-group:last-child {
            border-bottom: none;
            margin-bottom: 15px;
        }
        
        .batch-info-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            color: white;
            border: 2px solid transparent;
            transition: var(--transition);
        }
        
        .batch-info-panel.active {
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.3);
        }
        
        .batch-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .batch-stat:last-child {
            margin-bottom: 0;
        }
        
        .batch-label {
            opacity: 0.8;
        }
        
        .batch-value {
            font-weight: bold;
            color: #00ff88;
        }
        
        .rms-display {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .rms-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .rms-value:last-child {
            margin-bottom: 0;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .nav-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .nav-breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .nav-breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1aeb5;
        }
        
        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.connected {
            background: var(--success-color);
        }
        
        .status-indicator.disconnected {
            background: var(--accent-color);
        }
        
        .status-indicator.connecting {
            background: var(--warning-color);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .client-info-bar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .client-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .client-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .client-icon.batch-sensor {
            background: var(--single-phase-color);
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
            flex: 1 1 auto;
            min-height: 450px;
            position: relative;
            width: 100%;
            min-width: 0;
            transition: all 0.3s ease;
        }
        
        .chart-container canvas {
            width: 100% !important;
            min-height: 400px;
            height: auto !important;
            max-height: 650px;
        }
        
        .chart-title {
            margin-bottom: 15px;
            font-weight: 500;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: color 0.3s ease;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .rms-info-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success-color);
            border: none;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-warning {
            background: var(--warning-color);
            border: none;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f1aeb5;
        }
        
        .success-message {
            background: #d1f7c4;
            color: #0c5460;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            background: #f8fff9;
            border: 1px solid #27ae60;
            border-radius: 15px;
            font-size: 12px;
            color: #27ae60;
            font-weight: 500;
        }
        
        .realtime-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 1s infinite;
        }
        
        .transmission-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        .transmission-status.active {
            display: block;
            animation: fadeInOut 2s;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        /* 平滑滚动模式新增样式 */
        .smooth-scroll-controls {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            color: white;
            border: 2px solid transparent;
            transition: var(--transition);
        }
        
        .smooth-scroll-controls.active {
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.3);
        }
        
        .scroll-toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .scroll-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .scroll-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .scroll-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.3);
            transition: .4s;
            border-radius: 30px;
            border: 2px solid rgba(255,255,255,0.5);
        }
        
        .scroll-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input:checked + .scroll-slider {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        input:checked + .scroll-slider:before {
            transform: translateX(30px);
        }
        
        .scroll-params {
            display: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .scroll-params.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .app-container {
                flex-wrap: wrap;
            }
            
            .sidebar {
                width: 100%;
                height: 60px;
                flex-direction: row;
                justify-content: space-between;
                padding: 0 20px;
                position: fixed;
                top: 0;
                z-index: 1000;
            }
            
            .param-bar {
                width: 100%;
                height: auto;
                max-height: 50vh;
                position: fixed;
                top: 60px;
                z-index: 999;
                max-height: 0;
                padding: 0 15px;
                transition: max-height 0.3s ease;
            }
            
            .param-bar.active {
                max-height: 50vh;
                padding: 20px 15px;
            }
            
            .main-content {
                width: 100%;
                padding-top: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .chart-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="transmission-status" id="transmissionStatus">
        批量数据传输中...
    </div>

    <div class="app-container" id="appContainer">
        <div class="sidebar">
            <div class="menu-toggle-container">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
            <div class="menu-options">
                <div class="menu-option" onclick="goToClientSelection()">
                    <i class="fas fa-arrow-left"></i> 返回客户端选择
                </div>
                <div class="menu-option active">
                    <i class="fas fa-chart-line"></i> RMS波形显示
                </div>
                <div class="menu-option" onclick="goToDataAnalysis()">
                    <i class="fas fa-analytics"></i> 数据综合分析
                </div>
                <div class="menu-option" onclick="downloadClientCSV()">
                    <i class="fas fa-download"></i> 下载CSV数据
                </div>
                <div class="menu-option" onclick="toggleDebug()">
                    <i class="fas fa-bug"></i> 调试模式
                </div>
            </div>
        </div>
        
        <div class="param-bar">
            <h4 class="mb-4" style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                <i class="fas fa-bolt me-2"></i>RMS波形参数
            </h4>
            
            <form id="analysisForm">
                <!-- 平滑滚动控制面板 -->
                <div class="param-group">
                    <div class="section-title">平滑滚动控制</div>
                    <div class="smooth-scroll-controls" id="smoothScrollControls">
                        <div class="scroll-toggle-wrapper">
                            <div>
                                <strong><i class="fas fa-water me-2"></i>平滑滚动模式</strong>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 3px;">
                                    避免整体重绘，平滑更新波形
                                </div>
                            </div>
                            <label class="scroll-toggle">
                                <input type="checkbox" id="smoothScrollMode" checked>
                                <span class="scroll-slider"></span>
                            </label>
                        </div>
                        
                        <div class="scroll-params active" id="scrollParams">
                            <div class="speed-control">
                                <label class="form-label" style="color: white; font-size: 13px; font-weight: 500;">
                                    滚动窗口大小: <span id="scrollWindowValue">500</span> 点
                                </label>
                                <input type="range" class="form-range" id="scrollWindowSlider" 
                                       min="200" max="1000" value="500" step="50">
                                <small class="form-text" style="color: rgba(255,255,255,0.7); font-size: 11px;">
                                    控制滚动窗口中显示的数据点数量
                                </small>
                            </div>
                            
                            <div class="speed-control">
                                <label class="form-label" style="color: white; font-size: 13px; font-weight: 500;">
                                    更新间隔: <span id="updateIntervalValue">100</span> ms
                                </label>
                                <input type="range" class="form-range" id="updateIntervalSlider"
                                       min="50" max="500" value="100" step="25">
                                <small class="form-text" style="color: rgba(255,255,255,0.7); font-size: 11px;">
                                    控制波形更新的频率
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 批量数据信息面板 -->
                <div class="param-group">
                    <div class="section-title">批量数据状态</div>
                    <div class="batch-info-panel" id="batchInfoPanel">
                        <div class="batch-stat">
                            <span class="batch-label">数据模式</span>
                            <span class="batch-value">400点批量</span>
                        </div>
                        <div class="batch-stat">
                            <span class="batch-label">批次计数</span>
                            <span class="batch-value" id="batchCount">0</span>
                        </div>
                        <div class="batch-stat">
                            <span class="batch-label">最后更新</span>
                            <span class="batch-value" id="lastUpdate">等待数据</span>
                        </div>
                        
                        <div class="rms-display" id="rmsDisplay">
                            <div class="rms-value">
                                <span>电压RMS:</span>
                                <span id="voltageRMS">0.000V</span>
                            </div>
                            <div class="rms-value">
                                <span>电流RMS:</span>
                                <span id="currentRMS">0.000A</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="param-group">
                    <div class="section-title">分析参数</div>
                    <div class="mb-3">
                        <label class="form-label">选择分析参数</label>
                        <select class="form-select" name="selected_column" id="columnSelect">
                            <option value="voltage">电压</option>
                            <option value="current">电流</option>
                        </select>
                        <small class="form-text text-muted">选择要重点分析的参数</small>
                    </div>
                </div>
                
                <div class="param-group">
                    <div class="section-title">显示参数</div>
                    <div class="mb-3">
                        <label class="form-label">显示数据点数: <span id="maxPointsValue">1000</span></label>
                        <input type="range" class="form-range" name="max_points" min="400" max="5000" value="1000" id="maxPointsSlider">
                        <small class="form-text text-muted">控制RMS波形显示的精度</small>
                    </div>
                </div>
                
                <div class="param-group">
                    <div class="section-title">可视化设置</div>
                    <div class="mb-3">
                        <label class="form-label">电压颜色</label>
                        <input type="color" class="form-control form-control-color" name="voltage_color" id="voltageColor" value="#3498db">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">电流颜色</label>
                        <input type="color" class="form-control form-control-color" name="current_color" id="currentColor" value="#e74c3c">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">线条粗细: <span id="lineWidthValue">2</span>px</label>
                        <input type="range" class="form-range" name="line_width" min="1" max="5" value="2" id="lineWidthSlider">
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="animationSwitch" name="enable_animation">
                        <label class="form-check-label" for="animationSwitch">启用动画效果</label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="pointsSwitch" name="show_points">
                        <label class="form-check-label" for="pointsSwitch">显示数据点</label>
                    </div>
                </div>
                
                <button type="button" class="btn btn-success" id="startMonitorBtn">
                    <i class="fas fa-eye me-2"></i>开始RMS监控
                </button>
                
                <button type="button" class="btn btn-warning mt-2" id="stopMonitorBtn" style="display: none;">
                    <i class="fas fa-stop me-2"></i>停止监控
                </button>
                
                <button type="button" class="btn btn-primary mt-2" id="generateWaveformBtn">
                    <i class="fas fa-sine-wave me-2"></i>生成RMS波形
                </button>
            </form>
            
            <!-- 调试面板 -->
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <div class="debug-title">🔍 调试信息</div>
                <div id="debugContent">调试面板已启用，等待数据...</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="top-bar">
                <div>
                    <div class="nav-breadcrumb">
                        <a href="/client-selection">客户端选择</a>
                        <i class="fas fa-chevron-right"></i>
                        <span>RMS波形显示</span>
                    </div>
                    <h2 class="mb-0 mt-2">
                        <i class="fas fa-chart-line me-2" style="color: var(--primary-color);"></i>
                        电力RMS波形显示 - 平滑滚动
                    </h2>
                    <p class="text-muted mb-0">400点批量数据 · RMS计算 · 平滑滚动更新</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="connection-status connecting" id="connectionStatus">
                        <div class="status-indicator connecting"></div>
                        <span>连接中...</span>
                    </div>
                    <div class="realtime-indicator" id="realtimeIndicator" style="display: none;">
                        <div class="realtime-dot"></div>
                        <span>RMS监控</span>
                    </div>
                </div>
            </div>
            
            <div id="messageArea"></div>
            
            <!-- 客户端信息栏 -->
            <div class="client-info-bar" id="clientInfoBar" style="display: none;">
                <div class="client-details">
                    <div class="client-icon batch-sensor" id="clientIcon">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div>
                        <h6 class="mb-0" id="clientName">未选择客户端</h6>
                        <small class="text-muted" id="clientStatus">请从侧边栏开始监控</small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="goToClientSelection()">
                        <i class="fas fa-exchange-alt me-1"></i>切换客户端
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="goToDataAnalysis()">
                        <i class="fas fa-analytics me-1"></i>数据分析
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="downloadClientCSV()">
                        <i class="fas fa-download me-1"></i>下载CSV
                    </button>
                </div>
            </div>
            
            <div class="chart-container" id="chartContainer">
                <div class="chart-title">
                    <span id="chartTitle">
                        <i class="fas fa-chart-line me-2"></i>RMS正弦波形 - 等待数据源
                    </span>
                    <div class="chart-controls">
                        <div class="rms-info-badge" id="rmsInfoBadge" style="display: none;">
                            <i class="fas fa-calculator me-1"></i>
                            <span id="rmsInfoText">RMS: V=0.000V, I=0.000A</span>
                        </div>
                        <span class="text-muted" id="updateTime">等待数据源...</span>
                    </div>
                </div>
                <canvas id="waveChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // 🔥 改进的RMS波形显示系统 - 支持平滑滚动更新
        
        // 全局变量
        let waveChart = null;
        let websocket = null;
        let selectedClientId = null;
        let isMonitoring = false;
        let webClientId = 'web_' + Math.random().toString(36).substr(2, 9);
        let realtimeUpdateInterval = null;
        let isConnected = false;
        let debugMode = false;
        
        // 平滑滚动相关变量
        let smoothScrollMode = true;
        let scrollWindowSize = 500;
        let updateInterval = 100;
        let scrollUpdateTimer = null;
        
        // 客户端数据缓存
        let clientDataCache = {};
        let lastRMSData = {};
        
        // 波形数据缓冲区 - 用于平滑滚动
        let waveformBuffer = {
            voltage: [],
            current: [],
            timeAxis: []
        };
        
        // 最新的RMS值 - 用于生成波形
        let currentRMSValues = {
            voltage_rms: 0.01,
            current_rms: 10.0
        };
        
        // 波形生成参数
        let timeOffset = 0;
        let frequency = 50; // Hz
        let samplingRate = 1000; // 采样率
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginAndClientSelection();
            initChart();
            setupEventListeners();
            connectWebSocket();
            setupSliders();
            initSmoothScrollMode();
        });

        // 检查登录状态和客户端选择
        function checkLoginAndClientSelection() {
            // 检查登录状态
            const savedLogin = localStorage.getItem('userLogin') || sessionStorage.getItem('userLogin');
            if (!savedLogin) {
                window.location.href = '/login';
                return;
            }
            
            // 检查是否选择了客户端
            const selectedClient = sessionStorage.getItem('selectedClientId');
            if (!selectedClient) {
                showError('请先选择一个客户端');
                setTimeout(() => {
                    window.location.href = '/client-selection';
                }, 2000);
                return;
            }
            
            selectedClientId = selectedClient;
            updateClientInfo(selectedClient);
            updateDebugInfo(`已选择客户端: ${selectedClient}`);
            
            console.log('✅ Batch Client selected:', selectedClientId);
        }

        // 调试功能
        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugMode ? 'block' : 'none';
            
            if (debugMode) {
                updateDebugInfo('调试模式已启用');
            }
        }

        function updateDebugInfo(message) {
            if (!debugMode) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const debugContent = document.getElementById('debugContent');
            
            if (debugContent) {
                debugContent.innerHTML += `<br>[${timestamp}] ${message}`;
                // 保持最新的50行
                const lines = debugContent.innerHTML.split('<br>');
                if (lines.length > 50) {
                    debugContent.innerHTML = lines.slice(-50).join('<br>');
                }
                // 滚动到底部
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            console.log(`[DEBUG] ${message}`);
        }

        // 更新客户端信息显示
        function updateClientInfo(clientId) {
            const clientInfoBar = document.getElementById('clientInfoBar');
            const clientName = document.getElementById('clientName');
            const clientStatus = document.getElementById('clientStatus');
            
            clientInfoBar.style.display = 'flex';
            clientName.textContent = clientId;
            clientStatus.textContent = '准备连接批量数据源...';
            
            updateDebugInfo(`更新客户端信息: ${clientId}`);
        }

        // 初始化平滑滚动模式
        function initSmoothScrollMode() {
            const smoothScrollControls = document.getElementById('smoothScrollControls');
            const scrollParams = document.getElementById('scrollParams');
            
            if (smoothScrollMode) {
                smoothScrollControls.classList.add('active');
                scrollParams.classList.add('active');
                startSmoothScrollUpdate();
            }
            
            updateDebugInfo('平滑滚动模式已初始化');
        }

        // 消息显示函数
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const alertClass = type === 'success' ? 'success-message' : 
                              type === 'error' ? 'error-message' : 'warning-message';
            
            messageArea.innerHTML = `<div class="${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            showMessage(message, 'success');
            updateDebugInfo(`SUCCESS: ${message}`);
        }

        function showError(message) {
            showMessage(message, 'error');
            updateDebugInfo(`ERROR: ${message}`);
        }

        function showWarning(message) {
            showMessage(message, 'warning');
            updateDebugInfo(`WARNING: ${message}`);
        }

        // 显示传输状态
        function showTransmissionStatus() {
            const transmissionStatus = document.getElementById('transmissionStatus');
            transmissionStatus.classList.add('active');
            setTimeout(() => {
                transmissionStatus.classList.remove('active');
            }, 2000);
        }

        // 导航函数
        function goToClientSelection() {
            if (isMonitoring) {
                stopMonitoring();
            }
            if (websocket) {
                websocket.close();
            }
            window.location.href = '/client-selection';
        }

        function goToDataAnalysis() {
            if (selectedClientId) {
                sessionStorage.setItem('selectedClientId', selectedClientId);
                sessionStorage.setItem('analysisMode', 'analysis');
            }
            window.location.href = '/data-analysis';
        }

        function downloadClientCSV() {
            if (selectedClientId) {
                const downloadUrl = `/api/download_csv/${selectedClientId}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `batch_data_${selectedClientId}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess('正在下载CSV数据文件...');
                updateDebugInfo(`下载CSV文件: ${downloadUrl}`);
            } else {
                showError('请先选择一个客户端');
            }
        }

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('waveChart').getContext('2d');
            waveChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: [],
                    datasets: [] 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // 关闭动画提高性能
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#333',
                                usePointStyle: true,
                                pointStyle: 'line'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return `采样点: ${context[0].label}`;
                                },
                                label: function(context) {
                                    const unit = getUnitForDataset(context.dataset.label);
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(3)}${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            display: true,
                            title: { display: true, text: '时间序列', color: '#333' },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { color: '#333' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: '幅值', color: '#333' },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { color: '#333' }
                        }
                    },
                    elements: {
                        point: { radius: 0, hoverRadius: 5 },
                        line: { borderWidth: 2, tension: 0.1 }
                    }
                }
            });
            
            updateDebugInfo('图表初始化完成');
        }

        // 获取数据集对应的单位
        function getUnitForDataset(label) {
            if (label && (label.includes('电压') || label.includes('voltage'))) return 'V';
            if (label && (label.includes('电流') || label.includes('current'))) return 'A';
            return '';
        }

        // 设置滑块事件监听
        function setupSliders() {
            const maxPointsSlider = document.getElementById('maxPointsSlider');
            const maxPointsValue = document.getElementById('maxPointsValue');
            const lineWidthSlider = document.getElementById('lineWidthSlider');
            const lineWidthValue = document.getElementById('lineWidthValue');
            
            // 平滑滚动控制
            const scrollWindowSlider = document.getElementById('scrollWindowSlider');
            const scrollWindowValue = document.getElementById('scrollWindowValue');
            const updateIntervalSlider = document.getElementById('updateIntervalSlider');
            const updateIntervalValue = document.getElementById('updateIntervalValue');
            
            maxPointsSlider.addEventListener('input', function() {
                maxPointsValue.textContent = this.value;
            });
            
            lineWidthSlider.addEventListener('input', function() {
                lineWidthValue.textContent = this.value;
                updateChartLineWidth(parseInt(this.value));
            });
            
            scrollWindowSlider.addEventListener('input', function() {
                scrollWindowSize = parseInt(this.value);
                scrollWindowValue.textContent = scrollWindowSize;
                resizeWaveformBuffer();
                updateDebugInfo(`滚动窗口大小调整为: ${scrollWindowSize}`);
            });
            
            updateIntervalSlider.addEventListener('input', function() {
                updateInterval = parseInt(this.value);
                updateIntervalValue.textContent = updateInterval;
                if (smoothScrollMode && isMonitoring) {
                    restartSmoothScrollUpdate();
                }
                updateDebugInfo(`更新间隔调整为: ${updateInterval}ms`);
            });
        }

        // 设置事件监听器
        function setupEventListeners() {
            document.getElementById('startMonitorBtn').addEventListener('click', startMonitoring);
            document.getElementById('stopMonitorBtn').addEventListener('click', stopMonitoring);
            document.getElementById('generateWaveformBtn').addEventListener('click', generateRMSWaveform);
            
            // 平滑滚动模式开关
            document.getElementById('smoothScrollMode').addEventListener('change', function() {
                smoothScrollMode = this.checked;
                const smoothScrollControls = document.getElementById('smoothScrollControls');
                const scrollParams = document.getElementById('scrollParams');
                
                if (smoothScrollMode) {
                    smoothScrollControls.classList.add('active');
                    scrollParams.classList.add('active');
                    startSmoothScrollUpdate();
                    showSuccess('平滑滚动模式已启用');
                    updateDebugInfo('平滑滚动模式已启用');
                } else {
                    smoothScrollControls.classList.remove('active');
                    scrollParams.classList.remove('active');
                    stopSmoothScrollUpdate();
                    showWarning('平滑滚动模式已禁用');
                    updateDebugInfo('平滑滚动模式已禁用');
                }
            });
            
            // 参数变化时重新生成波形
            document.getElementById('columnSelect').addEventListener('change', function() {
                if (lastRMSData.voltage_rms !== undefined) {
                    if (smoothScrollMode) {
                        // 平滑模式下不重新生成，继续使用当前缓冲区
                        updateDebugInfo('参数变化，平滑模式继续使用当前缓冲区');
                    } else {
                        generateRMSWaveform();
                    }
                }
            });
            
            updateDebugInfo('事件监听器设置完成');
        }

        // WebSocket连接初始化
        function connectWebSocket() {
            if (websocket) {
                websocket.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${webClientId}`;
            
            updateDebugInfo(`正在连接WebSocket: ${wsUrl}`);
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('✅ WebSocket connected');
                    isConnected = true;
                    updateConnectionStatus('connected', '已连接');
                    updateDebugInfo('WebSocket连接成功');
                    
                    // 获取客户端最新数据
                    fetchClientStatus();
                };
                
                websocket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    updateDebugInfo(`收到WebSocket消息: ${message.type}`);
                    handleWebSocketMessage(message);
                };
                
                websocket.onclose = function(event) {
                    console.log('❌ WebSocket disconnected');
                    isConnected = false;
                    updateConnectionStatus('disconnected', '连接断开');
                    updateDebugInfo(`WebSocket断开: code=${event.code}`);
                    setTimeout(connectWebSocket, 3000);
                };
                
                websocket.onerror = function(error) {
                    console.error('❌ WebSocket error:', error);
                    isConnected = false;
                    updateConnectionStatus('disconnected', '连接错误');
                    updateDebugInfo('WebSocket连接错误');
                };
                
            } catch (error) {
                console.error('❌ WebSocket connection failed:', error);
                isConnected = false;
                updateConnectionStatus('disconnected', '连接失败');
                updateDebugInfo(`WebSocket连接失败: ${error.message}`);
            }
        }

        // 获取客户端状态
        async function fetchClientStatus() {
            try {
                updateDebugInfo(`获取客户端状态: ${selectedClientId}`);
                
                const response = await fetch(`/api/batch_status/${selectedClientId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateDebugInfo(`客户端状态获取成功: ${JSON.stringify(data.rms_values)}`);
                    
                    // 更新RMS值显示
                    if (data.rms_values) {
                        lastRMSData = data.rms_values;
                        currentRMSValues = data.rms_values;
                        updateBatchDataDisplay({
                            rms_calculation: data.rms_values,
                            data_points: { total: data.batch_info.total_batches_received || 0 }
                        });
                        
                        // 根据模式决定如何更新波形
                        if (smoothScrollMode) {
                            // 平滑模式：只更新RMS值，不重新生成整个波形
                            updateDebugInfo('平滑模式：更新RMS值，继续滚动');
                        } else {
                            // 传统模式：重新生成波形
                            setTimeout(() => {
                                generateRMSWaveform();
                            }, 500);
                        }
                    }
                } else {
                    updateDebugInfo(`客户端状态获取失败: ${data.message}`);
                }
            } catch (error) {
                updateDebugInfo(`获取客户端状态错误: ${error.message}`);
            }
        }

        // 处理WebSocket消息
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'monitoring_started':
                    updateDebugInfo(`监控已启动: ${message.data_source_client}`);
                    showSuccess(`开始监控批量数据客户端: ${message.data_source_client}`);
                    updateMonitoringStatus(true);
                    break;
                    
                case 'monitoring_stopped':
                    updateDebugInfo('监控已停止');
                    showSuccess('已停止批量数据监控');
                    updateMonitoringStatus(false);
                    break;
                    
                case 'batch_data_update':
                    if (message.client_id === selectedClientId && isMonitoring) {
                        updateDebugInfo(`收到批量数据更新: ${message.data.data_points.total}点`);
                        showTransmissionStatus();
                        handleBatchDataUpdate(message.data);
                    }
                    break;
                    
                case 'pong':
                    updateDebugInfo('收到心跳响应');
                    break;
                    
                case 'error':
                    updateDebugInfo(`服务器错误: ${message.message}`);
                    showError(message.message || '发生未知错误');
                    break;
                    
                default:
                    updateDebugInfo(`未知消息类型: ${message.type}`);
            }
        }

        // 处理批量数据更新
        function handleBatchDataUpdate(data) {
            try {
                updateDebugInfo('处理批量数据更新');
                
                // 更新客户端缓存
                clientDataCache[selectedClientId] = data;
                
                // 更新批量数据显示
                updateBatchDataDisplay(data);
                
                // 更新客户端状态
                const clientStatus = document.getElementById('clientStatus');
                if (clientStatus) {
                    clientStatus.textContent = `正在接收批量数据... (${data.data_points.total}点)`;
                }
                
                // 更新图表标题
                const chartTitle = document.getElementById('chartTitle');
                if (chartTitle) {
                    chartTitle.innerHTML = `
                        <i class="fas fa-chart-line me-2"></i>
                        RMS正弦波形 - 客户端: ${selectedClientId} (批量模式)
                    `;
                }
                
                // 🔥 关键改进：根据模式更新波形
                if (data.rms_calculation) {
                    lastRMSData = data.rms_calculation;
                    currentRMSValues = data.rms_calculation;
                    
                    if (smoothScrollMode) {
                        // 平滑模式：只更新RMS值，不重新生成整个波形
                        updateDebugInfo(`平滑模式：接收到新RMS值 V=${currentRMSValues.voltage_rms}V, I=${currentRMSValues.current_rms}A`);
                    } else {
                        // 传统模式：重新生成波形
                        setTimeout(() => {
                            generateRMSWaveform();
                        }, 200);
                    }
                }
                
            } catch (error) {
                updateDebugInfo(`批量数据更新处理错误: ${error.message}`);
            }
        }

        // 🔥 核心功能：启动平滑滚动更新
        function startSmoothScrollUpdate() {
            if (scrollUpdateTimer) {
                clearInterval(scrollUpdateTimer);
            }
            
            // 初始化波形缓冲区
            initializeWaveformBuffer();
            
            scrollUpdateTimer = setInterval(() => {
                if (smoothScrollMode && isMonitoring) {
                    generateSmoothScrollData();
                    updateSmoothScrollChart();
                }
            }, updateInterval);
            
            updateDebugInfo(`平滑滚动更新已启动，间隔: ${updateInterval}ms`);
        }

        // 停止平滑滚动更新
        function stopSmoothScrollUpdate() {
            if (scrollUpdateTimer) {
                clearInterval(scrollUpdateTimer);
                scrollUpdateTimer = null;
            }
            updateDebugInfo('平滑滚动更新已停止');
        }

        // 重启平滑滚动更新
        function restartSmoothScrollUpdate() {
            stopSmoothScrollUpdate();
            if (smoothScrollMode) {
                startSmoothScrollUpdate();
            }
        }

        // 初始化波形缓冲区
        function initializeWaveformBuffer() {
            waveformBuffer.voltage = new Array(scrollWindowSize).fill(0);
            waveformBuffer.current = new Array(scrollWindowSize).fill(0);
            waveformBuffer.timeAxis = new Array(scrollWindowSize).fill(0).map((_, i) => i);
            timeOffset = 0;
            
            updateDebugInfo(`波形缓冲区已初始化，大小: ${scrollWindowSize}`);
        }

        // 调整波形缓冲区大小
        function resizeWaveformBuffer() {
            const oldSize = waveformBuffer.voltage.length;
            
            if (scrollWindowSize > oldSize) {
                // 增加缓冲区
                const diff = scrollWindowSize - oldSize;
                for (let i = 0; i < diff; i++) {
                    waveformBuffer.voltage.unshift(0);
                    waveformBuffer.current.unshift(0);
                    waveformBuffer.timeAxis.unshift(waveformBuffer.timeAxis[0] - 1);
                }
            } else if (scrollWindowSize < oldSize) {
                // 减少缓冲区
                const diff = oldSize - scrollWindowSize;
                waveformBuffer.voltage.splice(0, diff);
                waveformBuffer.current.splice(0, diff);
                waveformBuffer.timeAxis.splice(0, diff);
            }
            
            // 重新编号时间轴
            waveformBuffer.timeAxis = waveformBuffer.timeAxis.map((_, i) => i);
            
            updateDebugInfo(`波形缓冲区已调整，从 ${oldSize} 到 ${scrollWindowSize}`);
        }

        // 🔥 核心功能：生成平滑滚动数据
        function generateSmoothScrollData() {
            // 使用接收到的真实RMS值生成波形
            const vRms = currentRMSValues.voltage_rms || 0.01;
            const iRms = currentRMSValues.current_rms || 10.0;
            
            // 时间增量
            const dt = 1000 / samplingRate; // ms
            timeOffset += dt;
            
            // 计算相位
            const phase = (2 * Math.PI * frequency * timeOffset) / 1000;
            
            // 🔥 使用真实RMS值生成正弦波
            const voltageAmplitude = vRms * Math.sqrt(2);
            const currentAmplitude = iRms * Math.sqrt(2);
            
            // 生成电压波形（正弦波 + 少量谐波和噪声）
            const voltageBase = voltageAmplitude * Math.sin(phase);
            const voltageHarmonic = voltageBase * 0.05 * Math.sin(3 * phase);
            const voltageNoise = (Math.random() - 0.5) * vRms * 0.02;
            const voltageValue = voltageBase + voltageHarmonic + voltageNoise;
            
            // 生成电流波形（滞后电压30度）
            const currentPhase = phase - (Math.PI / 6); // 30度相位差
            const currentBase = currentAmplitude * Math.sin(currentPhase);
            const currentHarmonic = currentBase * 0.03 * Math.sin(5 * phase);
            const currentNoise = (Math.random() - 0.5) * iRms * 0.02;
            const currentValue = currentBase + currentHarmonic + currentNoise;
            
            // 🔥 滚动更新缓冲区（从右到左滚动）
            waveformBuffer.voltage.shift();  // 移除最左边的旧数据
            waveformBuffer.current.shift();
            waveformBuffer.timeAxis.shift();
            
            waveformBuffer.voltage.push(voltageValue);  // 在右边添加新数据
            waveformBuffer.current.push(currentValue);
            waveformBuffer.timeAxis.push(waveformBuffer.timeAxis[waveformBuffer.timeAxis.length - 1] + 1);
        }

        // 🔥 核心功能：更新平滑滚动图表
        function updateSmoothScrollChart() {
            if (!waveChart) return;
            
            const selectedColumn = document.getElementById('columnSelect').value;
            const datasets = [];
            
            // 根据选择的参数显示对应波形
            if (selectedColumn === 'voltage') {
                datasets.push({
                    label: '电压波形 (RMS)',
                    data: waveformBuffer.voltage.map((y, i) => ({ x: i, y: y })),
                    borderColor: document.getElementById('voltageColor').value,
                    backgroundColor: 'transparent',
                    borderWidth: parseInt(document.getElementById('lineWidthSlider').value),
                    fill: false,
                    tension: 0.1,
                    pointRadius: document.getElementById('pointsSwitch').checked ? 1 : 0
                });
            } else {
                datasets.push({
                    label: '电流波形 (RMS)',
                    data: waveformBuffer.current.map((y, i) => ({ x: i, y: y })),
                    borderColor: document.getElementById('currentColor').value,
                    backgroundColor: 'transparent',
                    borderWidth: parseInt(document.getElementById('lineWidthSlider').value),
                    fill: false,
                    tension: 0.1,
                    pointRadius: document.getElementById('pointsSwitch').checked ? 1 : 0
                });
            }
            
            // 更新图表数据（无动画，避免闪烁）
            waveChart.data.labels = waveformBuffer.timeAxis;
            waveChart.data.datasets = datasets;
            waveChart.update('none');
        }

        // 更新批量数据显示
        function updateBatchDataDisplay(data) {
            const batchInfoPanel = document.getElementById('batchInfoPanel');
            const batchCount = document.getElementById('batchCount');
            const lastUpdate = document.getElementById('lastUpdate');
            const voltageRMS = document.getElementById('voltageRMS');
            const currentRMS = document.getElementById('currentRMS');
            const rmsInfoBadge = document.getElementById('rmsInfoBadge');
            const rmsInfoText = document.getElementById('rmsInfoText');
            const updateTime = document.getElementById('updateTime');
            
            // 更新批量数据信息
            if (data.data_points) {
                batchCount.textContent = `${data.data_points.total}点`;
            }
            
            const now = new Date();
            lastUpdate.textContent = now.toLocaleTimeString();
            updateTime.textContent = `最后更新: ${now.toLocaleTimeString()}`;
            
            // 更新RMS值
            if (data.rms_calculation) {
                const vRms = data.rms_calculation.voltage_rms || 0;
                const iRms = data.rms_calculation.current_rms || 0;
                
                voltageRMS.textContent = `${vRms.toFixed(3)}V`;
                currentRMS.textContent = `${iRms.toFixed(3)}A`;
                
                // 更新RMS信息徽章
                rmsInfoText.textContent = `RMS: V=${vRms.toFixed(3)}V, I=${iRms.toFixed(3)}A`;
                rmsInfoBadge.style.display = 'inline-flex';
                
                // 激活批量信息面板
                batchInfoPanel.classList.add('active');
                
                updateDebugInfo(`RMS值更新: V=${vRms.toFixed(3)}V, I=${iRms.toFixed(3)}A`);
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, text) {
            const connectionStatus = document.getElementById('connectionStatus');
            const statusIndicator = connectionStatus.querySelector('.status-indicator');
            const statusText = connectionStatus.querySelector('span');
            
            connectionStatus.className = `connection-status ${status}`;
            statusIndicator.className = `status-indicator ${status}`;
            statusText.textContent = text;
            
            updateDebugInfo(`连接状态更新: ${status} - ${text}`);
        }

        // 更新监控状态
        function updateMonitoringStatus(monitoring) {
            isMonitoring = monitoring;
            
            const startBtn = document.getElementById('startMonitorBtn');
            const stopBtn = document.getElementById('stopMonitorBtn');
            const realtimeIndicator = document.getElementById('realtimeIndicator');
            
            if (monitoring) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                realtimeIndicator.style.display = 'flex';
                
                // 🔥 启动平滑滚动（如果启用）
                if (smoothScrollMode) {
                    startSmoothScrollUpdate();
                }
            } else {
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                realtimeIndicator.style.display = 'none';
                
                // 停止平滑滚动
                stopSmoothScrollUpdate();
            }
            
            updateDebugInfo(`监控状态更新: ${monitoring ? '已启动' : '已停止'}`);
        }

        // 开始监控
        async function startMonitoring() {
            if (!selectedClientId) {
                showError('请先选择批量数据源客户端');
                return;
            }
            
            if (!isConnected) {
                showError('WebSocket连接已断开，请等待重连');
                return;
            }
            
            updateDebugInfo(`启动监控: ${selectedClientId}`);
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const monitoringRequest = {
                    type: 'start_monitoring',
                    data_source_client: selectedClientId
                };
                
                updateDebugInfo(`发送监控请求: ${JSON.stringify(monitoringRequest)}`);
                websocket.send(JSON.stringify(monitoringRequest));
                
                updateMonitoringStatus(true);
                showSuccess('正在启动批量数据监控...');
            } else {
                showError('WebSocket连接未建立');
            }
        }

        // 停止监控
        async function stopMonitoring() {
            updateDebugInfo('停止监控');
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'stop_monitoring'
                }));
            }

            updateMonitoringStatus(false);
        }

        // 生成RMS波形（传统模式）
        async function generateRMSWaveform() {
            if (!selectedClientId) {
                showError('请先选择客户端');
                return;
            }
            
            if (smoothScrollMode) {
                showWarning('平滑滚动模式下无需手动生成波形');
                return;
            }
            
            try {
                updateDebugInfo('开始生成RMS波形（传统模式）');
                
                const formData = new FormData();
                formData.append('client_id', selectedClientId);
                formData.append('selected_column', document.getElementById('columnSelect').value);
                formData.append('model', 'rms_waveform');
                formData.append('max_points', document.getElementById('maxPointsSlider').value);
                formData.append('analysis_mode', 'waveform_display');
                
                const response = await fetch('/api/realtime_analyze', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    updateDebugInfo('RMS波形生成成功（传统模式）');
                    updateTraditionalChart(result.data);
                    showSuccess('RMS波形生成成功');
                } else {
                    updateDebugInfo(`RMS波形生成失败: ${result.message}`);
                    showError(`波形生成失败: ${result.message}`);
                }
                
            } catch (error) {
                updateDebugInfo(`RMS波形生成错误: ${error.message}`);
                showError(`生成波形时发生错误: ${error.message}`);
            }
        }

        // 更新传统图表（非平滑模式）
        function updateTraditionalChart(analysisData) {
            try {
                if (!waveChart || !analysisData) {
                    updateDebugInfo('图表或数据不可用');
                    return;
                }
                
                updateDebugInfo(`更新传统图表: ${analysisData.wave_data.length}个数据点`);
                
                // 清空现有数据
                waveChart.data.datasets = [];
                waveChart.data.labels = [];
                
                // 添加数据集
                if (analysisData.wave_data && analysisData.wave_data.length > 0) {
                    const selectedColumn = analysisData.selected_column || 'voltage';
                    const color = selectedColumn === 'voltage' ? 
                        document.getElementById('voltageColor').value : 
                        document.getElementById('currentColor').value;
                    const label = selectedColumn === 'voltage' ? '电压波形 (RMS)' : '电流波形 (RMS)';
                    
                    // 准备数据
                    const chartData = analysisData.wave_data.map((point, index) => ({
                        x: index,
                        y: point.y
                    }));
                    
                    // 创建标签
                    waveChart.data.labels = analysisData.wave_data.map((point, index) => index);
                    
                    waveChart.data.datasets.push({
                        label: label,
                        data: chartData,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: parseInt(document.getElementById('lineWidthSlider').value),
                        fill: false,
                        tension: 0.1,
                        pointRadius: document.getElementById('pointsSwitch').checked ? 1 : 0
                    });
                    
                    updateDebugInfo(`传统图表数据集添加: ${label}, ${chartData.length}个点`);
                }
                
                // 更新图表
                const animationEnabled = document.getElementById('animationSwitch').checked;
                waveChart.update(animationEnabled ? 'default' : 'none');
                
                // 更新显示信息
                if (analysisData.source_rms_values) {
                    const vRms = analysisData.source_rms_values.voltage_rms || 0;
                    const iRms = analysisData.source_rms_values.current_rms || 0;
                    
                    document.getElementById('rmsInfoText').textContent = 
                        `RMS: V=${vRms.toFixed(3)}V, I=${iRms.toFixed(3)}A`;
                    document.getElementById('rmsInfoBadge').style.display = 'inline-flex';
                }
                
                document.getElementById('updateTime').textContent = 
                    `最后更新: ${new Date().toLocaleTimeString()}`;
                
                updateDebugInfo('传统图表更新完成');
                
            } catch (error) {
                updateDebugInfo(`传统图表更新错误: ${error.message}`);
                console.error('Chart update error:', error);
            }
        }

        // 更新图表线条粗细
        function updateChartLineWidth(width) {
            if (waveChart && waveChart.data.datasets) {
                waveChart.data.datasets.forEach(dataset => {
                    dataset.borderWidth = width;
                });
                waveChart.update('none');
            }
        }

        // 定期心跳检测
        setInterval(() => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000); // 每30秒发送一次心跳

        // 页面可见性变化时重新连接
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && (!websocket || websocket.readyState !== WebSocket.OPEN)) {
                updateDebugInfo('页面可见，重新连接WebSocket');
                connectWebSocket();
            }
        });

        // 🔥 调试和状态显示函数
        function getSystemStatus() {
            return {
                selectedClientId: selectedClientId,
                isMonitoring: isMonitoring,
                isConnected: isConnected,
                smoothScrollMode: smoothScrollMode,
                scrollWindowSize: scrollWindowSize,
                updateInterval: updateInterval,
                currentRMSValues: currentRMSValues,
                bufferSizes: {
                    voltage: waveformBuffer.voltage.length,
                    current: waveformBuffer.current.length,
                    timeAxis: waveformBuffer.timeAxis.length
                },
                timeOffset: timeOffset
            };
        }

        function debugSmoothScroll() {
            console.log('=== 🔍 平滑滚动调试信息 ===');
            const status = getSystemStatus();
            Object.keys(status).forEach(key => {
                console.log(`${key}:`, status[key]);
            });
            console.log('=========================');
            return status;
        }

        // 暴露调试函数到全局
        window.getSystemStatus = getSystemStatus;
        window.debugSmoothScroll = debugSmoothScroll;
        window.forceUpdateRMS = function(vRms, iRms) {
            currentRMSValues.voltage_rms = vRms || 220;
            currentRMSValues.current_rms = iRms || 10;
            updateDebugInfo(`手动设置RMS值: V=${vRms}V, I=${iRms}A`);
        };

        console.log('🚀 改进的RMS波形显示系统加载完成!');
        console.log('💡 使用 debugSmoothScroll() 查看调试信息');
        console.log('🔧 使用 forceUpdateRMS(220, 10) 手动设置RMS值进行测试');
    </script>
</body>
</html>