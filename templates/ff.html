<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>波形数据分析平台</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --light-bg: #f8f9fa;
      --sidebar-width: 60px;
      --param-width: 260px;
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--light-bg);
      color: #333;
      overflow-x: hidden;
      transform-origin: left top;
      transition: transform 0.3s ease;
    }
    
    /* 整体布局 */
    .app-container {
      display: flex;
      min-height: 100vh;
      width: 100%;
    }
    
    /* 左侧窄边栏 */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--secondary-color);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      position: relative;
      z-index: 100;
      transition: var(--transition);
      flex-shrink: 0;
    }
    
    /* 菜单按钮容器 */
    .menu-toggle-container {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: auto;
      margin-bottom: 30px;
    }
    
    .menu-toggle {
      background: var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      flex-shrink: 0;
    }
    
    .menu-toggle:hover {
      background: var(--accent-color);
    }
    
    .menu-toggle i {
      font-size: 20px;
      width: 20px;
      height: 20px;
      display: block;
    }
    
    /* 菜单选项 */
    .menu-options {
      position: absolute;
      left: 100%;
      top: 0;
      bottom: 0;
      width: 0;
      background: white;
      box-shadow: 3px 0 15px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: var(--transition);
      z-index: 99;
      opacity: 0;
      visibility: hidden;
    }
    
    .sidebar:hover .menu-options {
      width: 250px;
      opacity: 1;
      visibility: visible;
      padding: 20px 15px;
      overflow-y: auto;
    }
    
    .menu-option {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: var(--transition);
      color: var(--secondary-color);
      display: flex;
      align-items: center;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .menu-option:hover {
      background: #f1f1f1;
      padding-left: 15px;
    }
    
    /* 图标样式 */
    .menu-option i {
      margin-right: 10px;
      color: var(--primary-color);
      width: 20px;
      height: 20px;
      font-size: 18px;
      flex-shrink: 0;
      text-align: center;
    }
    
    .menu-option.active {
      background: #e8f0fe;
      border-left: 3px solid var(--primary-color);
    }
    
    /* 参数区 */
    .param-bar {
      width: var(--param-width);
      background: white;
      padding: 20px 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      position: relative;
      z-index: 90;
      transition: all 0.3s ease;
      flex-shrink: 0;
      
      /* 设置固定高度和滚动 */
      height: calc(100vh - 40px); /* 减去一些边距 */
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      overflow-x: hidden;
      
      /* 自定义滚动条样式 */
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) #f1f1f1;
    }
    
    /* 添加滚动渐变提示效果 */
    .param-bar::after {
      content: '';
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(transparent, rgba(255,255,255,0.9));
      pointer-events: none;
      z-index: 10;
    }
    
    /* Webkit 浏览器滚动条样式 */
    .param-bar::-webkit-scrollbar {
      width: 8px;
    }
    
    .param-bar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .param-bar::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    
    .param-bar::-webkit-scrollbar-thumb:hover {
      background: var(--accent-color);
    }
    
    /* 参数面板标题固定在顶部 */
    .param-bar h4 {
      position: sticky;
      top: -20px;
      background: white;
      z-index: 10;
      margin: -20px -15px 20px -15px;
      padding: 20px 15px 15px 15px;
      border-bottom: 1px solid #eee;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .section-title {
      font-size: 16px;
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 8px;
      margin-top: 20px;
      margin-bottom: 15px;
      font-weight: 600;
      
      /* 让分组标题在滚动时有更好的视觉分离 */
      background: white;
      position: sticky;
      top: 0;
      z-index: 5;
      margin-left: -5px;
      margin-right: -5px;
      padding-left: 5px;
      padding-right: 5px;
    }
    
    .param-group {
      margin-bottom: 25px;
      
      /* 为每个参数组添加轻微的边框，便于滚动时识别 */
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 15px;
    }
    
    .param-group:last-child {
      border-bottom: none;
      margin-bottom: 15px; /* 减少最后一组的底部边距 */
    }
    
    /* 主内容区 */
    .main-content {
      flex: 1;
      padding: 20px;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    /* 顶部操作栏 */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    /* 图表容器 */
    .chart-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
      flex: 1 1 auto;
      min-height: 300px;
      position: relative;
      width: 100%;
      min-width: 0;
    }
    
    .chart-container canvas {
      width: 100% !important;
      min-height: 250px;
      height: auto !important;
      max-height: 550px;
    }
    
    .stats-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      padding: 20px;
      flex-shrink: 0;
    }
    
    /* 统计卡片 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: linear-gradient(to bottom, #f1f5fd, #ffffff);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #e1e5f1;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      min-width: 140px;
    }
    
    .stat-card:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--primary-color);
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .stat-title {
      color: var(--secondary-color);
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .stat-title i {
      margin-right: 6px;
      color: #5c7cfa;
      font-size: 14px;
      min-width: 18px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    /* 按钮样式 */
    .btn-primary {
      background: var(--primary-color);
      border: none;
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      transition: var(--transition);
    }
    
    .btn-primary:hover {
      background: #2980b9;
    }
    
    /* 缩放控制 */
    .zoom-controls {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .zoom-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #3498db;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .zoom-btn:hover {
      background: #2980b9;
    }
    
    .zoom-btn:first-child {
      border-bottom: 1px solid rgba(255,255,255,0.3);
    }
    
    .zoom-btn i {
      font-size: 18px;
    }
    
    /* 图表标题区域 */
    .chart-title {
      margin-bottom: 15px;
      font-weight: 500;
      color: var(--secondary-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    /* 错误信息 */
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #f1aeb5;
    }
    
    /* 成功信息 */
    .success-message {
      background: #d1edff;
      color: #0c5460;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #bee5eb;
    }
    
    /* 响应式设计 */
    @media (max-width: 1200px) {
      .app-container {
        flex-wrap: wrap;
      }
      
      .sidebar {
        width: 100%;
        height: 60px;
        flex-direction: row;
        justify-content: space-between;
        padding: 0 20px;
        position: fixed;
        top: 0;
        z-index: 1000;
      }
      
      .menu-toggle-container {
        margin: 0;
        order: 1;
      }
      
      .sidebar .menu-options {
        left: 0;
        top: 100%;
        width: 100%;
        max-height: 0;
        padding: 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      
      .sidebar:hover .menu-options {
        max-height: 400px;
        padding: 10px;
        width: 100%;
      }
      
      .param-bar {
        width: 100%;
        height: auto;
        max-height: 50vh; /* 移动端限制高度为视口的一半 */
        overflow-y: auto;
        overflow-x: hidden;
        transition: max-height 0.3s ease;
        position: fixed;
        top: 60px;
        z-index: 999;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        
        /* 移动端默认隐藏 */
        max-height: 0;
        padding: 0 15px;
      }
      
      .param-bar.active {
        max-height: 50vh;
        padding: 20px 15px;
        overflow-y: auto;
      }
      
      /* 移动端参数面板标题调整 */
      .param-bar h4 {
        position: static;
        margin: 0 0 20px 0;
        padding: 0;
        border-bottom: 2px solid var(--primary-color);
      }
      
      /* 移动端滚动提示更明显 */
      .param-bar h4 small {
        display: inline-block;
        background: var(--primary-color);
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.7em;
      }
      
      .param-bar::after {
        height: 15px; /* 移动端渐变高度稍微减少 */
      }
      
      .main-content {
        width: 100%;
        padding-top: 90px;
      }
      
      .mobile-controls {
        display: flex;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        background: white;
        height: 50px;
        justify-content: center;
        align-items: center;
        gap: 20px;
        z-index: 900;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
    }
    
    @media (max-width: 768px) {
      .stat-card {
        padding: 12px;
      }
      
      .stat-value {
        font-size: 18px;
      }
      
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .top-bar > div {
        width: 100%;
      }
      
      .top-bar .btn-group {
        width: 100%;
        display: flex;
        gap: 10px;
      }
      
      .top-bar .btn {
        flex: 1;
      }
      
      /* 小屏幕时参数面板高度进一步限制 */
      .param-bar {
        max-height: 40vh;
      }
      
      .param-bar.active {
        max-height: 40vh;
      }
    }
    
    /* 中等屏幕尺寸优化 */
    @media (min-width: 769px) and (max-width: 1199px) {
      .param-bar {
        height: calc(100vh - 60px);
        max-height: calc(100vh - 60px);
      }
    }
    
    /* 移动端控制按钮 */
    .mobile-controls {
      display: none;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- 缩放控制按钮 -->
  <div class="zoom-controls">
    <div class="zoom-btn" id="zoomIn">
      <i class="fas fa-plus"></i>
    </div>
    <div class="zoom-btn" id="zoomOut">
      <i class="fas fa-minus"></i>
    </div>
  </div>
  
  <!-- 移动端控制按钮 -->
  <div class="mobile-controls">
    <button class="btn btn-outline-primary" id="paramsBtn">
      <i class="fas fa-sliders-h me-1"></i> 参数面板
    </button>
  </div>
  
  <div class="app-container">
    <!-- 左侧边栏 -->
    <div class="sidebar">
      <div class="menu-toggle-container">
        <div class="menu-toggle">
          <i class="fas fa-bars"></i>
        </div>
      </div>
      <div class="menu-options">
        <div class="menu-option active">
          <i class="fas fa-chart-line"></i> 波形分析
        </div>
        <div class="menu-option">
          <i class="fas fa-cog"></i> 系统设置
        </div>
        <div class="menu-option">
          <i class="fas fa-file-csv"></i> 数据格式
        </div>
        <div class="menu-option">
          <i class="fas fa-database"></i> 数据源管理
        </div>
        <div class="menu-option">
          <i class="fas fa-users"></i> 用户设置
        </div>
        <div class="menu-option">
          <i class="fas fa-history"></i> 历史记录
        </div>
        <div class="menu-option">
          <i class="fas fa-info-circle"></i> 帮助中心
        </div>
      </div>
    </div>
    
    <!-- 参数调整区域 -->
    <div class="param-bar">
      <h4 class="mb-4" style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
        <i class="fas fa-cog me-2"></i>数据分析参数
        <small class="float-end text-muted" style="font-size: 0.75em; font-weight: normal;">
          
        </small>
      </h4>
      
      <form id="analysisForm" method="post">
        <div class="param-group">
          <div class="section-title">数据源配置</div>
          <div class="mb-3">
            <label class="form-label">选择数据格式</label>
            <select class="form-select" name="data_format" id="dataFormat">
              <option value="csv">CSV (逗号分隔)</option>
              <option value="json">JSON (结构化数据)</option>
              <option value="excel">Excel (xlsx/xls)</option>
              <option value="txt">文本 (TXT)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">编码方式</label>
            <select class="form-select" name="encoding">
              <option value="utf-8">UTF-8</option>
              <option value="gb2312">GB2312</option>
              <option value="iso-8859-1">ISO-8859-1</option>
            </select>
          </div>
          
          <!-- 文件上传区域 -->
          <div class="mb-3">
            <label class="form-label">上传数据文件</label>
            <input type="file" class="form-control" id="fileUpload" accept=".csv,.json,.xlsx,.xls,.txt">
            {% if uploaded_files %}
            <select class="form-select mt-2" id="existingFiles">
              <option value="">选择已上传的文件</option>
              {% for file in uploaded_files %}
              <option value="{{ file }}" {% if filename == file %}selected{% endif %}>{{ file }}</option>
              {% endfor %}
            </select>
            {% endif %}
            
            <!-- 当前选择的文件显示 -->
            <div class="mt-2" id="currentFileDisplay">
              {% if filename %}
              <div class="alert alert-info py-2">
                <i class="fas fa-file me-2"></i>
                <strong>当前文件:</strong> {{ filename }}
              </div>
              {% else %}
              <div class="alert alert-warning py-2">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>未选择文件</strong> - 请上传或选择已有文件
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <div class="param-group">
          <div class="section-title">分析模型选择</div>
          
          <!-- 列选择功能 -->
          <div class="mb-3" id="columnSelectGroup" style="display: none;">
            <label class="form-label">选择分析列</label>
            <select class="form-select" name="selected_column" id="columnSelect">
              <option value="">请先上传文件</option>
            </select>
            <small class="form-text text-muted">选择要分析的数据列</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">波形分析模型</label>
            <select class="form-select" name="model" id="analysisModel">
              <option value="time_domain" selected>时域分析模型</option>
              <option value="freq_domain">频域分析模型</option>
              <option value="fourier">傅里叶变换分析</option>
              <option value="wavelet">小波变换模型</option>
              <option value="neural">神经网络模型</option>
            </select>
          </div>
          
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="filterSwitch" name="enable_filter" checked>
            <label class="form-check-label" for="filterSwitch">启用降噪过滤</label>
          </div>
        </div>
        
        <div class="param-group">
          <div class="section-title">可视化设置</div>
          
          <!-- 快速预设 -->
          <div class="mb-3">
            <label class="form-label">快速主题</label>
            <div class="btn-group w-100" role="group">
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="applyTheme('default')">默认</button>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="applyTheme('dark')">暗色</button>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="applyTheme('minimal')">简约</button>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="applyTheme('classic')">经典</button>
            </div>
            <small class="form-text text-muted">选择预设主题或自定义设置</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">波形颜色</label>
            <input type="color" class="form-control form-control-color" name="wave_color" id="waveColor" value="#3498db">
            <small class="form-text text-muted">选择波形线条颜色</small>
          </div>
          <div class="mb-3">
            <label class="form-label">背景网格</label>
            <select class="form-select" name="grid_type" id="gridType">
              <option value="show_grid" selected>显示网格</option>
              <option value="horizontal">仅水平线</option>
              <option value="vertical">仅垂直线</option>
              <option value="none">不显示网格</option>
            </select>
            <small class="form-text text-muted">选择图表网格显示方式</small>
          </div>
          <div class="mb-3">
            <label class="form-label">波形粗细: <span id="lineWidthValue">2</span>px</label>
            <input type="range" class="form-range" name="line_width" min="1" max="8" value="2" id="lineWidthSlider">
            <small class="form-text text-muted">调整波形线条粗细</small>
          </div>
          <div class="mb-3">
            <label class="form-label">图表背景色</label>
            <input type="color" class="form-control form-control-color" name="bg_color" id="bgColor" value="#ffffff">
            <small class="form-text text-muted">选择图表背景颜色</small>
          </div>
          <div class="mb-3">
            <label class="form-label">网格透明度: <span id="gridOpacityValue">20</span>%</label>
            <input type="range" class="form-range" name="grid_opacity" min="0" max="100" value="20" id="gridOpacitySlider">
            <small class="form-text text-muted">调整网格线透明度</small>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="animationSwitch" name="enable_animation" checked>
            <label class="form-check-label" for="animationSwitch">启用动画效果</label>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="pointsSwitch" name="show_points">
            <label class="form-check-label" for="pointsSwitch">显示数据点</label>
          </div>
        </div>
        
        <div class="param-group">
          <div class="section-title">高级参数</div>
          <div class="mb-3">
            <label class="form-label">平滑度: <span id="smoothingValue">0.1</span></label>
            <input type="range" class="form-range" name="smoothing" min="0" max="1" step="0.1" value="0.1" id="smoothingSlider">
          </div>
          <div class="mb-3">
            <label class="form-label">阈值: <span id="thresholdValue">0.5</span></label>
            <input type="range" class="form-range" name="threshold" min="0" max="1" step="0.1" value="0.5" id="thresholdSlider">
          </div>
          <div class="mb-3">
            <label class="form-label">窗口大小</label>
            <input type="number" class="form-control" name="window_size" value="10" min="1" max="100">
          </div>
        </div>
        
        <button type="button" class="btn btn-primary" id="analyzeBtn">
          <i class="fas fa-play me-2"></i><span id="analyzeBtnText">开始分析</span>
        </button>
        <button type="button" class="btn btn-outline-primary mt-2" id="resetBtn">
          <i class="fas fa-redo me-2"></i>重置参数
        </button>
      </form>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
      <div class="top-bar">
        <div>
          <h2 class="mb-0"><i class="fas fa-wave-square me-2" style="color: var(--primary-color);"></i>波形分析平台</h2>
          <p class="text-muted mb-0">上传CSV文件进行波形分析和数据统计</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" id="importBtn">
            <i class="fas fa-file-import me-2"></i>导入数据
          </button>
          <button class="btn btn-success" id="exportBtn">
            <i class="fas fa-file-export me-2"></i>导出报告
          </button>
        </div>
      </div>
      
      <!-- 消息显示区域 -->
      {% if error %}
      <div class="error-message">
        <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
      </div>
      {% endif %}
      
      {% if success %}
      <div class="success-message">
        <i class="fas fa-check-circle me-2"></i>{{ success }}
      </div>
      {% endif %}
      
      <!-- 波形显示区域 -->
      <div class="chart-container">
        <div class="chart-title">
          <span><i class="fas fa-chart-line me-2"></i>
            {% if filename %}{{ filename }} - {% endif %}电压信号波形 (V)
          </span>
          <span class="text-muted">更新时间: {{ update_time or "未更新" }}</span>
        </div>
        <canvas id="waveChart"></canvas>
      </div>
      
      <!-- 统计信息区域 -->
      <div class="stats-container">
        <h5 class="mb-3"><i class="fas fa-calculator me-2"></i>数据统计信息</h5>
        <div class="stats-grid" id="statsGrid">
          <!-- 统计卡片将通过JavaScript动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let currentScale = 1;
    let waveChart = null;
    let waveData = {{ wave_data | tojson if wave_data else "[]" }};
    let statistics = {{ stats | tojson if stats else "{}" }};
    let currentFilename = "{{ filename or '' }}";
    
    // 更新当前文件显示
    function updateCurrentFileDisplay() {
      const displayElement = document.getElementById('currentFileDisplay');
      if (displayElement) {
        if (currentFilename && currentFilename.trim() !== '') {
          displayElement.innerHTML = `
            <div class="alert alert-info py-2">
              <i class="fas fa-file me-2"></i>
              <strong>当前文件:</strong> ${currentFilename}
            </div>
          `;
        } else {
          displayElement.innerHTML = `
            <div class="alert alert-warning py-2">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>未选择文件</strong> - 请上传或选择已有文件
            </div>
          `;
        }
      }
    }
    
    // 更新当前文件名
    function updateCurrentFilename(filename) {
      currentFilename = filename;
      console.log('Current filename updated to:', currentFilename);
      updateCurrentFileDisplay();  // 更新显示
    }
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化功能
      initChart();
      setupEventListeners();
      setupMobileControls();
      setupZoomControls();
      updateStatistics();
      updateCurrentFileDisplay();  // 新增：更新当前文件显示
      
      // 监听窗口调整
      window.addEventListener('resize', handleResize);
      
      // 如果有数据，立即显示
      if (waveData && waveData.length > 0) {
        updateChart(waveData);
      }
      
      // 调试输出
      console.log('Page loaded with filename:', currentFilename);
      
      // 如果模板没有提供文件名，尝试从已选择的文件中获取
      if (!currentFilename || currentFilename.trim() === '') {
        const existingFilesSelect = document.getElementById('existingFiles');
        if (existingFilesSelect && existingFilesSelect.value) {
          updateCurrentFilename(existingFilesSelect.value);
        }
      }
    });
    
    // 初始化图表
    function initChart() {
      const ctx = document.getElementById('waveChart').getContext('2d');
      
      // 获取初始可视化设置
      const waveColor = document.getElementById('waveColor')?.value || '#3498db';
      const lineWidth = parseInt(document.getElementById('lineWidthSlider')?.value || 2);
      const enableAnimation = document.getElementById('animationSwitch')?.checked !== false;
      const showPoints = document.getElementById('pointsSwitch')?.checked || false;
      
      waveChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: '电压信号 (V)',
            data: waveData,
            borderColor: waveColor,
            borderWidth: lineWidth,
            pointRadius: showPoints ? 2 : 0,
            pointBackgroundColor: waveColor,
            pointBorderColor: waveColor,
            tension: 0.3,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'linear',
              title: {
                display: true,
                text: '时间 (ms)',
                font: {
                  size: 13,
                  weight: 'bold'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.2)',
                display: true
              }
            },
            y: {
              title: {
                display: true,
                text: '电压 (V)',
                font: {
                  size: 13,
                  weight: 'bold'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.2)',
                display: true
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  size: 13
                },
                color: '#333'
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: waveColor,
              borderWidth: 1
            }
          },
          animation: {
            duration: enableAnimation ? 1000 : 0
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
      
      // 应用初始可视化设置
      setTimeout(() => {
        applyCurrentVisualSettings();
      }, 100);
    }
    
    // 设置事件监听器
    function setupEventListeners() {
      // 文件上传
      const fileUpload = document.getElementById('fileUpload');
      const existingFiles = document.getElementById('existingFiles');
      
      if (fileUpload) {
        fileUpload.addEventListener('change', handleFileUpload);
      }
      
      if (existingFiles) {
        existingFiles.addEventListener('change', handleExistingFileSelect);
        // 如果页面加载时已经选中了文件，更新currentFilename
        if (existingFiles.value) {
          updateCurrentFilename(existingFiles.value);
        }
      }
      
      // 列选择变化
      const columnSelect = document.getElementById('columnSelect');
      if (columnSelect) {
        columnSelect.addEventListener('change', handleColumnChange);
      }
      
      // 分析按钮
      const analyzeBtn = document.getElementById('analyzeBtn');
      analyzeBtn.addEventListener('click', handleAnalyze);
      
      // 重置按钮
      const resetBtn = document.getElementById('resetBtn');
      resetBtn.addEventListener('click', handleReset);
      
      // 导入按钮
      const importBtn = document.getElementById('importBtn');
      importBtn.addEventListener('click', () => fileUpload.click());
      
      // 导出按钮
      const exportBtn = document.getElementById('exportBtn');
      exportBtn.addEventListener('click', handleExport);
      
      // 参数滑块
      setupSliders();
      
      // 菜单选项
      setupMenuOptions();
    }
    
    // 处理列选择变化
    async function handleColumnChange(event) {
      const selectedColumn = event.target.value;
      
      if (!selectedColumn || !currentFilename) {
        return;
      }
      
      console.log('Column changed to:', selectedColumn);
      
      // 使用选择的列重新分析
      const form = document.getElementById('analysisForm');
      const formData = new FormData(form);
      formData.append('filename', currentFilename);
      formData.append('selected_column', selectedColumn);
      
      showLoading();
      
      try {
        const response = await fetch('/api/wave_analyze_json', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          // 更新页面内容而不刷新
          updatePageWithData(result.data);
          showSuccess(`已切换到分析列: ${selectedColumn}`);
        } else {
          showError(result.message);
        }
      } catch (error) {
        showError('列切换过程中发生错误: ' + error.message);
      } finally {
        hideLoading();
      }
    }
    
    // 设置滑块和可视化控件
    function setupSliders() {
      const sliders = [
        { id: 'lineWidthSlider', valueId: 'lineWidthValue', suffix: 'px' },
        { id: 'smoothingSlider', valueId: 'smoothingValue', suffix: '' },
        { id: 'thresholdSlider', valueId: 'thresholdValue', suffix: '' },
        { id: 'gridOpacitySlider', valueId: 'gridOpacityValue', suffix: '%' }
      ];
      
      sliders.forEach(slider => {
        const element = document.getElementById(slider.id);
        const valueElement = document.getElementById(slider.valueId);
        
        if (element && valueElement) {
          element.addEventListener('input', function() {
            valueElement.textContent = this.value;
            // 实时更新图表可视化
            updateChartVisuals();
          });
        }
      });
      
      // 设置颜色选择器
      const colorInputs = ['waveColor', 'bgColor'];
      colorInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
          element.addEventListener('change', updateChartVisuals);
        }
      });
      
      // 设置网格类型选择
      const gridType = document.getElementById('gridType');
      if (gridType) {
        gridType.addEventListener('change', updateChartVisuals);
      }
      
      // 设置开关
      const switches = ['animationSwitch', 'pointsSwitch'];
      switches.forEach(switchId => {
        const element = document.getElementById(switchId);
        if (element) {
          element.addEventListener('change', updateChartVisuals);
        }
      });
    }
    
    // 实时更新图表可视化效果
    function updateChartVisuals() {
      if (!waveChart) return;
      
      // 获取当前设置
      const waveColor = document.getElementById('waveColor')?.value || '#3498db';
      const bgColor = document.getElementById('bgColor')?.value || '#ffffff';
      const lineWidth = parseInt(document.getElementById('lineWidthSlider')?.value || 2);
      const gridType = document.getElementById('gridType')?.value || 'show_grid';
      const gridOpacity = parseInt(document.getElementById('gridOpacitySlider')?.value || 20) / 100;
      const enableAnimation = document.getElementById('animationSwitch')?.checked || false;
      const showPoints = document.getElementById('pointsSwitch')?.checked || false;
      
      // 更新波形样式
      waveChart.data.datasets[0].borderColor = waveColor;
      waveChart.data.datasets[0].borderWidth = lineWidth;
      waveChart.data.datasets[0].pointRadius = showPoints ? 2 : 0;
      waveChart.data.datasets[0].pointBackgroundColor = waveColor;
      waveChart.data.datasets[0].pointBorderColor = waveColor;
      
      // 更新背景色
      waveChart.options.plugins.legend.labels.color = getContrastColor(bgColor);
      
      // 更新网格设置
      const gridColor = `rgba(0, 0, 0, ${gridOpacity})`;
      
      switch (gridType) {
        case 'show_grid':
          waveChart.options.scales.x.grid.display = true;
          waveChart.options.scales.y.grid.display = true;
          break;
        case 'horizontal':
          waveChart.options.scales.x.grid.display = false;
          waveChart.options.scales.y.grid.display = true;
          break;
        case 'vertical':
          waveChart.options.scales.x.grid.display = true;
          waveChart.options.scales.y.grid.display = false;
          break;
        case 'none':
          waveChart.options.scales.x.grid.display = false;
          waveChart.options.scales.y.grid.display = false;
          break;
      }
      
      waveChart.options.scales.x.grid.color = gridColor;
      waveChart.options.scales.y.grid.color = gridColor;
      
      // 更新动画设置
      waveChart.options.animation.duration = enableAnimation ? 750 : 0;
      
      // 更新图表容器背景色
      const chartContainer = document.querySelector('.chart-container');
      if (chartContainer) {
        chartContainer.style.backgroundColor = bgColor;
      }
      
      // 应用更改
      waveChart.update('none'); // 使用 'none' 模式避免动画冲突
      
      console.log('Chart visuals updated:', {
        waveColor, bgColor, lineWidth, gridType, gridOpacity, enableAnimation, showPoints
      });
    }
    
    // 获取对比色（用于文字颜色）
    function getContrastColor(hexColor) {
      // 将十六进制转换为RGB
      const r = parseInt(hexColor.slice(1, 3), 16);
      const g = parseInt(hexColor.slice(3, 5), 16);
      const b = parseInt(hexColor.slice(5, 7), 16);
      
      // 计算亮度
      const brightness = (r * 299 + g * 587 + b * 114) / 1000;
      
      // 返回对比色
      return brightness > 128 ? '#000000' : '#ffffff';
    }
    
    // 应用主题预设
    function applyTheme(themeName) {
      const themes = {
        default: {
          waveColor: '#3498db',
          bgColor: '#ffffff',
          lineWidth: 2,
          gridType: 'show_grid',
          gridOpacity: 20,
          enableAnimation: true,
          showPoints: false
        },
        dark: {
          waveColor: '#00ff88',
          bgColor: '#1a1a1a',
          lineWidth: 2,
          gridType: 'show_grid',
          gridOpacity: 30,
          enableAnimation: true,
          showPoints: false
        },
        minimal: {
          waveColor: '#666666',
          bgColor: '#fafafa',
          lineWidth: 1,
          gridType: 'none',
          gridOpacity: 0,
          enableAnimation: false,
          showPoints: false
        },
        classic: {
          waveColor: '#e74c3c',
          bgColor: '#f8f9fa',
          lineWidth: 3,
          gridType: 'show_grid',
          gridOpacity: 15,
          enableAnimation: true,
          showPoints: true
        }
      };
      
      const theme = themes[themeName];
      if (!theme) return;
      
      // 应用主题设置
      const waveColorInput = document.getElementById('waveColor');
      const bgColorInput = document.getElementById('bgColor');
      const lineWidthSlider = document.getElementById('lineWidthSlider');
      const gridTypeSelect = document.getElementById('gridType');
      const gridOpacitySlider = document.getElementById('gridOpacitySlider');
      const animationSwitch = document.getElementById('animationSwitch');
      const pointsSwitch = document.getElementById('pointsSwitch');
      
      if (waveColorInput) waveColorInput.value = theme.waveColor;
      if (bgColorInput) bgColorInput.value = theme.bgColor;
      if (lineWidthSlider) {
        lineWidthSlider.value = theme.lineWidth;
        document.getElementById('lineWidthValue').textContent = theme.lineWidth;
      }
      if (gridTypeSelect) gridTypeSelect.value = theme.gridType;
      if (gridOpacitySlider) {
        gridOpacitySlider.value = theme.gridOpacity;
        document.getElementById('gridOpacityValue').textContent = theme.gridOpacity;
      }
      if (animationSwitch) animationSwitch.checked = theme.enableAnimation;
      if (pointsSwitch) pointsSwitch.checked = theme.showPoints;
      
      // 立即应用可视化更改
      updateChartVisuals();
      
      showSuccess(`已应用 ${themeName === 'default' ? '默认' : themeName === 'dark' ? '暗色' : themeName === 'minimal' ? '简约' : '经典'} 主题`);
      
      console.log('Applied theme:', themeName, theme);
    }
    
    // 文件上传处理
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('file', file);
      
      showLoading();
      
      try {
        const response = await fetch('/api/wave_upload_json', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          // 更新页面内容而不刷新
          updatePageWithData(result.data);
          showSuccess(result.message);
          
          // 清空文件输入框，允许重新选择同一文件
          event.target.value = '';
        } else {
          showError(result.message);
        }
      } catch (error) {
        showError('上传过程中发生错误: ' + error.message);
      } finally {
        hideLoading();
      }
    }
    
    // 选择已有文件
    async function handleExistingFileSelect(event) {
      const filename = event.target.value;
      if (!filename) {
        updateCurrentFilename('');
        return;
      }
      
      const formData = new FormData();
      formData.append('filename', filename);
      
      showLoading();
      
      try {
        const response = await fetch('/api/wave_upload_json', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          // 更新页面内容而不刷新
          updatePageWithData(result.data);
          showSuccess(result.message);
        } else {
          showError(result.message);
        }
      } catch (error) {
        showError('加载过程中发生错误: ' + error.message);
      } finally {
        hideLoading();
      }
    }
    
    // 分析处理
    async function handleAnalyze() {
      console.log('Current filename for analysis:', currentFilename);
      
      if (!currentFilename || currentFilename.trim() === '') {
        showError('请先上传或选择文件');
        return;
      }
      
      const form = document.getElementById('analysisForm');
      const formData = new FormData(form);
      formData.append('filename', currentFilename);
      
      showLoading();
      
      try {
        const response = await fetch('/api/wave_analyze_json', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          // 更新页面内容而不刷新
          updatePageWithData(result.data);
          showSuccess(result.message);
        } else {
          showError(result.message);
        }
      } catch (error) {
        showError('分析过程中发生错误: ' + error.message);
      } finally {
        hideLoading();
      }
    }
    
    // 更新页面内容的函数
    function updatePageWithData(data) {
      // 更新全局变量
      currentFilename = data.filename;
      waveData = data.wave_data || [];
      statistics = data.stats || {};
      
      // 更新文件名显示
      updateCurrentFileDisplay();
      
      // 更新列选择下拉框 - 使用数值列
      const columnsToShow = data.numeric_columns || data.columns || [];
      updateColumnSelect(columnsToShow, data.selected_column);
      
      // 如果有多列数据，自动滚动到列选择区域
      if (columnsToShow.length > 1) {
        scrollToColumnSelect();
      }
      
      // 更新图表标题
      updateChartTitle(data.filename, data.selected_column);
      
      // 更新时间
      const updateTime = document.querySelector('.chart-title .text-muted');
      if (updateTime) {
        updateTime.textContent = `更新时间: ${data.update_time}`;
      }
      
      // 更新波形图表
      if (waveData && waveData.length > 0) {
        updateChart(waveData, data.selected_column);
      }
      
      // 更新统计信息
      updateStatistics();
      
      // 更新文件选择下拉框（如果有新文件）
      if (data.uploaded_files) {
        updateFilesList(data.uploaded_files);
      }
      
      console.log('Page updated with new data for:', data.filename, 'column:', data.selected_column);
    }
    
    // 自动滚动到列选择区域
    function scrollToColumnSelect() {
      const columnSelectGroup = document.getElementById('columnSelectGroup');
      if (columnSelectGroup && columnSelectGroup.style.display !== 'none') {
        // 延迟执行，确保DOM已更新
        setTimeout(() => {
          columnSelectGroup.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }, 300);
      }
    }
    
    // 滚动到指定参数组
    function scrollToParamGroup(groupSelector) {
      const element = document.querySelector(groupSelector);
      if (element) {
        element.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }
    
    // 更新列选择下拉框
    function updateColumnSelect(columns, selectedColumn) {
      const columnSelect = document.getElementById('columnSelect');
      const columnSelectGroup = document.getElementById('columnSelectGroup');
      
      if (columnSelect && columns && columns.length > 1) {
        // 当有多个数值列时才显示选择区域
        columnSelectGroup.style.display = 'block';
        
        // 清空并重新填充列选项
        columnSelect.innerHTML = '';
        
        // 添加所有数值列
        columns.forEach(column => {
          const option = document.createElement('option');
          option.value = column;
          option.textContent = column;
          if (column === selectedColumn) {
            option.selected = true;
          }
          columnSelect.appendChild(option);
        });
        
        console.log('Updated column select with', columns.length, 'numeric columns, selected:', selectedColumn);
      } else {
        // 只有一列或没有列时隐藏选择区域
        columnSelectGroup.style.display = 'none';
        console.log('Column select hidden - only', columns?.length || 0, 'columns available');
      }
    }
    
    // 更新图表标题
    function updateChartTitle(filename, columnName) {
      const chartTitle = document.querySelector('.chart-title span');
      if (chartTitle) {
        const displayName = columnName || '信号';
        chartTitle.innerHTML = `<i class="fas fa-chart-line me-2"></i>${filename} - ${displayName} 波形`;
      }
    }
    
    // 更新文件列表
    function updateFilesList(files) {
      const existingFiles = document.getElementById('existingFiles');
      if (existingFiles) {
        // 保存当前选中的值
        const currentValue = existingFiles.value;
        
        // 清空并重新填充选项
        existingFiles.innerHTML = '<option value="">选择已上传的文件</option>';
        
        files.forEach(file => {
          const option = document.createElement('option');
          option.value = file;
          option.textContent = file;
          if (file === currentFilename) {
            option.selected = true;
          }
          existingFiles.appendChild(option);
        });
      }
    }
    
    // 重置参数
    function handleReset() {
      document.getElementById('analysisForm').reset();
      
      // 重置滑块显示值
      document.getElementById('lineWidthValue').textContent = '2';
      document.getElementById('smoothingValue').textContent = '0.1';
      document.getElementById('thresholdValue').textContent = '0.5';
      document.getElementById('gridOpacityValue').textContent = '20';
      
      // 重置可视化设置到默认值
      const waveColorInput = document.getElementById('waveColor');
      const bgColorInput = document.getElementById('bgColor');
      const lineWidthSlider = document.getElementById('lineWidthSlider');
      const gridTypeSelect = document.getElementById('gridType');
      const gridOpacitySlider = document.getElementById('gridOpacitySlider');
      const animationSwitch = document.getElementById('animationSwitch');
      const pointsSwitch = document.getElementById('pointsSwitch');
      
      if (waveColorInput) waveColorInput.value = '#3498db';
      if (bgColorInput) bgColorInput.value = '#ffffff';
      if (lineWidthSlider) lineWidthSlider.value = '2';
      if (gridTypeSelect) gridTypeSelect.value = 'show_grid';
      if (gridOpacitySlider) gridOpacitySlider.value = '20';
      if (animationSwitch) animationSwitch.checked = true;
      if (pointsSwitch) pointsSwitch.checked = false;
      
      // 应用重置后的可视化设置
      setTimeout(() => {
        updateChartVisuals();
      }, 100);
      
      showSuccess('参数已重置为默认值');
    }
    
    // 导出报告
    async function handleExport() {
      if (!currentFilename) {
        showError('没有可导出的数据');
        return;
      }
      
      showLoading();
      
      try {
        const response = await fetch('/export_report', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            filename: currentFilename,
            statistics: statistics,
            wave_data: waveData
          })
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'waveform_report.pdf';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } else {
          showError('导出失败');
        }
      } catch (error) {
        showError('导出过程中发生错误: ' + error.message);
      } finally {
        hideLoading();
      }
    }
    
    // 更新图表
    function updateChart(data) {
      if (waveChart && data && data.length > 0) {
        console.log('Updating chart with', data.length, 'data points');
        
        // 确保数据格式正确
        const chartData = data.map(point => ({
          x: parseFloat(point.x),
          y: parseFloat(point.y)
        }));
        
        waveChart.data.datasets[0].data = chartData;
        waveChart.update('active');
        
        console.log('Chart updated successfully');
      } else {
        console.log('No data to update chart with');
      }
    }
    
    // 更新统计信息
    function updateStatistics() {
      const statsGrid = document.getElementById('statsGrid');
      if (!statsGrid || !statistics) return;
      
      statsGrid.innerHTML = '';
      
      Object.entries(statistics).forEach(([key, stat]) => {
        if (stat && typeof stat === 'object') {
          const card = document.createElement('div');
          card.className = 'stat-card';
          card.innerHTML = `
            <div class="stat-title">
              <i class="${stat.icon || 'fas fa-chart-bar'}"></i>
              ${stat.title || key}
            </div>
            <div class="stat-value">
              ${stat.value || '0'} 
              ${stat.unit ? `<span>${stat.unit}</span>` : ''}
            </div>
          `;
          statsGrid.appendChild(card);
        }
      });
    }
    
    // 显示加载状态
    function showLoading() {
      const btn = document.getElementById('analyzeBtn');
      const btnText = document.getElementById('analyzeBtnText');
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading-spinner"></span> 处理中...';
    }
    
    // 隐藏加载状态
    function hideLoading() {
      const btn = document.getElementById('analyzeBtn');
      const btnText = document.getElementById('analyzeBtnText');
      btn.disabled = false;
      btnText.textContent = '开始分析';
    }
    
    // 显示成功信息
    function showSuccess(message) {
      // 移除现有的消息
      removeMessages();
      
      // 创建成功消息
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
      
      // 插入到主内容区的顶部
      const mainContent = document.querySelector('.main-content');
      const topBar = document.querySelector('.top-bar');
      mainContent.insertBefore(successDiv, topBar.nextSibling);
      
      // 3秒后自动移除
      setTimeout(() => {
        if (successDiv.parentNode) {
          successDiv.parentNode.removeChild(successDiv);
        }
      }, 3000);
    }
    
    // 显示错误信息
    function showError(message) {
      // 移除现有的消息
      removeMessages();
      
      // 创建错误消息
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
      
      // 插入到主内容区的顶部
      const mainContent = document.querySelector('.main-content');
      const topBar = document.querySelector('.top-bar');
      mainContent.insertBefore(errorDiv, topBar.nextSibling);
      
      // 5秒后自动移除
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.parentNode.removeChild(errorDiv);
        }
      }, 5000);
    }
    
    // 移除现有消息
    function removeMessages() {
      const existingMessages = document.querySelectorAll('.success-message, .error-message');
      existingMessages.forEach(msg => {
        if (msg.parentNode) {
          msg.parentNode.removeChild(msg);
        }
      });
    }
    
    // 设置菜单选项功能
    function setupMenuOptions() {
      const menuOptions = document.querySelectorAll('.menu-option');
      menuOptions.forEach(option => {
        option.addEventListener('click', function() {
          menuOptions.forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }
    
    // 移动端控制功能
    function setupMobileControls() {
      const paramBar = document.querySelector('.param-bar');
      const paramsBtn = document.getElementById('paramsBtn');
      
      if (paramsBtn) {
        paramsBtn.addEventListener('click', function() {
          paramBar.classList.toggle('active');
        });
      }
      
      if (window.innerWidth <= 1200) {
        document.querySelector('.mobile-controls').style.display = 'flex';
      }
    }
    
    // 设置缩放控制
    function setupZoomControls() {
      const zoomInBtn = document.getElementById('zoomIn');
      const zoomOutBtn = document.getElementById('zoomOut');
      
      zoomInBtn.addEventListener('click', function() {
        zoomChart(0.1);
      });
      
      zoomOutBtn.addEventListener('click', function() {
        zoomChart(-0.1);
      });
    }
    
    // 缩放控制函数
    function zoomChart(change) {
      const newScale = Math.max(0.5, Math.min(1.5, currentScale + change));
      
      document.body.style.transform = `scale(${newScale})`;
      document.body.style.width = `${100 / newScale}%`;
      
      currentScale = newScale;
      
      if (waveChart) {
        waveChart.resize();
      }
    }
    
    // 处理窗口调整
    function handleResize() {
      if (window.innerWidth <= 1200) {
        document.querySelector('.mobile-controls').style.display = 'flex';
      } else {
        document.querySelector('.mobile-controls').style.display = 'none';
        document.querySelector('.param-bar').classList.remove('active');
      }
      
      if (waveChart) {
        waveChart.resize();
      }
    }
  </script>
</body>
</html>