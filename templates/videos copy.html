<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 基础样式 - 微信风格 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f7f7f7;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* 导航栏 - 简洁设计 */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: #fff;
            border-bottom: 1px solid #e6e6e6;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            text-decoration: none;
        }

        .logo i {
            font-size: 20px;
            color: #07c160;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 24px;
        }

        .nav-links a {
            color: #666;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: #07c160;
            background-color: #f0f9f0;
        }

        /* 主容器 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 76px 20px 20px;
        }

        /* 页面标题 */
        .page-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .page-header p {
            color: #999;
            font-size: 14px;
        }

        /* 预加载指示器 */
        .preload-indicator {
            position: fixed;
            top: 76px;
            left: 20px;
            background: rgba(7, 193, 96, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1500;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .preload-indicator.show {
            transform: translateY(0);
            opacity: 1;
        }

        .preload-indicator i {
            font-size: 12px;
            animation: spin 1s linear infinite;
        }

        /* 视频库头部 */
        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .library-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            background: #f8f8f8;
            color: #666;
            border: 1px solid #e6e6e6;
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .action-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* 设置按钮 */
        .settings-btn {
            background: #07c160;
            color: white;
            border: 1px solid #07c160;
        }

        .settings-btn:hover {
            background: #06a850;
            color: white;
        }

        /* 设置面板 */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .settings-content {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .settings-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-settings:hover {
            background: #f0f0f0;
            color: #333;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .setting-desc {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        /* 开关按钮 */
        .switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #ddd;
            border-radius: 13px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .switch.active {
            background: #07c160;
        }

        .switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .switch.active::before {
            transform: translateX(24px);
        }

        /* 视频网格 */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 视频卡片 - 包含播放器 */
        .video-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
        }

        .video-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .video-card.playing {
            box-shadow: 0 4px 24px rgba(7, 193, 96, 0.2);
            border: 2px solid #07c160;
        }

        /* 视频播放器容器 */
        .video-player-container {
            position: relative;
            aspect-ratio: 16/9;
            background: #000;
            overflow: hidden;
        }

        /* 视频缩略图样式 */
        .video-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            pointer-events: none;
            transition: opacity 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .video-thumbnail.loaded {
            opacity: 1;
        }

        .video-thumbnail.loading {
            opacity: 0.7;
        }

        /* 主播放器样式 */
        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none;
        }

        /* 当启用点击播放时，恢复video的指针事件 */
        .video-player-container.click-enabled .video-player {
            pointer-events: auto;
            cursor: pointer;
        }

        /* 缩略图加载占位符 */
        .thumbnail-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            z-index: 0;
        }

        .thumbnail-placeholder i {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        /* 播放按钮遮罩 */
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 3;
        }

        .play-overlay:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        .play-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .play-button {
            width: 60px;
            height: 60px;
            background: rgba(7, 193, 96, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .play-button:hover {
            transform: scale(1.1);
            background: #07c160;
        }

        .play-button i {
            color: white;
            font-size: 24px;
            margin-left: 3px;
        }

        /* 视频加载指示器 */
        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            display: none;
            z-index: 4;
        }

        .video-loading.show {
            display: block;
            animation: spin 1s linear infinite;
        }

        /* 预加载标记 */
        .preload-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(7, 193, 96, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 5;
            backdrop-filter: blur(4px);
        }

        /* 缩略图加载标记 */
        .thumbnail-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: none;
            align-items: center;
            gap: 4px;
            z-index: 5;
            backdrop-filter: blur(4px);
        }

        .thumbnail-badge.show {
            display: flex;
        }

        /* 视频信息 */
        .video-info {
            padding: 16px;
            border-top: 1px solid #f0f0f0;
        }

        .video-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .video-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #999;
            font-size: 12px;
        }

        .video-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 视频控制栏 */
        .video-controls {
            padding: 12px 16px;
            background: #f8f8f8;
            display: flex;
            gap: 8px;
            justify-content: center;
            border-top: 1px solid #e6e6e6;
        }

        .control-btn {
            background: #fff;
            color: #666;
            border: 1px solid #e6e6e6;
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:hover {
            background: #07c160;
            color: white;
            border-color: #07c160;
        }

        .control-btn.active {
            background: #07c160;
            color: white;
            border-color: #07c160;
        }

        /* 音量控制 */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .volume-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #07c160;
            border-radius: 50%;
            cursor: pointer;
        }

        /* 状态和通知 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
            color: #999;
            background: #fff;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .loading i {
            font-size: 24px;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
            color: #07c160;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            display: none;
            background: #fff;
            border-radius: 12px;
        }

        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 16px;
        }

        .notification {
            position: fixed;
            top: 76px;
            right: 20px;
            background: #fff;
            color: #333;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            min-width: 240px;
            max-width: 320px;
            font-size: 14px;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid #07c160;
        }

        .notification.error {
            border-left: 4px solid #fa5151;
        }

        .notification i {
            margin-right: 8px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 66px 16px 16px;
            }

            .nav-links {
                display: none;
            }

            .video-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .library-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .play-button {
                width: 50px;
                height: 50px;
            }

            .play-button i {
                font-size: 20px;
            }

            .notification {
                right: 16px;
                left: 16px;
                min-width: auto;
                max-width: none;
                text-align: center;
            }

            .preload-indicator {
                left: 16px;
                font-size: 11px;
                padding: 6px 10px;
            }

            .volume-slider {
                display: none;
            }

            .settings-content {
                margin: 10px;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .video-controls {
                padding: 8px 12px;
                gap: 4px;
            }

            .control-btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .control-btn span {
                display: none;
            }

            .video-info {
                padding: 12px;
            }

            .video-title {
                font-size: 13px;
            }

            .video-meta {
                font-size: 11px;
            }
        }

        /* 全屏样式 */
        .video-card.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            border-radius: 0;
            width: 100%;
            height: 100%;
        }

        .video-card.fullscreen .video-player-container {
            height: calc(100% - 120px);
        }

        .video-card.fullscreen .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
        }

        .video-card.fullscreen .control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* 动画 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 缩略图淡入动画 */
        @keyframes thumbnailFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .video-thumbnail.fade-in {
            animation: thumbnailFadeIn 0.5s ease-in-out;
        }

        /* 防止移动端页面缩放 */
        html {
            touch-action: pan-x pan-y;
            -webkit-text-size-adjust: none;
            -ms-text-size-adjust: none;
        }

        /* 移动端安全区域适配 */
        @supports (padding-top: env(safe-area-inset-top)) {
            .header {
                padding-top: env(safe-area-inset-top);
                height: calc(56px + env(safe-area-inset-top));
            }

            .container {
                padding-top: calc(76px + env(safe-area-inset-top));
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <header class="header" id="header">
        <div class="nav-container">
            <a href="#" class="logo">
                <i class="fas fa-play-circle"></i> 视频中心
            </a>
            <ul class="nav-links">
                <li><a href="#" class="active">视频库</a></li>
                <li><a href="#" onclick="showAbout()">关于我们</a></li>
                <li><a href="#" onclick="showContact()">联系方式</a></li>
            </ul>
        </div>
    </header>

    <!-- 预加载指示器 -->
    <div class="preload-indicator" id="preloadIndicator">
        <i class="fas fa-spinner"></i>
        <span>正在预加载视频...</span>
    </div>

    <!-- 主容器 -->
    <div class="container">
        <!-- 页面标题 -->
        <div class="page-header">
            <h1>凤凰眼视觉  开启高维智能观赛新时代</h1>
            <p>视频展示中心</p>
        </div>

        <!-- 视频库头部 -->
        <div class="library-header">
            <h2>视频库</h2>
            <div class="header-actions">
                <button class="action-btn settings-btn" onclick="showSettings()">
                    <i class="fas fa-cog"></i> 设置
                </button>
                <button class="action-btn" onclick="stopAllVideos()">
                    <i class="fas fa-stop"></i> 停止全部
                </button>
                <button class="action-btn" onclick="refreshVideoList()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>

        <!-- 加载状态 -->
        <div class="loading" id="loading">
            <i class="fas fa-spinner"></i>
            <p>正在加载视频列表...</p>
        </div>

        <!-- 视频网格 -->
        <div class="video-grid" id="videoGrid">
            <!-- 视频列表将通过JavaScript动态加载 -->
        </div>

        <!-- 空状态 -->
        <div class="empty-state" id="emptyState">
            <i class="fas fa-video-slash"></i>
            <h3>暂无视频内容</h3>
            <p>请添加视频文件到服务器</p>
        </div>
    </div>

    <!-- 设置面板 -->
    <div class="settings-panel" id="settingsPanel" onclick="hideSettings(event)">
        <div class="settings-content" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h3>播放设置</h3>
                <button class="close-settings" onclick="hideSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="setting-item">
                <div>
                    <div class="setting-label">点击视频播放/暂停</div>
                    <div class="setting-desc">启用后可以直接点击视频区域控制播放</div>
                </div>
                <div class="switch" id="clickToPlaySwitch" onclick="toggleClickToPlay()">
                </div>
            </div>
            
            <div class="setting-item">
                <div>
                    <div class="setting-label">自动停止其他视频</div>
                    <div class="setting-desc">播放新视频时自动停止其他正在播放的视频</div>
                </div>
                <div class="switch active" id="autoStopSwitch" onclick="toggleAutoStop()">
                </div>
            </div>
            
            <div class="setting-item">
                <div>
                    <div class="setting-label">预加载视频</div>
                    <div class="setting-desc">预先加载部分视频以提高播放流畅度</div>
                </div>
                <div class="switch active" id="preloadSwitch" onclick="togglePreload()">
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">自动加载封面</div>
                    <div class="setting-desc">页面加载时自动显示视频封面</div>
                </div>
                <div class="switch active" id="thumbnailSwitch" onclick="toggleThumbnail()">
                </div>
            </div>
        </div>
    </div>

    <!-- 通知组件 -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">操作成功</span>
    </div>

    <script>
        // 全局变量
        let videoList = [];
        let activeVideos = new Map(); // 存储活动的视频播放器
        let preloadedVideos = new Set();
        let thumbnailsLoaded = new Set();
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let userHasInteracted = false;

        // 用户设置
        let settings = {
            clickToPlay: false,   // 默认禁用点击播放（特别是移动端）
            autoStop: true,       // 自动停止其他视频
            preload: true,        // 预加载视频
            thumbnail: true       // 自动加载封面
        };

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 开始加载视频列表...');
            loadSettings();
            loadVideoList();
            setupUserInteractionTracking();
            setupMobileOptimizations();
            setupKeyboardControls();
        });

        // 加载用户设置
        function loadSettings() {
            // 移动端默认禁用点击播放功能
            if (isMobile) {
                settings.clickToPlay = false;
            }
            
            updateSettingsUI();
        }

        // 更新设置界面
        function updateSettingsUI() {
            document.getElementById('clickToPlaySwitch').classList.toggle('active', settings.clickToPlay);
            document.getElementById('autoStopSwitch').classList.toggle('active', settings.autoStop);
            document.getElementById('preloadSwitch').classList.toggle('active', settings.preload);
            document.getElementById('thumbnailSwitch').classList.toggle('active', settings.thumbnail);
        }

        // 显示设置面板
        function showSettings() {
            document.getElementById('settingsPanel').style.display = 'flex';
            updateSettingsUI();
        }

        // 隐藏设置面板
        function hideSettings(event) {
            if (!event || event.target.id === 'settingsPanel') {
                document.getElementById('settingsPanel').style.display = 'none';
            }
        }

        // 切换点击播放设置
        function toggleClickToPlay() {
            settings.clickToPlay = !settings.clickToPlay;
            updateSettingsUI();
            applyClickToPlaySetting();
            showNotification(
                settings.clickToPlay ? '已启用点击视频播放/暂停' : '已禁用点击视频播放/暂停', 
                'success'
            );
        }

        // 应用点击播放设置
        function applyClickToPlaySetting() {
            const containers = document.querySelectorAll('.video-player-container');
            containers.forEach(container => {
                if (settings.clickToPlay) {
                    container.classList.add('click-enabled');
                } else {
                    container.classList.remove('click-enabled');
                }
            });
        }

        // 切换自动停止设置
        function toggleAutoStop() {
            settings.autoStop = !settings.autoStop;
            updateSettingsUI();
            showNotification(
                settings.autoStop ? '已启用自动停止其他视频' : '已禁用自动停止其他视频', 
                'success'
            );
        }

        // 切换预加载设置
        function togglePreload() {
            settings.preload = !settings.preload;
            updateSettingsUI();
            showNotification(
                settings.preload ? '已启用视频预加载' : '已禁用视频预加载', 
                'success'
            );
        }

        // 切换封面设置
        function toggleThumbnail() {
            settings.thumbnail = !settings.thumbnail;
            updateSettingsUI();
            showNotification(
                settings.thumbnail ? '已启用自动加载封面' : '已禁用自动加载封面', 
                'success'
            );
            
            if (settings.thumbnail && videoList.length > 0) {
                loadThumbnails();
            }
        }

        // 加载视频列表
        async function loadVideoList() {
            try {
                showLoading(true);
                showPreloadIndicator(true, '正在获取视频列表...');
                
                const response = await fetch('/api/get_video_list');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    videoList = data.videos || [];
                    
                    if (videoList.length > 0) {
                        renderVideoGrid();
                        showNotification(`成功加载 ${videoList.length} 个视频`, 'success');
                        
                        // 根据设置决定是否预加载
                        if (settings.preload) {
                            preloadVideos();
                        }

                        // 根据设置决定是否加载封面
                        if (settings.thumbnail) {
                            loadThumbnails();
                        }
                    } else {
                        showEmptyState();
                    }
                } else {
                    throw new Error(data.message || '获取视频列表失败');
                }
                
            } catch (error) {
                console.error('加载视频列表失败:', error);
                showNotification('加载失败，请刷新重试', 'error');
                showEmptyState();
            } finally {
                showLoading(false);
                showPreloadIndicator(false);
            }
        }

        // 渲染视频网格
        function renderVideoGrid() {
            const videoGrid = document.getElementById('videoGrid');
            const emptyState = document.getElementById('emptyState');
            
            emptyState.style.display = 'none';
            videoGrid.innerHTML = '';
            videoGrid.style.display = 'grid';

            videoList.forEach((video, index) => {
                const card = createVideoCard(video, index);
                videoGrid.appendChild(card);
            });

            // 应用点击播放设置
            applyClickToPlaySetting();
        }

        // 创建视频卡片（包含播放器和缩略图）
        function createVideoCard(video, index) {
            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `video-card-${index}`;
            card.setAttribute('data-index', index);
            card.setAttribute('data-filename', video.filename);

            const sizeText = video.size ? formatFileSize(video.size) : '未知大小';
            const modifiedText = video.modified ? formatDate(new Date(video.modified)) : '未知日期';

            card.innerHTML = `
                <div class="video-player-container" id="player-container-${index}">
                    <!-- 缩略图占位符 -->
                    <div class="thumbnail-placeholder" id="placeholder-${index}">
                        <div style="text-align: center;">
                            <i class="fas fa-video"></i>
                            
                        </div>
                    </div>
                    
                    <!-- 缩略图视频 - 用于显示封面 -->
                    <video 
                        id="thumbnail-${index}" 
                        class="video-thumbnail"
                        preload="metadata"
                        muted
                        playsinline 
                        webkit-playsinline
                        style="display: none;">
                        <source src="/api/video_thumbnail/${encodeURIComponent(video.filename)}" type="video/mp4">
                    </video>
                    
                    <!-- 主播放器 -->
                    <video 
                        id="video-${index}" 
                        class="video-player"
                        preload="none"
                        playsinline 
                        webkit-playsinline
                        controls
                        style="display: none;">
                        <source src="/api/stream_video/${encodeURIComponent(video.filename)}" type="video/mp4">
                        您的浏览器不支持视频播放。
                    </video>
                    
                    <div class="play-overlay" id="overlay-${index}" onclick="playVideo(${index})">
                        <div class="play-button">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    
                    <div class="video-loading" id="loading-${index}">
                        <i class="fas fa-spinner"></i>
                    </div>
                    


                </div>
                
                <div class="video-info">
                    <div class="video-title" title="${video.filename}">
                        ${video.name || video.filename}
                    </div>
                    <div class="video-meta">
                        <span><i class="fas fa-file"></i> ${sizeText}</span>
                        <span><i class="fas fa-calendar"></i> ${modifiedText}</span>
                    </div>
                </div>
                
                <div class="video-controls">
                    <button class="control-btn" onclick="togglePlayPause(${index})" id="play-btn-${index}">
                        <i class="fas fa-play"></i>
                        <span>播放</span>
                    </button>
                    <button class="control-btn" onclick="toggleMute(${index})">
                        <i class="fas fa-volume-up"></i>
                        <span>静音</span>
                    </button>
                    <div class="volume-control">
                        <input type="range" class="volume-slider" id="volume-${index}" 
                               min="0" max="100" value="100" 
                               oninput="changeVolume(${index}, this.value)">
                    </div>
                    <button class="control-btn" onclick="toggleFullscreen(${index})">
                        <i class="fas fa-expand"></i>
                        <span>全屏</span>
                    </button>
                    <button class="control-btn" onclick="downloadVideo('${video.filename}')">
                        <i class="fas fa-download"></i>
                        <span>下载</span>
                    </button>
                </div>
            `;

            // 设置视频事件监听
            setTimeout(() => {
                setupVideoEvents(index);
            }, 0);

            return card;
        }

        // 设置视频事件监听
        function setupVideoEvents(index) {
            const video = document.getElementById(`video-${index}`);
            const thumbnail = document.getElementById(`thumbnail-${index}`);
            
            if (!video) return;

            // 设置缩略图事件
            if (thumbnail) {
                thumbnail.addEventListener('loadeddata', () => {
                    console.log(`缩略图 ${index} 数据加载完成`);
                    
                    // 跳到第2秒获取更好的封面帧
                    thumbnail.currentTime = 0.5;
                    
                    setTimeout(() => {
                        thumbnail.pause();
                        showThumbnail(index);
                        thumbnailsLoaded.add(index);
                    }, 500);
                });

                thumbnail.addEventListener('loadedmetadata', () => {
                    console.log(`缩略图 ${index} 元数据加载完成`);
                });

                thumbnail.addEventListener('error', (e) => {
                    console.warn(`缩略图 ${index} 加载失败:`, e);
                    showThumbnailError(index);
                });

                thumbnail.addEventListener('timeupdate', () => {
                    // 确保在第2秒暂停
                    if (thumbnail.currentTime >= 2) {
                        thumbnail.pause();
                    }
                });
            }

            // 主播放器事件监听
            video.addEventListener('loadstart', () => {
                console.log(`视频 ${index} 开始加载`);
                showLoadingIndicator(index, true);
            });

            video.addEventListener('loadeddata', () => {
                console.log(`视频 ${index} 数据已加载`);
                showLoadingIndicator(index, false);
            });

            video.addEventListener('play', () => {
                console.log(`视频 ${index} 开始播放`);
                updatePlayButton(index, true);
                document.getElementById(`video-card-${index}`).classList.add('playing');
                
                // 根据设置决定是否停止其他视频
                if (settings.autoStop) {
                    stopOtherVideos(index);
                }
            });

            video.addEventListener('pause', () => {
                console.log(`视频 ${index} 暂停`);
                updatePlayButton(index, false);
                document.getElementById(`video-card-${index}`).classList.remove('playing');
            });

            video.addEventListener('ended', () => {
                console.log(`视频 ${index} 播放结束`);
                resetVideo(index);
                showNotification('视频播放完成', 'success');
            });

            video.addEventListener('error', (e) => {
                console.error(`视频 ${index} 加载失败:`, e);
                showLoadingIndicator(index, false);
                showNotification('视频加载失败', 'error');
            });

            // 只有在启用点击播放时才添加点击事件
            video.addEventListener('click', (e) => {
                if (settings.clickToPlay) {
                    e.stopPropagation();
                    togglePlayPause(index);
                }
            });
        }

        // 显示缩略图
        function showThumbnail(index) {
            const thumbnail = document.getElementById(`thumbnail-${index}`);
            const placeholder = document.getElementById(`placeholder-${index}`);
            const badge = document.getElementById(`thumb-badge-${index}`);
            
            if (thumbnail && placeholder) {
                placeholder.style.display = 'none';
                thumbnail.style.display = 'block';
                thumbnail.classList.add('loaded', 'fade-in');
                
                if (badge) {
                    badge.classList.add('show');
                }
                
                console.log(`✅ 缩略图显示成功: ${index}`);
            }
        }

        // 显示缩略图错误
        function showThumbnailError(index) {
            const placeholder = document.getElementById(`placeholder-${index}`);
            
            if (placeholder) {
                placeholder.innerHTML = `
                    <div style="text-align: center; color: #999;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>封面加载失败</div>
                    </div>
                `;
            }
        }

        // 加载所有缩略图
        function loadThumbnails() {
            if (!settings.thumbnail) return;
            
            showPreloadIndicator(true, '正在加载视频封面...');
            
            let loadedCount = 0;
            const totalCount = videoList.length;
            
            videoList.forEach((video, index) => {
                const thumbnail = document.getElementById(`thumbnail-${index}`);
                if (thumbnail && !thumbnailsLoaded.has(index)) {
                    // 触发缩略图加载
                    thumbnail.load();
                    
                    const checkLoaded = () => {
                        loadedCount++;
                        if (loadedCount >= totalCount) {
                            showPreloadIndicator(false);
                            showNotification(`封面加载完成 (${thumbnailsLoaded.size}/${totalCount})`, 'success');
                        }
                    };

                    thumbnail.addEventListener('loadeddata', checkLoaded, { once: true });
                    thumbnail.addEventListener('error', checkLoaded, { once: true });
                }
            });
            
            // 设置超时，避免长时间等待
            setTimeout(() => {
                if (loadedCount < totalCount) {
                    showPreloadIndicator(false);
                    showNotification(`封面加载完成 (${thumbnailsLoaded.size}/${totalCount})`, 'success');
                }
            }, 10000); // 10秒超时
        }

        // 播放视频
        async function playVideo(index) {
            const video = document.getElementById(`video-${index}`);
            const thumbnail = document.getElementById(`thumbnail-${index}`);
            const overlay = document.getElementById(`overlay-${index}`);
            const loadingIndicator = document.getElementById(`loading-${index}`);
            
            if (!video) return;

            try {
                // 显示主播放器，隐藏缩略图
                video.style.display = 'block';
                if (thumbnail) {
                    thumbnail.style.display = 'none';
                }
                
                // 隐藏播放按钮遮罩
                overlay.classList.add('hidden');
                loadingIndicator.classList.add('show');
                
                // 记录活动视频
                activeVideos.set(index, video);
                
                // 根据设置决定是否停止其他视频
                if (settings.autoStop) {
                    stopOtherVideos(index);
                }
                
                // 尝试播放
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    await playPromise;
                    showNotification(`开始播放: ${videoList[index].name || videoList[index].filename}`, 'success');
                }
                
            } catch (error) {
                console.error('播放失败:', error);
                
                // 如果是自动播放限制，尝试静音播放
                if (error.name === 'NotAllowedError') {
                    video.muted = true;
                    try {
                        await video.play();
                        showNotification('视频已静音播放（浏览器限制）', 'error');
                    } catch (e) {
                        showNotification('请手动点击播放按钮', 'error');
                        resetVideo(index);
                    }
                } else {
                    showNotification('播放失败，请重试', 'error');
                    resetVideo(index);
                }
            } finally {
                loadingIndicator.classList.remove('show');
            }
        }

        // 切换播放/暂停
        function togglePlayPause(index) {
            const video = document.getElementById(`video-${index}`);
            if (!video) return;

            if (video.paused) {
                if (video.style.display === 'none') {
                    playVideo(index);
                } else {
                    video.play();
                }
            } else {
                video.pause();
            }
        }

        // 停止其他视频
        function stopOtherVideos(currentIndex) {
            activeVideos.forEach((video, index) => {
                if (index !== currentIndex && !video.paused) {
                    video.pause();
                    resetVideo(index);
                }
            });
        }

        // 停止所有视频
        function stopAllVideos() {
            activeVideos.forEach((video, index) => {
                if (!video.paused) {
                    video.pause();
                }
                resetVideo(index);
            });
            activeVideos.clear();
            showNotification('已停止所有视频', 'success');
        }

        // 重置视频
        function resetVideo(index) {
            const video = document.getElementById(`video-${index}`);
            const thumbnail = document.getElementById(`thumbnail-${index}`);
            const overlay = document.getElementById(`overlay-${index}`);
            const card = document.getElementById(`video-card-${index}`);
            
            if (video) {
                video.currentTime = 0;
                video.style.display = 'none';
                video.preload = 'none';
            }
            
            // 重新显示缩略图
            if (thumbnail && thumbnailsLoaded.has(index)) {
                thumbnail.style.display = 'block';
            }
            
            if (overlay) {
                overlay.classList.remove('hidden');
            }
            
            if (card) {
                card.classList.remove('playing');
            }
            
            updatePlayButton(index, false);
            activeVideos.delete(index);
        }

        // 切换静音
        function toggleMute(index) {
            const video = document.getElementById(`video-${index}`);
            if (!video) return;
            
            video.muted = !video.muted;
            showNotification(video.muted ? '已静音' : '已取消静音', 'success');
        }

        // 改变音量
        function changeVolume(index, value) {
            const video = document.getElementById(`video-${index}`);
            if (!video) return;
            
            video.volume = value / 100;
            if (video.muted && value > 0) {
                video.muted = false;
            }
        }

        // 切换全屏
        function toggleFullscreen(index) {
            const video = document.getElementById(`video-${index}`);
            const card = document.getElementById(`video-card-${index}`);
            
            if (!video) return;

            // 移动端：直接调用系统原生播放器
            if (isMobile) {
                if (video.webkitEnterFullscreen) {
                    video.webkitEnterFullscreen();  // iOS Safari
                } else if (video.requestFullscreen) {
                    video.requestFullscreen();      // Android Chrome
                }
                return;
            }

            if (!document.fullscreenElement) {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                } else if (video.mozRequestFullScreen) {
                    video.mozRequestFullScreen();
                } else if (video.msRequestFullscreen) {
                    video.msRequestFullscreen();
                } else {
                    // 备用全屏方案 - 使用卡片全屏
                    card.classList.add('fullscreen');
                }
                showNotification('已进入全屏模式', 'success');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else {
                    card.classList.remove('fullscreen');
                }
                showNotification('已退出全屏模式', 'success');
            }
        }

        // 下载视频
        function downloadVideo(filename) {
            const link = document.createElement('a');
            link.href = `/api/download_video/${encodeURIComponent(filename)}`;
            link.download = filename;
            link.click();
            showNotification(`开始下载: ${filename}`, 'success');
        }

        // 预加载视频
        async function preloadVideos() {
            if (!settings.preload) return;
            
            showPreloadIndicator(true, '正在预加载视频...');
            
            // 预加载前3个视频
            const preloadCount = Math.min(3, videoList.length);
            
            for (let i = 0; i < preloadCount; i++) {
                try {
                    const response = await fetch(`/api/preload_chunk/${encodeURIComponent(videoList[i].filename)}?chunk_size=524288`);
                    
                    if (response.ok) {
                        await response.blob();
                        preloadedVideos.add(videoList[i].filename);
                        
                        // 显示预加载标记
                        const badge = document.getElementById(`preload-${i}`);
                        if (badge) {
                            badge.style.display = 'flex';
                        }
                        
                        console.log(`✅ 预加载完成: ${videoList[i].filename}`);
                    }
                } catch (error) {
                    console.warn(`预加载失败: ${videoList[i].filename}`, error);
                }
            }
            
            showPreloadIndicator(false);
            
            if (preloadedVideos.size > 0) {
                showNotification(`已预加载 ${preloadedVideos.size} 个视频`, 'success');
            }
        }

        // 刷新视频列表
        async function refreshVideoList() {
            showNotification('正在刷新视频列表...', 'success');
            stopAllVideos();
            preloadedVideos.clear();
            thumbnailsLoaded.clear();
            await loadVideoList();
        }

        // 更新播放按钮状态
        function updatePlayButton(index, isPlaying) {
            const btn = document.getElementById(`play-btn-${index}`);
            if (!btn) return;
            
            const icon = btn.querySelector('i');
            const text = btn.querySelector('span');
            
            if (isPlaying) {
                icon.className = 'fas fa-pause';
                if (text) text.textContent = '暂停';
                btn.classList.add('active');
            } else {
                icon.className = 'fas fa-play';
                if (text) text.textContent = '播放';
                btn.classList.remove('active');
            }
        }



        // 显示预加载指示器
        function showPreloadIndicator(show, message = '正在预加载视频...') {
            const indicator = document.getElementById('preloadIndicator');
            const span = indicator.querySelector('span');
            
            if (show) {
                span.textContent = message;
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }

        // 用户交互跟踪
        function setupUserInteractionTracking() {
            const interactionEvents = ['click', 'touchstart', 'keydown'];
            
            function markUserInteraction() {
                userHasInteracted = true;
                interactionEvents.forEach(event => {
                    document.removeEventListener(event, markUserInteraction);
                });
                console.log('✅ 用户已交互');
            }
            
            interactionEvents.forEach(event => {
                document.addEventListener(event, markUserInteraction, { once: true });
            });
        }

        // 移动端优化
        function setupMobileOptimizations() {
            if (isMobile) {
                // 防止双击缩放
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);

                // 优化视频播放
                document.querySelectorAll('video').forEach(video => {
                    video.setAttribute('playsinline', 'true');
                    video.setAttribute('webkit-playsinline', 'true');
                    video.setAttribute('x5-video-player-type', 'h5');
                });
            }
        }

        // 键盘控制
        function setupKeyboardControls() {
            if (!isMobile) {
                document.addEventListener('keydown', function(e) {
                    // 空格键暂停/播放当前视频
                    if (e.key === ' ') {
                        e.preventDefault();
                        const playingVideos = Array.from(activeVideos.keys());
                        if (playingVideos.length > 0) {
                            togglePlayPause(playingVideos[0]);
                        }
                    }
                    // ESC键停止所有视频
                    else if (e.key === 'Escape') {
                        stopAllVideos();
                    }
                });
            }
        }

        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const icon = notification.querySelector('i');
            
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else {
                icon.className = 'fas fa-info-circle';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 显示/隐藏加载状态
        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }

        // 显示空状态
        function showEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const videoGrid = document.getElementById('videoGrid');
            
            emptyState.style.display = 'block';
            videoGrid.style.display = 'none';
        }

        // 工具函数
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(date) {
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // 简单的关于和联系信息
        function showAbout() {
            showNotification('视频展示平台 - 提供高质量的视频内容展示', 'success');
        }

        function showContact() {
            showNotification('如需联系，请发送邮件至 contact@example.com', 'success');
        }

        // 页面可见性处理
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // 页面隐藏时暂停所有视频
                activeVideos.forEach((video) => {
                    if (!video.paused) {
                        video.pause();
                    }
                });
            }
        });
    </script>
</body>
</html>