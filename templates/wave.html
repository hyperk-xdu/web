<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>电力实时波形分析平台</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --light-bg: #f8f9fa;
      --sidebar-width: 60px;
      --param-width: 320px;
      --transition: all 0.3s ease;
      
      --dc-color: #9b59b6;
      --single-phase-color: #3498db;
      --phase-a-color: #e74c3c;
      --phase-b-color: #f39c12;
      --phase-c-color: #3498db;
      
      /* 示波器样式 */
      --oscilloscope-bg: #001122;
      --oscilloscope-grid: #003366;
      --oscilloscope-text: #00ff88;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--light-bg);
      color: #333;
      overflow-x: hidden;
    }
    
    .app-container {
      display: flex;
      min-height: 100vh;
      width: 100%;
    }
    
    .sidebar {
      width: var(--sidebar-width);
      background: var(--secondary-color);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      position: relative;
      z-index: 100;
      transition: var(--transition);
      flex-shrink: 0;
    }
    
    .menu-toggle-container {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: auto;
      margin-bottom: 30px;
    }
    
    .menu-toggle {
      background: var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .menu-toggle:hover {
      background: var(--accent-color);
    }
    
    .menu-toggle i {
      font-size: 20px;
    }
    
    .menu-options {
      position: absolute;
      left: 100%;
      top: 0;
      bottom: 0;
      width: 0;
      background: white;
      box-shadow: 3px 0 15px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: var(--transition);
      z-index: 99;
      opacity: 0;
      visibility: hidden;
    }
    
    .sidebar:hover .menu-options {
      width: 250px;
      opacity: 1;
      visibility: visible;
      padding: 20px 15px;
      overflow-y: auto;
    }
    
    .menu-option {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: var(--transition);
      color: var(--secondary-color);
      display: flex;
      align-items: center;
      font-weight: 500;
    }
    
    .menu-option:hover {
      background: #f1f1f1;
      padding-left: 15px;
    }
    
    .menu-option i {
      margin-right: 10px;
      color: var(--primary-color);
      width: 20px;
      text-align: center;
    }
    
    .menu-option.active {
      background: #e8f0fe;
      border-left: 3px solid var(--primary-color);
    }
    
    .param-bar {
      width: var(--param-width);
      background: white;
      padding: 20px 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      position: relative;
      z-index: 90;
      transition: all 0.3s ease;
      flex-shrink: 0;
      height: calc(100vh - 40px);
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) #f1f1f1;
    }
    
    .param-bar::-webkit-scrollbar {
      width: 8px;
    }
    
    .param-bar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .param-bar::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    .param-bar::-webkit-scrollbar-thumb:hover {
      background: var(--accent-color);
    }
    
    .param-bar h4 {
      position: sticky;
      top: -20px;
      background: white;
      z-index: 10;
      margin: -20px -15px 20px -15px;
      padding: 20px 15px 15px 15px;
      border-bottom: 1px solid #eee;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .section-title {
      font-size: 16px;
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 8px;
      margin-top: 20px;
      margin-bottom: 15px;
      font-weight: 600;
      background: white;
      position: sticky;
      top: 60px;
      z-index: 5;
      margin-left: -5px;
      margin-right: -5px;
      padding-left: 5px;
      padding-right: 5px;
    }
    
    .param-group {
      margin-bottom: 25px;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 15px;
    }
    
    .param-group:last-child {
      border-bottom: none;
      margin-bottom: 15px;
    }
    
    .work-mode-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    
    .work-mode-indicator.dc {
      background: #f3e5f5;
      color: #7b1fa2;
      border: 1px solid #ce93d8;
    }
    
    .work-mode-indicator.single-phase {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }
    
    .work-mode-indicator.three-phase {
      background: #fff3e0;
      color: #f57c00;
      border: 1px solid #ffcc02;
    }
    
    .phase-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .phase-a { background-color: var(--phase-a-color); }
    .phase-b { background-color: var(--phase-b-color); }
    .phase-c { background-color: var(--phase-c-color); }
    .single-phase { background-color: var(--single-phase-color); }
    .dc { background-color: var(--dc-color); }
    
    /* 示波器控制面板 */
    .oscilloscope-controls {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      color: white;
      border: 2px solid transparent;
      transition: var(--transition);
    }
    
    .oscilloscope-controls.active {
      border-color: var(--success-color);
      box-shadow: 0 0 20px rgba(39, 174, 96, 0.3);
    }
    
    .oscilloscope-toggle-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .oscilloscope-toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .oscilloscope-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .oscilloscope-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.3);
      transition: .4s;
      border-radius: 30px;
      border: 2px solid rgba(255,255,255,0.5);
    }
    
    .oscilloscope-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    input:checked + .oscilloscope-slider {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }
    
    input:checked + .oscilloscope-slider:before {
      transform: translateX(30px);
    }
    
    .oscilloscope-params {
      display: none;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    
    .oscilloscope-params.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    
    .speed-control {
      margin-bottom: 15px;
    }
    
    .speed-control label {
      color: white;
      font-size: 13px;
      font-weight: 500;
    }
    
    .speed-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      margin-top: 5px;
    }
    
    .speed-dot {
      width: 8px;
      height: 8px;
      background: #00ff88;
      border-radius: 50%;
      animation: oscilloscope-pulse 1s infinite;
    }
    
    @keyframes oscilloscope-pulse {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.3); }
    }
    
    .main-content {
      flex: 1;
      padding: 20px;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .connection-status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .connection-status.disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f1aeb5;
    }
    
    .connection-status.connecting {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    
    .status-indicator.connected {
      background: var(--success-color);
    }
    
    .status-indicator.disconnected {
      background: var(--accent-color);
    }
    
    .status-indicator.connecting {
      background: var(--warning-color);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .client-selection {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .client-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .client-card {
      border: 2px solid #e1e5f1;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    
    .client-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .client-card.selected {
      border-color: var(--success-color);
      background: #f8fff9;
    }
    
    .client-card.offline {
      border-color: #ddd;
      background: #f8f9fa;
      opacity: 0.7;
    }
    
    .client-card.dc {
      border-left: 4px solid var(--dc-color);
    }
    
    .client-card.single-phase {
      border-left: 4px solid var(--single-phase-color);
    }
    
    .client-card.three-phase {
      border-left: 4px solid var(--phase-a-color);
    }
    
    .client-id {
      font-weight: 600;
      color: var(--secondary-color);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .client-info {
      font-size: 12px;
      color: #666;
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .client-status {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .client-status.connected {
      background: var(--success-color);
    }
    
    .client-status.offline {
      background: #ccc;
    }
    
    .power-system-overview {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      display: none;
      transition: var(--transition);
    }
    
    .power-values {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    
    .power-value {
      text-align: center;
      transition: var(--transition);
    }
    
    .power-value:hover {
      transform: scale(1.05);
    }
    
    .power-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .power-number {
      font-size: 24px;
      font-weight: bold;
      transition: color 0.3s ease;
    }
    
    .chart-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
      flex: 1 1 auto;
      min-height: 450px;
      position: relative;
      width: 100%;
      min-width: 0;
      transition: all 0.3s ease;
    }
    
    .chart-container.oscilloscope-mode {
      background: var(--oscilloscope-bg);
      border: 2px solid var(--oscilloscope-grid);
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
    }
    
    .chart-container.oscilloscope-mode .chart-title {
      color: var(--oscilloscope-text);
    }
    
    .chart-container canvas {
      width: 100% !important;
      min-height: 400px;
      height: auto !important;
      max-height: 650px;
    }
    
    .chart-title {
      margin-bottom: 15px;
      font-weight: 500;
      color: var(--secondary-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      transition: color 0.3s ease;
    }
    
    .chart-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .phase-toggle {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    
    .phase-checkbox {
      margin-right: 5px;
    }
    
    .oscilloscope-info {
      display: none;
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--oscilloscope-text);
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--oscilloscope-text);
      font-family: 'Courier New', monospace;
    }
    
    .chart-container.oscilloscope-mode .oscilloscope-info {
      display: block;
    }
    
    .stats-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      padding: 20px;
      flex-shrink: 0;
      display: none;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: linear-gradient(to bottom, #f1f5fd, #ffffff);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #e1e5f1;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      min-width: 160px;
    }
    
    .stat-card:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--primary-color);
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .stat-card.dc:before { background: var(--dc-color); }
    .stat-card.phase-a:before { background: var(--phase-a-color); }
    .stat-card.phase-b:before { background: var(--phase-b-color); }
    .stat-card.phase-c:before { background: var(--phase-c-color); }
    .stat-card.single-phase:before { background: var(--single-phase-color); }
    
    .stat-title {
      color: var(--secondary-color);
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .stat-title i {
      margin-right: 6px;
      color: #5c7cfa;
      font-size: 14px;
      min-width: 18px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .btn-primary {
      background: var(--primary-color);
      border: none;
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      transition: var(--transition);
    }
    
    .btn-primary:hover {
      background: #2980b9;
    }
    
    .btn-success {
      background: var(--success-color);
      border: none;
    }
    
    .btn-success:hover {
      background: #219a52;
    }
    
    .btn-warning {
      background: var(--warning-color);
      border: none;
    }
    
    .btn-warning:hover {
      background: #e67e22;
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #f1aeb5;
    }
    
    .success-message {
      background: #d1edff;
      color: #0c5460;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #bee5eb;
    }
    
    .warning-message {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #ffeaa7;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .realtime-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      background: #f8fff9;
      border: 1px solid #27ae60;
      border-radius: 15px;
      font-size: 12px;
      color: #27ae60;
      font-weight: 500;
    }
    
    .realtime-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #27ae60;
      animation: pulse 1s infinite;
    }
    
    .transmission-status {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }
    
    .transmission-status.active {
      display: block;
      animation: fadeInOut 2s;
    }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    
    /* 示波器网格效果 */
    .chart-container.oscilloscope-mode canvas {
      background-image: 
        linear-gradient(rgba(0, 51, 102, 0.3) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 51, 102, 0.3) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    /* 响应式设计 */
    @media (max-width: 1200px) {
      .app-container {
        flex-wrap: wrap;
      }
      
      .sidebar {
        width: 100%;
        height: 60px;
        flex-direction: row;
        justify-content: space-between;
        padding: 0 20px;
        position: fixed;
        top: 0;
        z-index: 1000;
      }
      
      .param-bar {
        width: 100%;
        height: auto;
        max-height: 50vh;
        position: fixed;
        top: 60px;
        z-index: 999;
        max-height: 0;
        padding: 0 15px;
        transition: max-height 0.3s ease;
      }
      
      .param-bar.active {
        max-height: 50vh;
        padding: 20px 15px;
      }
      
      .main-content {
        width: 100%;
        padding-top: 80px;
      }
    }
    
    @media (max-width: 768px) {
      .client-list {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
      
      .stat-card {
        padding: 12px;
      }
      
      .stat-value {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="transmission-status" id="transmissionStatus">
    数据传输中...
  </div>

  <div class="app-container" id="appContainer">
    <div class="sidebar">
      <div class="menu-toggle-container">
        <div class="menu-toggle">
          <i class="fas fa-bars"></i>
        </div>
      </div>
      <div class="menu-options">
        <div class="menu-option active">
          <i class="fas fa-bolt"></i> 电力波形监控
        </div>
        <div class="menu-option">
          <i class="fas fa-chart-line"></i> 实时监控模式
        </div>
        <div class="menu-option">
          <i class="fas fa-calculator"></i> 深度分析模式
        </div>
        <div class="menu-option">
          <i class="fas fa-broadcast-tower"></i> 数据源管理
        </div>
        <div class="menu-option">
          <i class="fas fa-desktop"></i> 示波器模式
        </div>
        <div class="menu-option">
          <i class="fas fa-cog"></i> 系统设置
        </div>
      </div>
    </div>
    
    <div class="param-bar">
      <h4 class="mb-4" style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
        <i class="fas fa-bolt me-2"></i>电力系统分析参数
      </h4>
      
      <form id="analysisForm">
        <!-- 示波器控制面板 -->
        <div class="param-group">
          <div class="section-title">示波器开启</div>
          <div class="oscilloscope-controls" id="oscilloscopeControls">
            <div class="oscilloscope-toggle-wrapper">
              <div>
                <strong><i class="fas fa-desktop me-2"></i>波形展示</strong>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 3px;">
                  启用实时波形分析
                </div>
              </div>
              <label class="oscilloscope-toggle">
                <input type="checkbox" id="oscilloscopeMode">
                <span class="oscilloscope-slider"></span>
              </label>
            </div>
            
            <div class="oscilloscope-params" id="oscilloscopeParams">
              <div class="speed-control">
                <label class="form-label">
                  更新速度: <span id="scrollSpeedValue">50</span> ms/点
                </label>
                <input type="range" class="form-range" id="scrollSpeedSlider" 
                       min="10" max="200" value="50" step="10">
                <div class="speed-indicator">
                  <div class="speed-dot"></div>
                  <span id="speedText">中等速度</span>
                </div>
              </div>
              
              <div class="speed-control">
                <label class="form-label">
                  缓冲区大小: <span id="bufferSizeValue">1000</span> 点
                </label>
                <input type="range" class="form-range" id="bufferSizeSlider" 
                       min="200" max="2000" value="1000" step="100">
                <small class="form-text" style="color: rgba(255,255,255,0.7); font-size: 11px;">
                  控制屏幕显示的数据点数量
                </small>
              </div>
              
              <div class="speed-control">
                <label class="form-label">
                  更新频率: <span id="updateRateValue">10</span> 点/次
                </label>
                <input type="range" class="form-range" id="updateRateSlider"
                       min="1" max="50" value="10" step="1">
                <small class="form-text" style="color: rgba(255,255,255,0.7); font-size: 11px;">
                  每次更新添加的新数据点数
                </small>
              </div>

              <div class="speed-control">
                <label class="form-label">
                  背景颜色
                </label>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <input type="color" class="form-control form-control-color"
                         id="oscilloscopeBgColor" value="#001122"
                         style="width: 50px; height: 35px; border: 2px solid rgba(255,255,255,0.3);">
                  <button type="button" class="btn btn-sm" id="resetBgColorBtn"
                          style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 11px;">
                    重置
                  </button>
                </div>
                <small class="form-text" style="color: rgba(255,255,255,0.7); font-size: 11px;">
                  自定义示波器背景颜色
                </small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="param-group">
          <div class="section-title">数据源选择</div>
          <div class="mb-3">
            <label class="form-label">选择电力数据源</label>
            <select class="form-select" id="clientSelect" name="client_id">
              <option value="">请选择电力数据源客户端</option>
            </select>
            <small class="form-text text-muted">选择要分析的电力实时数据源</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">选择分析参数</label>
            <select class="form-select" name="selected_column" id="columnSelect">
              <!-- 动态填充选项 -->
            </select>
            <small class="form-text text-muted">选择要重点分析的参数</small>
          </div>
          
          <div class="mb-3" id="workModeDisplay" style="display: none;">
            <label class="form-label">当前工作模式</label>
            <div id="workModeIndicator" class="work-mode-indicator">
              <i class="fas fa-question-circle"></i>
              <span>未检测</span>
            </div>
          </div>
        </div>
        
        <div class="param-group">
          <div class="section-title">工作模式</div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="workMode" id="monitoringMode" value="monitoring" checked>
              <label class="form-check-label" for="monitoringMode">
                <i class="fas fa-eye me-1"></i>实时监控模式
              </label>
            </div>
            <small class="form-text text-muted">仅显示实时波形，传输负荷较低</small>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="workMode" id="analysisMode" value="analysis">
              <label class="form-check-label" for="analysisMode">
                <i class="fas fa-calculator me-1"></i>深度分析模式
              </label>
            </div>
            <small class="form-text text-muted">计算详细统计信息，适合深入分析</small>
          </div>
        </div>
        
        <div class="param-group" id="analysisOptions" style="display: none;">
          <div class="section-title">分析模型选择</div>
          <div class="mb-3">
            <label class="form-label">电力系统分析模型</label>
            <select class="form-select" name="model" id="analysisModel">
              <option value="time_domain" selected>时域分析模型</option>
              <option value="freq_domain">频域分析模型</option>
              <option value="fourier">电力谐波分析</option>
              <option value="wavelet">暂态分析模型</option>
              <option value="neural">电能质量评估</option>
            </select>
          </div>
          
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="filterSwitch" name="enable_filter" checked>
            <label class="form-check-label" for="filterSwitch">启用电力滤波器</label>
          </div>
        </div>
        
        <div class="param-group">
          <div class="section-title">显示参数</div>
          <div class="mb-3" id="displayPointsGroup">
            <label class="form-label">显示数据点数: <span id="maxPointsValue">1000</span></label>
            <input type="range" class="form-range" name="max_points" min="200" max="5000" value="1000" id="maxPointsSlider">
            <small class="form-text text-muted" id="displayPointsHelp">控制波形显示的精度</small>
          </div>
          
          <div class="mb-3" id="windowSizeGroup" style="display: none;">
            <label class="form-label">滤波窗口: <span id="windowSizeValue">15</span></label>
            <input type="range" class="form-range" name="window_size" min="5" max="50" value="15" id="windowSizeSlider">
            <small class="form-text text-muted">电力系统噪声滤波窗口</small>
          </div>
          
          <div class="form-check form-switch mb-3" id="multiPhaseOption" style="display: none;">
            <input class="form-check-input" type="checkbox" id="showAllPhasesSwitch">
            <label class="form-check-label" for="showAllPhasesSwitch">同时显示多相</label>
            <small class="form-text text-muted">在一个图表中显示所有相位</small>
          </div>
        </div>
        
        <div class="param-group">
          <div class="section-title">可视化设置</div>
          <div class="mb-3" id="dcColorGroup" style="display: none;">
            <label class="form-label">直流颜色</label>
            <input type="color" class="form-control form-control-color" name="dc_color" id="dcColor" value="#9b59b6">
          </div>
          
          <div class="mb-3" id="singlePhaseColorGroup">
            <label class="form-label">单相颜色</label>
            <input type="color" class="form-control form-control-color" name="single_phase_color" id="singlePhaseColor" value="#3498db">
          </div>
          
          <div id="threePhaseColorGroup" style="display: none;">
            <div class="mb-3">
              <label class="form-label">A相颜色</label>
              <input type="color" class="form-control form-control-color" name="phase_a_color" id="phaseAColor" value="#e74c3c">
            </div>
            
            <div class="mb-3">
              <label class="form-label">B相颜色</label>
              <input type="color" class="form-control form-control-color" name="phase_b_color" id="phaseBColor" value="#f39c12">
            </div>
            
            <div class="mb-3">
              <label class="form-label">C相颜色</label>
              <input type="color" class="form-control form-control-color" name="phase_c_color" id="phaseCColor" value="#3498db">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">线条粗细: <span id="lineWidthValue">2</span>px</label>
            <input type="range" class="form-range" name="line_width" min="1" max="5" value="2" id="lineWidthSlider">
          </div>
          
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="animationSwitch" name="enable_animation" checked>
            <label class="form-check-label" for="animationSwitch">启用动画效果</label>
          </div>
          
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="pointsSwitch" name="show_points">
            <label class="form-check-label" for="pointsSwitch">显示数据点</label>
          </div>
        </div>
        
        <button type="button" class="btn btn-success" id="startMonitorBtn">
          <i class="fas fa-eye me-2"></i>开始实时监控
        </button>
        
        <button type="button" class="btn btn-warning mt-2" id="stopMonitorBtn" style="display: none;">
          <i class="fas fa-stop me-2"></i>停止监控
        </button>
        
        <button type="button" class="btn btn-primary mt-2" id="analyzeBtn">
          <i class="fas fa-calculator me-2"></i><span id="analyzeBtnText">执行深度分析</span>
        </button>
      </form>
    </div>
    
    <div class="main-content">
      <div class="top-bar">
        <div>
          <h2 class="mb-0">
            <i class="fas fa-bolt me-2" style="color: var(--primary-color);"></i>
            支持示波器模式的电力实时波形分析平台
          </h2>
          <p class="text-muted mb-0">支持a0(直流)、a1(单相)、a2(三相) · 示波器样式滚动 · 实时监控与深度分析</p>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="connection-status connecting" id="connectionStatus">
            <div class="status-indicator connecting"></div>
            <span>连接中...</span>
          </div>
          <div class="realtime-indicator" id="realtimeIndicator" style="display: none;">
            <div class="realtime-dot"></div>
            <span>实时监控</span>
          </div>
        </div>
      </div>
      
      <div id="messageArea"></div>
      
      <div class="power-system-overview" id="powerSystemOverview">
        <h5><i class="fas fa-bolt me-2"></i><span id="overviewTitle">电力系统实时状态</span></h5>
        <div class="power-values" id="powerValues">
          <!-- 动态内容 -->
        </div>
      </div>
      
      <div class="client-selection">
        <h5 class="mb-3">
          <i class="fas fa-server me-2"></i>电力数据源客户端
          <button class="btn btn-outline-primary btn-sm float-end" id="refreshClientsBtn">
            <i class="fas fa-sync-alt me-1"></i>刷新
          </button>
        </h5>
        <div class="client-list" id="clientList">
          <div class="text-center text-muted py-3">
            <i class="fas fa-spin fa-spinner me-2"></i>
            正在加载电力客户端列表...
          </div>
        </div>
      </div>
      
      <div class="chart-container" id="chartContainer">
        <div class="chart-title">
          <span id="chartTitle">
            <i class="fas fa-chart-line me-2"></i>电力实时波形 - 等待数据源
          </span>
          <div class="chart-controls">
            <div class="phase-toggle" id="phaseToggles" style="display: none;">
              <!-- 动态生成相位控制 -->
            </div>
            <div class="oscilloscope-info" id="oscilloscopeInfo">
              <i class="fas fa-tv me-1"></i>
              示波器模式 | 滚动: <span id="currentSpeed">50ms</span> | 
              缓冲: <span id="currentBuffer">1000</span>点 | 
              模式: <span id="currentMode">单相</span>
            </div>
            <span class="text-muted" id="updateTime">等待数据源...</span>
          </div>
        </div>
        <canvas id="waveChart"></canvas>
      </div>
      
      <div class="stats-container" id="statsContainer">
        <h5 class="mb-3"><i class="fas fa-calculator me-2"></i>电力系统深度分析结果</h5>
        <div class="stats-grid" id="statsGrid">
          <div class="text-center text-muted py-3">
            选择电力数据源客户端并执行分析
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let waveChart = null;
    let websocket = null;
    let selectedClientId = null;
    let currentWorkMode = 'single_phase';
    let isMonitoring = false;
    let isAnalyzing = false;
    let currentAnalysisMode = 'monitoring';
    let webClientId = 'web_' + Math.random().toString(36).substr(2, 9);
    let currentAnalysisData = null;
    let visiblePhases = new Set(['voltage']);
    let realtimeUpdateInterval = null;
    let isConnected = false;
    
    // 示波器模式相关变量
    let oscilloscopeMode = false;
    let scrollSpeed = 50; // ms per point
    let bufferSize = 1000; // 显示的数据点数
    let updateRate = 10; // 每次更新的点数
    let oscilloscopeData = {};
    let phaseOffsets = {}; // 各相位的相位偏移
    let timeOffset = 0; // 时间偏移
    let oscilloscopeInterval = null;
    let lastRMSValues = {}; // 存储最后的有效值，用于平滑过渡
    let targetRMSValues = {}; // 目标有效值
    let rmsTransitionSpeed = 0.05; // RMS值过渡速度
    
    // 波形生成参数
    const waveformParams = {
      frequency: 50, // 50Hz
      samplingRate: 20000, // 20kHz
      pointsPerCycle: 400, // 每周期400点
      dc: {
        voltage: { default: 12.0 },
        current: { default: 1.0 }
      },
      single_phase: {
        voltage: { default: 0.01 },
        current: { default: 10 }
      },
      three_phase: {
        voltage: { default: 0.01 },
        current: { default: 10 }
      }
    };
    
    // 工作模式映射
    const workModeMap = {
      'a0': 'dc',
      'a1': 'single_phase',
      'a2': 'three_phase'
    };
    
    // 电力系统颜色配置
    const powerColors = {
      dc: '#9b59b6',
      single_phase: '#3498db',
      phase_a: '#e74c3c',
      phase_b: '#f39c12', 
      phase_c: '#3498db',
      // 示波器模式颜色
      oscilloscope: {
        dc: '#9b59b6',
        single_phase: '#00ff88',
        phase_a: '#ff4444',
        phase_b: '#ffaa00',
        phase_c: '#44aaff',
        voltage: '#00ff88',
        current: '#ffaa00'
      }
    };
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      initChart();
      setupEventListeners();
      connectWebSocket();
      loadDataSourceClients();
      setupSliders();
      setupWorkModeToggle();
      setupOscilloscopeMode();
    });
    
    // 初始化图表
    function initChart() {
      const ctx = document.getElementById('waveChart').getContext('2d');
      waveChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: []
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#333',
                usePointStyle: true,
                pointStyle: 'line'
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                title: function(context) {
                  return `采样点: ${context[0].label}`;
                },
                label: function(context) {
                  const unit = getUnitForDataset(context.dataset.label);
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(3)}${unit}`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              display: true,
              title: {
                display: true,
                text: '时间序列',
                color: '#333'
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              },
              ticks: {
                color: '#333'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: '幅值',
                color: '#333'
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              },
              ticks: {
                color: '#333'
              }
            }
          },
          elements: {
            point: {
              radius: 0,
              hoverRadius: 5
            },
            line: {
              borderWidth: 2,
              tension: 0.1
            }
          },
          animation: {
            duration: 0
          }
        }
      });
    }
    
    // 获取数据集对应的单位
    function getUnitForDataset(label) {
      if (label.includes('电压') || label.includes('voltage')) return 'V';
      if (label.includes('电流') || label.includes('current')) return 'A';
      return '';
    }
    
    // 设置示波器模式
    function setupOscilloscopeMode() {
      const oscilloscopeToggle = document.getElementById('oscilloscopeMode');
      const oscilloscopeParams = document.getElementById('oscilloscopeParams');
      const oscilloscopeControls = document.getElementById('oscilloscopeControls');
      
      oscilloscopeToggle.addEventListener('change', function() {
        oscilloscopeMode = this.checked;
        
        if (oscilloscopeMode) {
          oscilloscopeParams.classList.add('active');
          oscilloscopeControls.classList.add('active');
          enableOscilloscopeMode();
          showSuccess('示波器模式已启用');
        } else {
          oscilloscopeParams.classList.remove('active');
          oscilloscopeControls.classList.remove('active');
          disableOscilloscopeMode();
          showSuccess('示波器模式已关闭');
        }
      });
    }
    
    // 启用示波器模式
    function enableOscilloscopeMode() {
      const chartContainer = document.getElementById('chartContainer');
      chartContainer.classList.add('oscilloscope-mode');

      // 更新图表样式为示波器风格
      updateChartForOscilloscope(true);

      // 同步显示参数
      syncDisplayPointsWithBuffer(bufferSize);

      // 初始化示波器数据结构
      initializeOscilloscopeDataStructure();

      // 立即开始示波器显示（使用模拟数据）
      startOscilloscopeDemo();
    }
    
    // 禁用示波器模式
    function disableOscilloscopeMode() {
      const chartContainer = document.getElementById('chartContainer');
      chartContainer.classList.remove('oscilloscope-mode');

      // 恢复普通图表样式
      updateChartForOscilloscope(false);

      // 恢复显示参数说明
      const displayPointsHelp = document.getElementById('displayPointsHelp');
      displayPointsHelp.textContent = '控制波形显示的精度';

      // 停止示波器更新
      if (oscilloscopeInterval) {
        clearInterval(oscilloscopeInterval);
        oscilloscopeInterval = null;
      }
    }

    // 开始示波器演示模式（使用模拟数据）
    function startOscilloscopeDemo() {
      // 如果已经在监控中，不启动演示模式
      if (isMonitoring) {
        return;
      }

      // 启动示波器更新定时器
      if (oscilloscopeInterval) {
        clearInterval(oscilloscopeInterval);
      }

      oscilloscopeInterval = setInterval(() => {
        updateOscilloscopeData();
        updateOscilloscopeDisplay();
      }, scrollSpeed);

      console.log('Oscilloscope demo mode started');
    }
    
    // 初始化示波器数据结构
    function initializeOscilloscopeDataStructure() {
      oscilloscopeData = {};
      phaseOffsets = {};
      lastRMSValues = {};
      targetRMSValues = {};
      timeOffset = 0;
      
      // 根据当前工作模式初始化数据结构
      if (currentWorkMode === 'dc') {
        oscilloscopeData.voltage = [];
        oscilloscopeData.current = [];
        phaseOffsets.voltage = 0;
        phaseOffsets.current = 0;
        lastRMSValues.voltage = waveformParams.dc.voltage.default;
        lastRMSValues.current = waveformParams.dc.current.default;
        targetRMSValues.voltage = waveformParams.dc.voltage.default;
        targetRMSValues.current = waveformParams.dc.current.default;
      } else if (currentWorkMode === 'three_phase') {
        ['voltage_a', 'voltage_b', 'voltage_c', 'current_a', 'current_b', 'current_c'].forEach(key => {
          oscilloscopeData[key] = [];
          phaseOffsets[key] = key.includes('_a') ? 0 : key.includes('_b') ? -2*Math.PI/3 : -4*Math.PI/3;
          lastRMSValues[key] = waveformParams.three_phase[key.includes('voltage') ? 'voltage' : 'current'].default;
          targetRMSValues[key] = waveformParams.three_phase[key.includes('voltage') ? 'voltage' : 'current'].default;
        });
      } else {
        oscilloscopeData.voltage = [];
        oscilloscopeData.current = [];
        phaseOffsets.voltage = 0;
        phaseOffsets.current = -Math.PI/6; // 功率因数角度
        lastRMSValues.voltage = waveformParams.single_phase.voltage.default;
        lastRMSValues.current = waveformParams.single_phase.current.default;
        targetRMSValues.voltage = waveformParams.single_phase.voltage.default;
        targetRMSValues.current = waveformParams.single_phase.current.default;
      }
      
      // 生成初始数据
      generateInitialOscilloscopeData();
    }
    
    // 生成初始示波器数据
    function generateInitialOscilloscopeData() {
      for (let i = 0; i < bufferSize; i++) {
        Object.keys(oscilloscopeData).forEach(key => {
          const value = generateWaveformPoint(key, timeOffset + i);
          oscilloscopeData[key].push({
            x: i,
            y: value
          });
        });
      }
      timeOffset += bufferSize;
    }
    
    // 生成波形数据点
    function generateWaveformPoint(type, timeIndex) {
      const omega = 2 * Math.PI * waveformParams.frequency;
      const time = timeIndex / waveformParams.samplingRate;
      
      // 获取当前RMS值（平滑过渡）
      const currentRMS = lastRMSValues[type] || 0;
      
      if (currentWorkMode === 'dc') {
        // 直流波形：添加少量噪声模拟真实情况
        const noise = (Math.random() - 0.5) * Math.abs(currentRMS) * 0.02;
        return currentRMS + noise;
      } else {
        // 交流波形：基波 + 谐波 + 噪声
        const peak = currentRMS * Math.sqrt(2);
        const phaseOffset = phaseOffsets[type] || 0;
        
        const fundamental = peak * Math.sin(omega * time + phaseOffset);
        const harmonic3 = peak * 0.05 * Math.sin(3 * omega * time + 3 * phaseOffset);
        const harmonic5 = peak * 0.02 * Math.sin(5 * omega * time + 5 * phaseOffset);
        const noise = (Math.random() - 0.5) * peak * 0.01;
        
        return fundamental + harmonic3 + harmonic5 + noise;
      }
    }
    
    // 更新示波器数据
    function updateOscilloscopeData() {
      // 平滑过渡RMS值
      Object.keys(lastRMSValues).forEach(key => {
        const target = targetRMSValues[key] || lastRMSValues[key];
        const current = lastRMSValues[key];
        const diff = target - current;
        lastRMSValues[key] = current + diff * rmsTransitionSpeed;
      });
      
      // 生成新的数据点
      for (let i = 0; i < updateRate; i++) {
        Object.keys(oscilloscopeData).forEach(key => {
          const newValue = generateWaveformPoint(key, timeOffset + i);
          
          // 移除旧数据，添加新数据
          oscilloscopeData[key].shift();
          oscilloscopeData[key].push({
            x: oscilloscopeData[key].length,
            y: newValue
          });
        });
      }
      
      // 重新索引所有数据点的x坐标
      Object.keys(oscilloscopeData).forEach(key => {
        oscilloscopeData[key].forEach((point, index) => {
          point.x = index;
        });
      });
      
      timeOffset += updateRate;
      
      // 更新相位偏移以保持波形连续性
      if (currentWorkMode !== 'dc') {
        const phaseIncrement = (2 * Math.PI * waveformParams.frequency * updateRate) / waveformParams.samplingRate;
        Object.keys(phaseOffsets).forEach(key => {
          phaseOffsets[key] += phaseIncrement;
          if (phaseOffsets[key] > 2 * Math.PI) {
            phaseOffsets[key] -= 2 * Math.PI;
          }
        });
      }
    }
    
    // 更新图表样式
    function updateChartForOscilloscope(isOscilloscope) {
      if (!waveChart) return;
      
      const options = waveChart.options;
      
      if (isOscilloscope) {
        // 示波器样式
        options.plugins.legend.labels.color = '#00ff88';
        options.scales.x.title.color = '#00ff88';
        options.scales.x.ticks.color = '#00ff88';
        options.scales.x.grid.color = 'rgba(0, 51, 102, 0.5)';
        options.scales.y.title.color = '#00ff88';
        options.scales.y.ticks.color = '#00ff88';
        options.scales.y.grid.color = 'rgba(0, 51, 102, 0.5)';
      } else {
        // 普通样式
        options.plugins.legend.labels.color = '#333';
        options.scales.x.title.color = '#333';
        options.scales.x.ticks.color = '#333';
        options.scales.x.grid.color = 'rgba(0,0,0,0.1)';
        options.scales.y.title.color = '#333';
        options.scales.y.ticks.color = '#333';
        options.scales.y.grid.color = 'rgba(0,0,0,0.1)';
      }
      
      waveChart.update('none');
    }
    
    // 设置工作模式切换
    function setupWorkModeToggle() {
      const monitoringMode = document.getElementById('monitoringMode');
      const analysisMode = document.getElementById('analysisMode');
      const analysisOptions = document.getElementById('analysisOptions');
      const windowSizeGroup = document.getElementById('windowSizeGroup');
      const statsContainer = document.getElementById('statsContainer');
      const appContainer = document.getElementById('appContainer');
      
      function updateWorkMode() {
        const selectedMode = document.querySelector('input[name="workMode"]:checked').value;
        currentAnalysisMode = selectedMode;
        
        if (selectedMode === 'monitoring') {
          analysisOptions.style.display = 'none';
          windowSizeGroup.style.display = 'none';
          statsContainer.style.display = 'none';
          appContainer.classList.remove('analysis-mode');
          appContainer.classList.add('monitoring-mode');
        } else {
          analysisOptions.style.display = 'block';
          windowSizeGroup.style.display = 'block';
          statsContainer.style.display = 'block';
          appContainer.classList.remove('monitoring-mode');
          appContainer.classList.add('analysis-mode');
        }
      }
      
      monitoringMode.addEventListener('change', updateWorkMode);
      analysisMode.addEventListener('change', updateWorkMode);
      
      updateWorkMode();
    }
    
    // 设置事件监听器
    function setupEventListeners() {
      document.getElementById('analyzeBtn').addEventListener('click', performAnalysis);
      document.getElementById('startMonitorBtn').addEventListener('click', startMonitoring);
      document.getElementById('stopMonitorBtn').addEventListener('click', stopMonitoring);
      document.getElementById('refreshClientsBtn').addEventListener('click', loadDataSourceClients);
      
      document.getElementById('clientSelect').addEventListener('change', function() {
        selectedClientId = this.value;
        if (selectedClientId) {
          updateClientSelection(selectedClientId);
        }
      });
      
      document.getElementById('columnSelect').addEventListener('change', function() {
        if (isMonitoring && selectedClientId) {
          if (oscilloscopeMode) {
            // 示波器模式下立即更新显示
            updateOscilloscopeDisplay();
          } else {
            setTimeout(updateRealtimeChart, 200);
          }
        }
      });
      
      // 监听多相显示开关
      document.getElementById('showAllPhasesSwitch')?.addEventListener('change', function() {
        if (currentWorkMode === 'three_phase' && selectedClientId) {
          if (this.checked) {
            setupThreePhaseToggles();
          } else {
            hideSinglePhaseToggles();
          }
          
          if (oscilloscopeMode) {
            updateOscilloscopeDisplay();
          } else if (currentAnalysisData) {
            updateChart(currentAnalysisData);
          }
        }
      });
    }
    
    // 设置滑块
    function setupSliders() {
      const maxPointsSlider = document.getElementById('maxPointsSlider');
      const windowSizeSlider = document.getElementById('windowSizeSlider');
      const lineWidthSlider = document.getElementById('lineWidthSlider');
      const scrollSpeedSlider = document.getElementById('scrollSpeedSlider');
      const bufferSizeSlider = document.getElementById('bufferSizeSlider');
      const updateRateSlider = document.getElementById('updateRateSlider');
      
      maxPointsSlider.addEventListener('input', function() {
        const newValue = parseInt(this.value);
        document.getElementById('maxPointsValue').textContent = newValue;

        // 如果示波器模式开启，同步更新缓冲区大小
        if (oscilloscopeMode) {
          syncBufferWithDisplayPoints(newValue);
        }
      });
      
      windowSizeSlider.addEventListener('input', function() {
        document.getElementById('windowSizeValue').textContent = this.value;
      });
      
      lineWidthSlider.addEventListener('input', function() {
        document.getElementById('lineWidthValue').textContent = this.value;
        updateChartLineWidth(parseInt(this.value));
      });
      
      // 示波器相关滑块
      scrollSpeedSlider.addEventListener('input', function() {
        scrollSpeed = parseInt(this.value);
        document.getElementById('scrollSpeedValue').textContent = scrollSpeed;
        updateSpeedText();
        updateOscilloscopeInfo();

        // 重新启动示波器更新
        if (oscilloscopeMode && isMonitoring) {
          restartOscilloscopeUpdate();
        }
      });

      // 示波器背景颜色控制
      const oscilloscopeBgColor = document.getElementById('oscilloscopeBgColor');
      const resetBgColorBtn = document.getElementById('resetBgColorBtn');

      oscilloscopeBgColor.addEventListener('input', function() {
        updateOscilloscopeBackgroundColor(this.value);
      });

      resetBgColorBtn.addEventListener('click', function() {
        const defaultColor = '#001122';
        oscilloscopeBgColor.value = defaultColor;
        updateOscilloscopeBackgroundColor(defaultColor);
      });
      
      bufferSizeSlider.addEventListener('input', function() {
        const newBufferSize = parseInt(this.value);
        document.getElementById('bufferSizeValue').textContent = newBufferSize;
        updateOscilloscopeInfo();

        // 同步更新显示数据点数
        syncDisplayPointsWithBuffer(newBufferSize);

        // 调整缓冲区大小
        if (oscilloscopeMode) {
          resizeOscilloscopeBuffer(newBufferSize);
        }

        bufferSize = newBufferSize;
      });
      
      updateRateSlider.addEventListener('input', function() {
        updateRate = parseInt(this.value);
        document.getElementById('updateRateValue').textContent = updateRate;
      });
    }
    
    // 调整示波器缓冲区大小
    function resizeOscilloscopeBuffer(newSize) {
      Object.keys(oscilloscopeData).forEach(key => {
        if (oscilloscopeData[key].length > newSize) {
          // 缩小缓冲区：保留最新数据
          oscilloscopeData[key] = oscilloscopeData[key].slice(-newSize);
        } else if (oscilloscopeData[key].length < newSize) {
          // 扩大缓冲区：在前面补充数据
          const needMore = newSize - oscilloscopeData[key].length;
          for (let i = 0; i < needMore; i++) {
            const value = generateWaveformPoint(key, timeOffset - needMore + i);
            oscilloscopeData[key].unshift({
              x: 0,
              y: value
            });
          }
        }
        
        // 重新索引
        oscilloscopeData[key].forEach((point, index) => {
          point.x = index;
        });
      });
    }
    
    // 更新速度文本
    function updateSpeedText() {
      const speedText = document.getElementById('speedText');
      if (scrollSpeed <= 30) {
        speedText.textContent = '高速';
      } else if (scrollSpeed <= 80) {
        speedText.textContent = '中等速度';
      } else {
        speedText.textContent = '低速';
      }
    }
    
    // 更新示波器信息显示
    function updateOscilloscopeInfo() {
      document.getElementById('currentSpeed').textContent = scrollSpeed + 'ms';
      document.getElementById('currentBuffer').textContent = bufferSize;
      document.getElementById('currentMode').textContent =
        currentWorkMode === 'dc' ? '直流' :
        currentWorkMode === 'three_phase' ? '三相' : '单相';
    }

    // 更新示波器背景颜色
    function updateOscilloscopeBackgroundColor(color) {
      // 更新CSS变量
      document.documentElement.style.setProperty('--oscilloscope-bg', color);

      // 计算网格颜色（比背景颜色稍亮）
      const gridColor = lightenColor(color, 0.3);
      document.documentElement.style.setProperty('--oscilloscope-grid', gridColor);

      console.log('Oscilloscope background color updated to:', color);
    }

    // 颜色亮度调整函数
    function lightenColor(color, factor) {
      // 将十六进制颜色转换为RGB
      const hex = color.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);

      // 增加亮度
      const newR = Math.min(255, Math.floor(r + (255 - r) * factor));
      const newG = Math.min(255, Math.floor(g + (255 - g) * factor));
      const newB = Math.min(255, Math.floor(b + (255 - b) * factor));

      // 转换回十六进制
      return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
    }

    // 同步显示数据点数与缓冲区大小
    function syncDisplayPointsWithBuffer(bufferSize) {
      const maxPointsSlider = document.getElementById('maxPointsSlider');
      const maxPointsValue = document.getElementById('maxPointsValue');
      const displayPointsHelp = document.getElementById('displayPointsHelp');

      if (oscilloscopeMode) {
        maxPointsSlider.value = bufferSize;
        maxPointsValue.textContent = bufferSize;
        displayPointsHelp.textContent = '示波器模式：与缓冲区大小同步';
      } else {
        displayPointsHelp.textContent = '控制波形显示的精度';
      }
    }

    // 同步缓冲区大小与显示数据点数
    function syncBufferWithDisplayPoints(displayPoints) {
      const bufferSizeSlider = document.getElementById('bufferSizeSlider');
      const bufferSizeValue = document.getElementById('bufferSizeValue');

      if (oscilloscopeMode) {
        bufferSizeSlider.value = displayPoints;
        bufferSizeValue.textContent = displayPoints;
        bufferSize = displayPoints;

        // 调整缓冲区大小
        resizeOscilloscopeBuffer(displayPoints);
        updateOscilloscopeInfo();
      }
    }
    
    // 更新图表线条粗细
    function updateChartLineWidth(width) {
      if (waveChart && waveChart.data.datasets) {
        waveChart.data.datasets.forEach(dataset => {
          dataset.borderWidth = width;
        });
        waveChart.update('none');
      }
    }
    
    // 初始化WebSocket连接
    function connectWebSocket() {
      if (websocket) {
        websocket.close();
      }
      
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws/${webClientId}`;
      
      try {
        websocket = new WebSocket(wsUrl);
        
        websocket.onopen = function(event) {
          console.log('WebSocket connected');
          isConnected = true;
          updateConnectionStatus('connected', '已连接');
          websocket.send(JSON.stringify({type: 'get_client_list'}));
          startHeartbeat();
        };
        
        websocket.onmessage = function(event) {
          const message = JSON.parse(event.data);
          handleWebSocketMessage(message);
        };
        
        websocket.onclose = function(event) {
          console.log('WebSocket disconnected');
          isConnected = false;
          updateConnectionStatus('disconnected', '连接断开');
          stopHeartbeat();
          setTimeout(connectWebSocket, 3000);
        };
        
        websocket.onerror = function(error) {
          console.error('WebSocket error:', error);
          isConnected = false;
          updateConnectionStatus('disconnected', '连接错误');
        };
        
      } catch (error) {
        console.error('WebSocket connection failed:', error);
        isConnected = false;
        updateConnectionStatus('disconnected', '连接失败');
      }
    }
    
    // 心跳机制
    let heartbeatInterval = null;
    
    function startHeartbeat() {
      heartbeatInterval = setInterval(() => {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(JSON.stringify({type: 'ping'}));
        }
      }, 30000);
    }
    
    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }
    
    // 处理WebSocket消息
    function handleWebSocketMessage(message) {
      console.log('Received message:', message);
      
      switch (message.type) {
        case 'client_list_update':
          updateClientList(message.clients);
          break;
          
        case 'monitoring_started':
          showSuccess(`开始监控电力客户端: ${message.data_source_client}`);
          updateMonitoringStatus(true);
          
          if (message.power_type) {
            updateWorkModeDisplay(message.power_type);
          }
          break;
          
        case 'monitoring_stopped':
          showSuccess('已停止电力监控');
          updateMonitoringStatus(false);
          break;
          
        case 'realtime_data_update':
          if (message.client_id === selectedClientId && isMonitoring) {
            console.log('Received realtime data:', message.data);
            showTransmissionStatus();
            updatePowerSystemOverview(message.data);
            
            // 更新目标RMS值用于示波器模式
            if (oscilloscopeMode) {
              updateTargetRMSValues(message.data);
            }
            
            if (currentAnalysisMode === 'monitoring') {
              if (oscilloscopeMode) {
                // 示波器模式不需要额外的图表更新，数据在定时器中更新
              } else {
                setTimeout(updateRealtimeChart, 100);
              }
            }
          }
          break;
          
        case 'pong':
          console.log('Received pong');
          break;
          
        default:
          console.log('Unknown message type:', message.type);
      }
    }
    
    // 更新目标RMS值
    function updateTargetRMSValues(realtimeData) {
      if (!oscilloscopeMode) return;
      
      if (currentWorkMode === 'dc') {
        targetRMSValues.voltage = realtimeData.voltage || targetRMSValues.voltage;
        targetRMSValues.current = realtimeData.current || targetRMSValues.current;
      } else if (currentWorkMode === 'three_phase') {
        ['voltage_a', 'voltage_b', 'voltage_c', 'current_a', 'current_b', 'current_c'].forEach(key => {
          if (realtimeData[key] !== undefined) {
            targetRMSValues[key] = realtimeData[key];
          }
        });
      } else {
        targetRMSValues.voltage = realtimeData.voltage || targetRMSValues.voltage;
        targetRMSValues.current = realtimeData.current || targetRMSValues.current;
      }
    }
    
    // 显示传输状态
    function showTransmissionStatus() {
      const statusEl = document.getElementById('transmissionStatus');
      statusEl.classList.add('active');
      setTimeout(() => {
        statusEl.classList.remove('active');
      }, 2000);
    }
    
    // 重启示波器更新
    function restartOscilloscopeUpdate() {
      if (oscilloscopeInterval) {
        clearInterval(oscilloscopeInterval);
      }

      if (oscilloscopeMode) {
        oscilloscopeInterval = setInterval(() => {
          updateOscilloscopeData();
          updateOscilloscopeDisplay();
        }, scrollSpeed);
      }
    }
    
    // 更新示波器显示
    function updateOscilloscopeDisplay() {
      if (!waveChart || !oscilloscopeMode) return;
      
      const selectedColumn = document.getElementById('columnSelect').value;
      const showAllPhases = document.getElementById('showAllPhasesSwitch')?.checked || false;
      waveChart.data.datasets = [];
      
      const lineWidth = parseInt(document.getElementById('lineWidthSlider').value);
      
      if (currentWorkMode === 'three_phase' && showAllPhases) {
        // 三相模式：显示所有相位
        if (selectedColumn.includes('voltage')) {
          ['voltage_a', 'voltage_b', 'voltage_c'].forEach((phase, index) => {
            const phaseLabel = ['A相电压', 'B相电压', 'C相电压'][index];
            const phaseColor = [powerColors.oscilloscope.phase_a, powerColors.oscilloscope.phase_b, powerColors.oscilloscope.phase_c][index];
            
            if (oscilloscopeData[phase]) {
              waveChart.data.datasets.push({
                label: phaseLabel,
                data: [...oscilloscopeData[phase]],
                borderColor: phaseColor,
                backgroundColor: 'transparent',
                borderWidth: lineWidth,
                fill: false,
                tension: 0.1,
                pointRadius: 0
              });
            }
          });
        } else if (selectedColumn.includes('current')) {
          ['current_a', 'current_b', 'current_c'].forEach((phase, index) => {
            const phaseLabel = ['A相电流', 'B相电流', 'C相电流'][index];
            const phaseColor = [powerColors.oscilloscope.phase_a, powerColors.oscilloscope.phase_b, powerColors.oscilloscope.phase_c][index];
            
            if (oscilloscopeData[phase]) {
              waveChart.data.datasets.push({
                label: phaseLabel,
                data: [...oscilloscopeData[phase]],
                borderColor: phaseColor,
                backgroundColor: 'transparent',
                borderWidth: lineWidth,
                fill: false,
                tension: 0.1,
                pointRadius: 0
              });
            }
          });
        }
      } else {
        // 单参数显示
        const dataKey = currentWorkMode === 'three_phase' ? selectedColumn : 
                        selectedColumn === 'voltage' ? 'voltage' : 'current';
        
        if (oscilloscopeData[dataKey]) {
          const label = currentWorkMode === 'dc' ? 
            (dataKey === 'voltage' ? '直流电压' : '直流电流') :
            currentWorkMode === 'three_phase' ?
            (dataKey.includes('voltage') ? `${dataKey.split('_')[1].toUpperCase()}相电压` : 
             `${dataKey.split('_')[1].toUpperCase()}相电流`) :
            (dataKey === 'voltage' ? '电压' : '电流');
          
          const color = oscilloscopeMode ? 
            (dataKey.includes('voltage') ? powerColors.oscilloscope.voltage : powerColors.oscilloscope.current) :
            (currentWorkMode === 'dc' ? powerColors.dc : powerColors.single_phase);
          
          waveChart.data.datasets.push({
            label: label,
            data: [...oscilloscopeData[dataKey]],
            borderColor: color,
            backgroundColor: 'transparent',
            borderWidth: lineWidth,
            fill: false,
            tension: 0.1,
            pointRadius: 0
          });
        }
      }
      
      waveChart.update('none');
      
      // 更新时间显示
      document.getElementById('updateTime').textContent = `更新时间: ${new Date().toLocaleTimeString()}`;
    }
    
    // 实时更新图表
    async function updateRealtimeChart() {
      if (!selectedClientId || !isMonitoring || !isConnected || oscilloscopeMode) return;
      
      try {
        const formData = new FormData();
        formData.append('client_id', selectedClientId);
        formData.append('selected_column', document.getElementById('columnSelect').value);
        formData.append('model', 'time_domain');
        formData.append('enable_filter', false);
        formData.append('max_points', document.getElementById('maxPointsSlider').value);
        formData.append('window_size', '10');
        formData.append('show_all_phases', document.getElementById('showAllPhasesSwitch')?.checked || false);
        formData.append('analysis_mode', 'monitoring');
        
        const response = await fetch('/api/realtime_analyze', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.status === 'success') {
          updateChart(result.data, true);
          updateChartTitle(result.data, 'monitoring');
        } else {
          console.error('Realtime analysis failed:', result.message);
        }
        
      } catch (error) {
        console.error('Realtime chart update failed:', error);
      }
    }
    
    // 更新客户端列表
    function updateClientList(clients) {
      const clientList = document.getElementById('clientList');
      const clientSelect = document.getElementById('clientSelect');
      
      if (!clients || clients.length === 0) {
        clientList.innerHTML = `
          <div class="text-center text-muted py-3">
            <i class="fas fa-info-circle me-2"></i>
            暂无电力数据源客户端连接
          </div>
        `;
        
        clientSelect.innerHTML = '<option value="">请选择电力数据源客户端</option>';
        return;
      }
      
      clientList.innerHTML = clients.map(client => {
        const workModeClass = getWorkModeClass(client.power_type);
        const statusClass = client.status === 'connected' ? 'connected' : 'offline';
        const selectedClass = client.id === selectedClientId ? 'selected' : '';
        
        return `
          <div class="client-card ${workModeClass} ${statusClass} ${selectedClass}" 
               onclick="selectClient('${client.id}')">
            <div class="client-status ${statusClass}"></div>
            <div class="client-id">
              ${client.id}
              <span class="work-mode-indicator ${workModeClass}">
                <i class="fas fa-${getWorkModeIcon(client.power_type)}"></i>
                <span>${getWorkModeLabel(client.power_type)}</span>
              </span>
            </div>
            <div class="client-info">
              <span>数据量: ${client.data_count.toLocaleString()}</span>
              <span>状态: ${client.status === 'connected' ? '在线' : '离线'}</span>
            </div>
            <div class="client-info">
              <span>连接时间: ${client.connected_time}</span>
              <span>最后更新: ${client.last_update}</span>
            </div>
            <div class="client-info">
              <span>缓冲区: ${client.buffer_size || 0}</span>
              <span>模式: ${client.work_mode || 'auto'}</span>
            </div>
            <small class="text-muted">${client.description || '电力数据源客户端'}</small>
          </div>
        `;
      }).join('');
      
      // 更新选择框
      const currentValue = clientSelect.value;
      clientSelect.innerHTML = '<option value="">请选择电力数据源客户端</option>' +
        clients.map(client => 
          `<option value="${client.id}" ${client.id === currentValue ? 'selected' : ''}>
            ${client.id} (${getWorkModeLabel(client.power_type)})
          </option>`
        ).join('');
    }
    
    // 获取工作模式类名
    function getWorkModeClass(powerType) {
      switch(powerType) {
        case 'dc': return 'dc';
        case 'three_phase': return 'three-phase';
        case 'single_phase':
        default: return 'single-phase';
      }
    }
    
    // 获取工作模式图标
    function getWorkModeIcon(powerType) {
      switch(powerType) {
        case 'dc': return 'battery-half';
        case 'three_phase': return 'bolt';
        case 'single_phase':
        default: return 'plug';
      }
    }
    
    // 获取工作模式标签
    function getWorkModeLabel(powerType) {
      switch(powerType) {
        case 'dc': return '直流';
        case 'three_phase': return '三相';
        case 'single_phase':
        default: return '单相';
      }
    }
    
    // 选择客户端
    function selectClient(clientId) {
      selectedClientId = clientId;
      document.getElementById('clientSelect').value = clientId;
      
      document.querySelectorAll('.client-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      document.querySelector(`[onclick="selectClient('${clientId}')"]`)?.classList.add('selected');
      updateClientSelection(clientId);
    }
    
    // 更新客户端选择后的界面
    function updateClientSelection(clientId) {
      fetch('/api/data_source_clients')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const client = data.clients.find(c => c.id === clientId);
            if (client) {
              updateWorkModeDisplay(client.power_type);
            }
          }
        })
        .catch(error => {
          console.error('Failed to get client info:', error);
        });
    }
    
    // 更新工作模式显示
    function updateWorkModeDisplay(powerType) {
      currentWorkMode = powerType;
      const indicator = document.getElementById('workModeIndicator');
      const display = document.getElementById('workModeDisplay');
      const multiPhaseOption = document.getElementById('multiPhaseOption');
      const dcColorGroup = document.getElementById('dcColorGroup');
      const singlePhaseColorGroup = document.getElementById('singlePhaseColorGroup');
      const threePhaseColorGroup = document.getElementById('threePhaseColorGroup');
      
      display.style.display = 'block';
      
      if (powerType === 'dc') {
        indicator.className = 'work-mode-indicator dc';
        indicator.innerHTML = '<i class="fas fa-battery-half"></i><span>直流系统</span>';
        
        multiPhaseOption.style.display = 'none';
        dcColorGroup.style.display = 'block';
        singlePhaseColorGroup.style.display = 'none';
        threePhaseColorGroup.style.display = 'none';
        
        updateColumnOptions('dc');
        hideSinglePhaseToggles();
      } else if (powerType === 'three_phase') {
        indicator.className = 'work-mode-indicator three-phase';
        indicator.innerHTML = '<i class="fas fa-bolt"></i><span>三相电系统</span>';
        
        multiPhaseOption.style.display = 'block';
        dcColorGroup.style.display = 'none';
        singlePhaseColorGroup.style.display = 'none';
        threePhaseColorGroup.style.display = 'block';
        
        updateColumnOptions('three_phase');
        setupThreePhaseToggles();
      } else {
        indicator.className = 'work-mode-indicator single-phase';
        indicator.innerHTML = '<i class="fas fa-plug"></i><span>单相电系统</span>';
        
        multiPhaseOption.style.display = 'none';
        dcColorGroup.style.display = 'none';
        singlePhaseColorGroup.style.display = 'block';
        threePhaseColorGroup.style.display = 'none';
        
        updateColumnOptions('single_phase');
        hideSinglePhaseToggles();
      }
      
      // 重新初始化示波器数据结构
      if (oscilloscopeMode) {
        initializeOscilloscopeDataStructure();
      }
      
      updateOscilloscopeInfo();
    }
    
    // 更新列选项
    function updateColumnOptions(powerType) {
      const columnSelect = document.getElementById('columnSelect');
      columnSelect.innerHTML = '';
      
      if (powerType === 'dc') {
        const options = [
          {value: 'voltage', text: '直流电压 (V)'},
          {value: 'current', text: '直流电流 (I)'}
        ];
        
        options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option.value;
          opt.textContent = option.text;
          columnSelect.appendChild(opt);
        });
      } else if (powerType === 'three_phase') {
        const optGroups = [
          {
            label: '电压参数',
            options: [
              {value: 'voltage_a', text: 'A相电压 (Va)', indicator: 'phase-a'},
              {value: 'voltage_b', text: 'B相电压 (Vb)', indicator: 'phase-b'},
              {value: 'voltage_c', text: 'C相电压 (Vc)', indicator: 'phase-c'}
            ]
          },
          {
            label: '电流参数',
            options: [
              {value: 'current_a', text: 'A相电流 (Ia)', indicator: 'phase-a'},
              {value: 'current_b', text: 'B相电流 (Ib)', indicator: 'phase-b'},
              {value: 'current_c', text: 'C相电流 (Ic)', indicator: 'phase-c'}
            ]
          }
        ];
        
        optGroups.forEach(group => {
          const optGroup = document.createElement('optgroup');
          optGroup.label = group.label;
          
          group.options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.text;
            if (option.indicator) {
              opt.dataset.indicator = option.indicator;
            }
            optGroup.appendChild(opt);
          });
          
          columnSelect.appendChild(optGroup);
        });
      } else {
        const options = [
          {value: 'voltage', text: '电压 (V)'},
          {value: 'current', text: '电流 (I)'}
        ];
        
        options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option.value;
          opt.textContent = option.text;
          columnSelect.appendChild(opt);
        });
      }
      
      if (columnSelect.options.length > 0) {
        columnSelect.selectedIndex = 0;
      }
    }
    
    // 设置三相切换控件
    function setupThreePhaseToggles() {
      const phaseToggles = document.getElementById('phaseToggles');
      phaseToggles.style.display = 'flex';
      
      if (document.getElementById('showAllPhasesSwitch').checked) {
        phaseToggles.innerHTML = `
          <div class="phase-toggle">
            <input type="checkbox" class="phase-checkbox" id="phaseAToggle" checked>
            <label for="phaseAToggle">
              <span class="phase-indicator phase-a"></span>A相
            </label>
          </div>
          <div class="phase-toggle">
            <input type="checkbox" class="phase-checkbox" id="phaseBToggle" checked>
            <label for="phaseBToggle">
              <span class="phase-indicator phase-b"></span>B相
            </label>
          </div>
          <div class="phase-toggle">
            <input type="checkbox" class="phase-checkbox" id="phaseCToggle" checked>
            <label for="phaseCToggle">
              <span class="phase-indicator phase-c"></span>C相
            </label>
          </div>
        `;
        
        ['phaseAToggle', 'phaseBToggle', 'phaseCToggle'].forEach(id => {
          document.getElementById(id).addEventListener('change', updatePhaseVisibility);
        });
      } else {
        phaseToggles.innerHTML = '';
      }
    }
    
    // 隐藏单相切换控件
    function hideSinglePhaseToggles() {
      const phaseToggles = document.getElementById('phaseToggles');
      phaseToggles.style.display = 'none';
      phaseToggles.innerHTML = '';
    }
    
    // 更新相位可见性
    function updatePhaseVisibility() {
      if (!waveChart) return;
      
      const phaseAVisible = document.getElementById('phaseAToggle')?.checked || false;
      const phaseBVisible = document.getElementById('phaseBToggle')?.checked || false;
      const phaseCVisible = document.getElementById('phaseCToggle')?.checked || false;
      
      waveChart.data.datasets.forEach(dataset => {
        if (dataset.label.includes('A相') || dataset.label.includes('phase_a')) {
          dataset.hidden = !phaseAVisible;
        } else if (dataset.label.includes('B相') || dataset.label.includes('phase_b')) {
          dataset.hidden = !phaseBVisible;
        } else if (dataset.label.includes('C相') || dataset.label.includes('phase_c')) {
          dataset.hidden = !phaseCVisible;
        }
      });
      
      waveChart.update('none');
    }
    
    // 更新电力系统概览
    function updatePowerSystemOverview(data) {
      const overview = document.getElementById('powerSystemOverview');
      const overviewTitle = document.getElementById('overviewTitle');
      const powerValues = document.getElementById('powerValues');
      
      if (!data) {
        overview.style.display = 'none';
        return;
      }
      
      overview.style.display = 'block';
      
      if (currentWorkMode === 'dc') {
        overviewTitle.textContent = '直流系统实时状态';
        
        const values = [
          {label: '直流电压', value: (data.voltage || 0).toFixed(2) + 'V', class: 'dc'},
          {label: '直流电流', value: (data.current || 0).toFixed(3) + 'A', class: 'dc'}
        ];
        
        powerValues.innerHTML = values.map(v => `
          <div class="power-value">
            <div class="power-label">
              <span class="phase-indicator ${v.class}"></span>${v.label}
            </div>
            <div class="power-number">${v.value}</div>
          </div>
        `).join('');
      } else if (currentWorkMode === 'three_phase') {
        overviewTitle.textContent = '三相电系统实时状态';
        
        const values = [
          {label: 'A相电压', value: (data.voltage_a || 0).toFixed(1) + 'V', class: 'phase-a'},
          {label: 'B相电压', value: (data.voltage_b || 0).toFixed(1) + 'V', class: 'phase-b'},
          {label: 'C相电压', value: (data.voltage_c || 0).toFixed(1) + 'V', class: 'phase-c'}
        ];
        
        powerValues.innerHTML = values.map(v => `
          <div class="power-value">
            <div class="power-label">
              <span class="phase-indicator ${v.class}"></span>${v.label}
            </div>
            <div class="power-number">${v.value}</div>
          </div>
        `).join('');
      } else {
        overviewTitle.textContent = '单相电系统实时状态';
        
        const values = [
          {label: '电压', value: (data.voltage || 0).toFixed(1) + 'V'},
          {label: '电流', value: (data.current || 0).toFixed(2) + 'A'}
        ];
        
        powerValues.innerHTML = values.map(v => `
          <div class="power-value">
            <div class="power-label">
              <span class="phase-indicator single-phase"></span>${v.label}
            </div>
            <div class="power-number">${v.value}</div>
          </div>
        `).join('');
      }
    }
    
    // 开始监控
    async function startMonitoring() {
      if (!selectedClientId) {
        showError('请先选择电力数据源客户端');
        return;
      }
      
      if (!isConnected) {
        showError('WebSocket连接已断开，请等待重连');
        return;
      }
      
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
          type: 'start_monitoring',
          data_source_client: selectedClientId
        }));
        
        // 如果启用了示波器模式，初始化并启动示波器更新
        if (oscilloscopeMode) {
          initializeOscilloscopeDataStructure();
          restartOscilloscopeUpdate();
          showSuccess('示波器模式监控已启动');
        }
      } else {
        showError('WebSocket连接未建立');
      }
    }
    
    // 停止监控
    async function stopMonitoring() {
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
          type: 'stop_monitoring'
        }));
      }

      // 停止示波器更新
      if (oscilloscopeInterval) {
        clearInterval(oscilloscopeInterval);
        oscilloscopeInterval = null;
      }

      updateMonitoringStatus(false);

      // 如果示波器模式仍然开启，切换回演示模式
      if (oscilloscopeMode) {
        setTimeout(() => {
          startOscilloscopeDemo();
        }, 100);
      }
    }
    
    // 执行深度分析
    async function performAnalysis() {
      if (!selectedClientId) {
        showError('请先选择电力数据源客户端');
        return;
      }
      
      if (!isConnected) {
        showError('WebSocket连接已断开，请等待重连');
        return;
      }
      
      const analyzeBtn = document.getElementById('analyzeBtn');
      const analyzeBtnText = document.getElementById('analyzeBtnText');
      const originalText = analyzeBtnText.textContent;
      
      try {
        isAnalyzing = true;
        analyzeBtn.disabled = true;
        analyzeBtnText.innerHTML = '<span class="loading-spinner me-2"></span>深度分析中...';
        
        const formData = new FormData();
        formData.append('client_id', selectedClientId);
        formData.append('selected_column', document.getElementById('columnSelect').value);
        formData.append('model', document.getElementById('analysisModel').value);
        formData.append('enable_filter', document.getElementById('filterSwitch').checked);
        formData.append('max_points', document.getElementById('maxPointsSlider').value);
        formData.append('window_size', document.getElementById('windowSizeSlider').value);
        formData.append('show_all_phases', document.getElementById('showAllPhasesSwitch')?.checked || false);
        formData.append('analysis_mode', 'analysis');
        
        const response = await fetch('/api/realtime_analyze', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.status === 'success') {
          currentAnalysisData = result.data;
          
          // 如果不是示波器模式，更新图表
          if (!oscilloscopeMode) {
            updateChart(result.data, false);
            updateChartTitle(result.data, 'analysis');
          }
          
          updateStatistics(result.data.stats);
          showSuccess('深度分析完成：' + result.message);
          
          document.getElementById('statsContainer').style.display = 'block';
        } else {
          showError(result.message || '分析失败');
        }
        
      } catch (error) {
        console.error('Analysis failed:', error);
        showError('分析过程中发生错误: ' + error.message);
      } finally {
        isAnalyzing = false;
        analyzeBtn.disabled = false;
        analyzeBtnText.textContent = originalText;
      }
    }
    
    // 更新图表
    function updateChart(analysisData, isRealtimeMode = false) {
      if (!waveChart || oscilloscopeMode) return; // 示波器模式不使用此函数
      
      const selectedColumn = analysisData.selected_column;
      const powerType = analysisData.power_type;
      const showAllPhases = document.getElementById('showAllPhasesSwitch')?.checked || false;
      const isMultiPhase = analysisData.is_multi_phase || false;
      
      waveChart.data.datasets = [];
      
      if (powerType === 'three_phase' && showAllPhases && isMultiPhase) {
        const phaseColumns = {
          'voltage_a': {label: 'A相电压', color: powerColors.phase_a},
          'voltage_b': {label: 'B相电压', color: powerColors.phase_b},
          'voltage_c': {label: 'C相电压', color: powerColors.phase_c},
          'current_a': {label: 'A相电流', color: powerColors.phase_a},
          'current_b': {label: 'B相电流', color: powerColors.phase_b},
          'current_c': {label: 'C相电流', color: powerColors.phase_c}
        };
        
        const analysisColumns = analysisData.analysis_columns || [];
        
        analysisColumns.forEach(column => {
          if (phaseColumns[column] && analysisData.wave_data_dict && analysisData.wave_data_dict[column]) {
            waveChart.data.datasets.push({
              label: phaseColumns[column].label,
              data: analysisData.wave_data_dict[column],
              borderColor: phaseColumns[column].color,
              backgroundColor: phaseColumns[column].color + '20',
              borderWidth: parseInt(document.getElementById('lineWidthSlider').value),
              fill: false,
              tension: 0.1,
              pointRadius: document.getElementById('pointsSwitch').checked ? 1 : 0
            });
          }
        });
        
        setupThreePhaseToggles();
        
      } else {
        let lineColor = powerColors.single_phase;
        
        if (powerType === 'dc') {
          lineColor = document.getElementById('dcColor').value || powerColors.dc;
        } else if (powerType === 'three_phase') {
          lineColor = selectedColumn.includes('_a') ? powerColors.phase_a :
                      selectedColumn.includes('_b') ? powerColors.phase_b :
                      selectedColumn.includes('_c') ? powerColors.phase_c : powerColors.single_phase;
        } else {
          lineColor = document.getElementById('singlePhaseColor').value || powerColors.single_phase;
        }
        
        const labelMap = {
          'voltage': powerType === 'dc' ? '直流电压' : '电压',
          'current': powerType === 'dc' ? '直流电流' : '电流',
          'voltage_a': 'A相电压',
          'voltage_b': 'B相电压',
          'voltage_c': 'C相电压',
          'current_a': 'A相电流',
          'current_b': 'B相电流',
          'current_c': 'C相电流'
        };
        
        const waveData = analysisData.wave_data || (analysisData.wave_data_dict && analysisData.wave_data_dict[selectedColumn]);
        
        if (waveData && waveData.length > 0) {
          waveChart.data.datasets.push({
            label: labelMap[selectedColumn] || selectedColumn,
            data: waveData,
            borderColor: lineColor,
            backgroundColor: lineColor + '20',
            borderWidth: parseInt(document.getElementById('lineWidthSlider').value),
            fill: false,
            tension: 0.1,
            pointRadius: document.getElementById('pointsSwitch').checked ? 1 : 0
          });
        }
        
        hideSinglePhaseToggles();
      }
      
      const animationEnabled = document.getElementById('animationSwitch').checked && !isRealtimeMode;
      waveChart.update(animationEnabled ? 'default' : 'none');
    }
    
    // 更新图表标题
    function updateChartTitle(analysisData, mode = 'monitoring') {
      const chartTitle = document.getElementById('chartTitle');
      const updateTime = document.getElementById('updateTime');
      
      const columnLabels = {
        'voltage': analysisData.power_type === 'dc' ? '直流电压波形' : '电压波形',
        'current': analysisData.power_type === 'dc' ? '直流电流波形' : '电流波形',
        'voltage_a': 'A相电压波形',
        'voltage_b': 'B相电压波形', 
        'voltage_c': 'C相电压波形',
        'current_a': 'A相电流波形',
        'current_b': 'B相电流波形',
        'current_c': 'C相电流波形'
      };
      
      const powerTypeText = analysisData.power_type === 'dc' ? '直流' : 
                           analysisData.power_type === 'three_phase' ? '三相电' : '单相电';
      const columnLabel = columnLabels[analysisData.selected_column] || analysisData.selected_column;
      const modeText = oscilloscopeMode ? '示波器模式' : 
                       mode === 'monitoring' ? '实时监控' : '深度分析';
      
      chartTitle.innerHTML = `
        <i class="fas fa-${oscilloscopeMode ? 'desktop' : 'chart-line'} me-2"></i>
        ${powerTypeText}${columnLabel} - ${modeText} - ${analysisData.client_id}
      `;
      
      updateTime.textContent = `更新时间: ${new Date().toLocaleTimeString()}`;
    }
    
    // 更新统计信息
    function updateStatistics(stats) {
      const statsGrid = document.getElementById('statsGrid');
      
      if (!stats || Object.keys(stats).length === 0) {
        statsGrid.innerHTML = '<div class="text-center text-muted py-3">暂无统计数据</div>';
        return;
      }
      
      let statCards = [];
      
      if (typeof stats === 'object' && !stats.title) {
        Object.entries(stats).forEach(([phase, phaseStats]) => {
          if (phaseStats && typeof phaseStats === 'object') {
            Object.entries(phaseStats).forEach(([key, stat]) => {
              if (stat && stat.title) {
                const phaseClass = getStatCardClass(phase, currentWorkMode);
                const phaseLabel = getPhaseLabel(phase, currentWorkMode);
                
                statCards.push(`
                  <div class="stat-card ${phaseClass}">
                    <div class="stat-title">
                      <i class="${stat.icon || 'fas fa-chart-bar'}"></i>
                      ${phaseLabel}${stat.title}
                    </div>
                    <div class="stat-value">
                      ${stat.value} <small>${stat.unit || ''}</small>
                    </div>
                  </div>
                `);
              }
            });
          }
        });
      } else {
        Object.entries(stats).forEach(([key, stat]) => {
          if (stat && stat.title) {
            const phaseClass = getStatCardClass(key, currentWorkMode);
            
            statCards.push(`
              <div class="stat-card ${phaseClass}">
                <div class="stat-title">
                  <i class="${stat.icon || 'fas fa-chart-bar'}"></i>
                  ${stat.title}
                </div>
                <div class="stat-value">
                  ${stat.value} <small>${stat.unit || ''}</small>
                </div>
              </div>
            `);
          }
        });
      }
      
      if (statCards.length > 0) {
        statsGrid.innerHTML = statCards.join('');
      } else {
        statsGrid.innerHTML = '<div class="text-center text-muted py-3">暂无统计数据</div>';
      }
    }
    
    // 获取统计卡片类名
    function getStatCardClass(key, workMode) {
      if (workMode === 'dc') {
        return 'dc';
      } else if (workMode === 'three_phase') {
        if (key.includes('_a') || key.includes('phase_a')) return 'phase-a';
        if (key.includes('_b') || key.includes('phase_b')) return 'phase-b';
        if (key.includes('_c') || key.includes('phase_c')) return 'phase-c';
      }
      return 'single-phase';
    }
    
    // 获取相位标签
    function getPhaseLabel(phase, workMode) {
      if (workMode === 'dc') {
        return '直流';
      } else if (workMode === 'three_phase') {
        if (phase.includes('_a')) return 'A相';
        if (phase.includes('_b')) return 'B相';
        if (phase.includes('_c')) return 'C相';
      }
      return '';
    }
    
    // 更新连接状态
    function updateConnectionStatus(status, text) {
      const statusElement = document.getElementById('connectionStatus');
      const indicatorElement = statusElement.querySelector('.status-indicator');
      
      statusElement.className = `connection-status ${status}`;
      indicatorElement.className = `status-indicator ${status}`;
      statusElement.querySelector('span').textContent = text;
    }
    
    // 更新监控状态
    function updateMonitoringStatus(monitoring) {
      isMonitoring = monitoring;
      const realtimeIndicator = document.getElementById('realtimeIndicator');
      const startBtn = document.getElementById('startMonitorBtn');
      const stopBtn = document.getElementById('stopMonitorBtn');
      
      if (monitoring) {
        realtimeIndicator.style.display = 'flex';
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        
        if (!oscilloscopeMode && realtimeUpdateInterval) {
          clearInterval(realtimeUpdateInterval);
        }
        
        if (!oscilloscopeMode) {
          realtimeUpdateInterval = setInterval(() => {
            if (isMonitoring && currentAnalysisMode === 'monitoring') {
              updateRealtimeChart();
            }
          }, 2000);
        }
      } else {
        realtimeIndicator.style.display = 'none';
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        
        if (realtimeUpdateInterval) {
          clearInterval(realtimeUpdateInterval);
          realtimeUpdateInterval = null;
        }
      }
    }
    
    // 加载数据源客户端列表
    async function loadDataSourceClients() {
      try {
        const response = await fetch('/api/data_source_clients');
        const data = await response.json();
        
        if (data.status === 'success') {
          updateClientList(data.clients);
        } else {
          showError('获取客户端列表失败: ' + data.message);
        }
      } catch (error) {
        console.error('Failed to load clients:', error);
        showError('网络错误，无法获取客户端列表');
      }
    }
    
    // 显示成功消息
    function showSuccess(message) {
      showMessage(message, 'success');
    }
    
    // 显示错误消息
    function showError(message) {
      showMessage(message, 'error');
    }
    
    // 显示警告消息
    function showWarning(message) {
      showMessage(message, 'warning');
    }
    
    // 显示消息
    function showMessage(message, type = 'info') {
      const messageArea = document.getElementById('messageArea');
      const messageClass = {
        'success': 'success-message',
        'error': 'error-message',
        'warning': 'warning-message',
        'info': 'info-message'
      }[type] || 'info-message';
      
      const messageDiv = document.createElement('div');
      messageDiv.className = messageClass;
      messageDiv.innerHTML = `
        <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 
                          type === 'success' ? 'check-circle' :
                          type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.remove()"></button>
      `;
      
      const existingMessages = messageArea.children;
      if (existingMessages.length > 2) {
        existingMessages[0].remove();
      }
      
      messageArea.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentElement) {
          messageDiv.remove();
        }
      }, 5000);
    }
    
    // 初始化显示
    updateSpeedText();
    updateOscilloscopeInfo();
  </script>
</body>
</html>