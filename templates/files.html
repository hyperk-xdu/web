{% extends "base.html" %}

{% block title %}文件管理 - 数据分析平台{% endblock %}

{% block page_icon %}<i class="fas fa-folder"></i>{% endblock %}
{% block page_title %}文件管理{% endblock %}

{% block extra_css %}
<style>
    .file-upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        background: #fafafa;
    }
    
    .file-upload-area:hover {
        border-color: var(--primary-color);
        background: #f0f8ff;
    }
    
    .file-upload-area.dragover {
        border-color: var(--success-color);
        background: #f0fff0;
    }
    
    .file-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s ease;
    }
    
    .file-item:hover {
        background: #f8f9fa;
    }
    
    .file-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        margin-right: 15px;
        font-size: 1.2rem;
    }
    
    .file-icon.csv {
        background: #e8f5e8;
        color: #27ae60;
    }
    
    .file-icon.xlsx {
        background: #e8f4f8;
        color: #17a2b8;
    }
    
    .file-icon.json {
        background: #fff3e0;
        color: #ff9800;
    }
    
    .file-icon.txt {
        background: #f3e5f5;
        color: #9c27b0;
    }
    
    .file-icon.default {
        background: #f5f5f5;
        color: #666;
    }
    
    .file-info {
        flex: 1;
    }
    
    .file-name {
        font-weight: 500;
        margin-bottom: 5px;
        color: var(--secondary-color);
    }
    
    .file-meta {
        font-size: 0.85rem;
        color: #666;
    }
    
    .file-actions {
        display: flex;
        gap: 5px;
    }
    
    .progress-container {
        margin-top: 15px;
        display: none;
    }
    
    .storage-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .file-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 5px 15px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .filter-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<!-- 存储统计 -->
<div class="storage-stats">
    <h4><i class="fas fa-hdd me-2"></i>存储概览</h4>
    <div class="stats-grid">
        <div class="stat-item">
            <span class="stat-value" id="totalFiles">0</span>
            <span class="stat-label">总文件数</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="totalSize">0 MB</span>
            <span class="stat-label">总大小</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="csvFiles">0</span>
            <span class="stat-label">CSV 文件</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="otherFiles">0</span>
            <span class="stat-label">其他文件</span>
        </div>
    </div>
</div>

<!-- 文件上传区域 -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-cloud-upload-alt me-2"></i>文件上传</h5>
    </div>
    <div class="card-body">
        <div class="file-upload-area" id="uploadArea">
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <h5>拖拽文件到此处或点击选择文件</h5>
            <p class="text-muted">支持 CSV, Excel, JSON, TXT 等格式</p>
            <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls,.json,.txt" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-folder-open me-2"></i>选择文件
            </button>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress">
                <div class="progress-bar" id="uploadProgress" role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted mt-2" id="uploadStatus">准备上传...</small>
        </div>
    </div>
</div>

<!-- 文件管理 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="fas fa-list me-2"></i>文件列表</h5>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="refreshFileList()">
                <i class="fas fa-sync-alt me-1"></i>刷新
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="clearAllFiles()">
                <i class="fas fa-trash me-1"></i>清空
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- 文件类型过滤器 -->
        <div class="file-filters">
            <div class="filter-btn active" data-type="all">全部</div>
            <div class="filter-btn" data-type="csv">CSV</div>
            <div class="filter-btn" data-type="xlsx">Excel</div>
            <div class="filter-btn" data-type="json">JSON</div>
            <div class="filter-btn" data-type="txt">文本</div>
        </div>
        
        <!-- 搜索框 -->
        <div class="mb-3">
            <input type="text" class="form-control" id="fileSearch" placeholder="搜索文件名...">
        </div>
        
        <!-- 文件列表 -->
        <div class="file-list" id="fileList">
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>暂无文件，请上传文件开始管理</p>
            </div>
        </div>
    </div>
</div>

<!-- 文件预览模态框 -->
<div class="modal fade" id="filePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewTitle">文件预览</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- 动态加载预览内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="downloadBtn">下载文件</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let fileList = [];
let currentFilter = 'all';

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    setupFileUpload();
    setupFileFilters();
    setupFileSearch();
    refreshFileList();
    loadStorageStats();
});

// 设置文件上传
function setupFileUpload() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    // 拖拽事件
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        uploadFiles(files);
    });
    
    // 点击选择文件
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        uploadFiles(files);
    });
}

// 上传文件
async function uploadFiles(files) {
    if (files.length === 0) return;
    
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('uploadProgress');
    const uploadStatus = document.getElementById('uploadStatus');
    
    progressContainer.style.display = 'block';
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('filename', file.name);
        
        try {
            uploadStatus.textContent = `上传 ${file.name} (${i + 1}/${files.length})`;
            progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
            
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showAlert(`文件 ${file.name} 上传成功`, 'success');
            } else {
                showAlert(`文件 ${file.name} 上传失败`, 'danger');
            }
        } catch (error) {
            showAlert(`文件 ${file.name} 上传异常: ${error.message}`, 'danger');
        }
    }
    
    uploadStatus.textContent = '上传完成';
    setTimeout(() => {
        progressContainer.style.display = 'none';
        progressBar.style.width = '0%';
        refreshFileList();
        loadStorageStats();
    }, 1000);
}

// 刷新文件列表
async function refreshFileList() {
    try {
        // 模拟获取文件列表
        fileList = [
            {
                name: 'data_2024.csv',
                size: '2.5 MB',
                type: 'csv',
                modified: '2024-01-15 10:30:00',
                path: '/uploaded_csv/data_2024.csv'
            },
            {
                name: 'analysis_report.xlsx',
                size: '1.2 MB',
                type: 'xlsx',
                modified: '2024-01-14 15:45:00',
                path: '/uploaded_csv/analysis_report.xlsx'
            },
            {
                name: 'config.json',
                size: '15 KB',
                type: 'json',
                modified: '2024-01-13 09:20:00',
                path: '/uploaded_csv/config.json'
            },
            {
                name: 'readme.txt',
                size: '3 KB',
                type: 'txt',
                modified: '2024-01-12 16:15:00',
                path: '/uploaded_csv/readme.txt'
            }
        ];
        
        renderFileList();
    } catch (error) {
        showAlert('获取文件列表失败: ' + error.message, 'danger');
    }
}

// 渲染文件列表
function renderFileList() {
    const fileListContainer = document.getElementById('fileList');
    
    let filteredFiles = fileList;
    
    // 应用类型过滤
    if (currentFilter !== 'all') {
        filteredFiles = fileList.filter(file => file.type === currentFilter);
    }
    
    // 应用搜索过滤
    const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
    if (searchTerm) {
        filteredFiles = filteredFiles.filter(file => 
            file.name.toLowerCase().includes(searchTerm)
        );
    }
    
    if (filteredFiles.length === 0) {
        fileListContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-search fa-3x mb-3"></i>
                <p>没有找到匹配的文件</p>
            </div>
        `;
        return;
    }
    
    fileListContainer.innerHTML = filteredFiles.map(file => `
        <div class="file-item">
            <div class="file-icon ${file.type}">
                <i class="fas fa-file-${getFileIcon(file.type)}"></i>
            </div>
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-meta">
                    ${file.size} • 修改于 ${file.modified}
                </div>
            </div>
            <div class="file-actions">
                <button class="btn btn-outline-primary btn-sm" onclick="previewFile('${file.name}', '${file.type}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="downloadFile('${file.path}', '${file.name}')">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('${file.name}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// 获取文件图标
function getFileIcon(type) {
    const icons = {
        'csv': 'csv',
        'xlsx': 'excel',
        'json': 'code',
        'txt': 'alt',
        'default': 'alt'
    };
    return icons[type] || icons.default;
}

// 设置文件类型过滤器
function setupFileFilters() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // 移除其他按钮的活跃状态
            filterBtns.forEach(b => b.classList.remove('active'));
            // 添加当前按钮的活跃状态
            btn.classList.add('active');
            
            currentFilter = btn.dataset.type;
            renderFileList();
        });
    });
}

// 设置文件搜索
function setupFileSearch() {
    const searchInput = document.getElementById('fileSearch');
    
    searchInput.addEventListener('input', () => {
        renderFileList();
    });
}

// 预览文件
function previewFile(fileName, fileType) {
    const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
    document.getElementById('previewTitle').textContent = `预览: ${fileName}`;
    
    const previewContent = document.getElementById('previewContent');
    
    // 根据文件类型生成预览内容
    switch (fileType) {
        case 'csv':
            previewContent.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>列1</th>
                                <th>列2</th>
                                <th>列3</th>
                                <th>列4</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>数据1</td><td>数据2</td><td>数据3</td><td>数据4</td></tr>
                            <tr><td>数据5</td><td>数据6</td><td>数据7</td><td>数据8</td></tr>
                            <tr><td>数据9</td><td>数据10</td><td>数据11</td><td>数据12</td></tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-muted">显示前3行数据</p>
            `;
            break;
        case 'json':
            previewContent.innerHTML = `
                <pre class="bg-light p-3 rounded"><code>{
  "name": "示例配置",
  "version": "1.0.0",
  "settings": {
    "debug": true,
    "timeout": 30
  }
}</code></pre>
            `;
            break;
        case 'txt':
            previewContent.innerHTML = `
                <div class="bg-light p-3 rounded">
                    <p>这是一个示例文本文件的内容...</p>
                    <p>包含多行文本数据。</p>
                </div>
            `;
            break;
        default:
            previewContent.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-file fa-3x mb-3"></i>
                    <p>该文件类型暂不支持预览</p>
                </div>
            `;
    }
    
    modal.show();
}

// 下载文件
function downloadFile(path, fileName) {
    // 创建临时链接下载
    const link = document.createElement('a');
    link.href = `/api/download/${fileName}`;
    link.download = fileName;
    link.click();
    
    showAlert(`开始下载: ${fileName}`, 'info');
}

// 删除文件
function deleteFile(fileName) {
    if (confirm(`确定要删除文件 ${fileName} 吗？`)) {
        // 从列表中移除
        fileList = fileList.filter(file => file.name !== fileName);
        renderFileList();
        loadStorageStats();
        showAlert(`文件 ${fileName} 已删除`, 'success');
    }
}

// 清空所有文件
function clearAllFiles() {
    if (confirm('确定要清空所有文件吗？此操作不可恢复！')) {
        fileList = [];
        renderFileList();
        loadStorageStats();
        showAlert('所有文件已清空', 'success');
    }
}

// 加载存储统计
function loadStorageStats() {
    const totalFiles = fileList.length;
    const csvFiles = fileList.filter(f => f.type === 'csv').length;
    const otherFiles = totalFiles - csvFiles;
    
    // 计算总大小（模拟）
    let totalSizeMB = 0;
    fileList.forEach(file => {
        const sizeStr = file.size;
        const size = parseFloat(sizeStr);
        if (sizeStr.includes('MB')) {
            totalSizeMB += size;
        } else if (sizeStr.includes('KB')) {
            totalSizeMB += size / 1024;
        }
    });
    
    document.getElementById('totalFiles').textContent = totalFiles;
    document.getElementById('totalSize').textContent = totalSizeMB.toFixed(1) + ' MB';
    document.getElementById('csvFiles').textContent = csvFiles;
    document.getElementById('otherFiles').textContent = otherFiles;
}
</script>
{% endblock %}